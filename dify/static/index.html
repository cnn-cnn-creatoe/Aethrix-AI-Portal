<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Dify å·¥ä½œæµåº“ | 380+ ç²¾é€‰ AI å·¥ä½œæµæ¨¡æ¿</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      /* Aurora UI + AI Platform é…è‰² */
      --primary: #7C3AED;
      --primary-light: #A78BFA;
      --primary-dark: #5B21B6;
      --accent: #06B6D4;
      --accent-light: #22D3EE;
      --success: #10B981;
      --warning: #F59E0B;
      --error: #EF4444;
      /* æµ…è‰²æ¨¡å¼ */
      --bg: #FAF5FF;
      --bg-secondary: #F3E8FF;
      --bg-tertiary: #EDE9FE;
      --bg-card: #FFFFFF;
      --text: #1E1B4B;
      --text-secondary: #4C1D95;
      --text-muted: #7C3AED;
      --border: #DDD6FE;
      --border-light: #EDE9FE;
      /* æ•ˆæœ */
      --shadow-sm: 0 1px 2px 0 rgb(124 58 237 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(124 58 237 / 0.1), 0 2px 4px -2px rgb(124 58 237 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(124 58 237 / 0.1), 0 4px 6px -4px rgb(124 58 237 / 0.1);
      --shadow-glow: 0 0 20px rgb(124 58 237 / 0.3);
      --radius: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.5rem;
      --transition: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      /* Aurora æ¸å˜ */
      --aurora-1: linear-gradient(135deg, #7C3AED 0%, #06B6D4 50%, #A78BFA 100%);
      --aurora-2: linear-gradient(45deg, #A78BFA 0%, #06B6D4 50%, #7C3AED 100%);
      --glass: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(124, 58, 237, 0.2);
    }
    [data-theme="dark"] {
      --bg: #0F0B1A;
      --bg-secondary: #1A1425;
      --bg-tertiary: #251D35;
      --bg-card: #1A1425;
      --text: #F5F3FF;
      --text-secondary: #C4B5FD;
      --text-muted: #A78BFA;
      --border: #3B2D5A;
      --border-light: #251D35;
      --glass: rgba(26, 20, 37, 0.8);
      --glass-border: rgba(167, 139, 250, 0.2);
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }
    /* Aurora èƒŒæ™¯åŠ¨ç”» */
    .aurora-bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 100vh;
      background: var(--bg);
      overflow: hidden;
      z-index: -1;
    }
    .aurora-bg::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(ellipse at 30% 20%, rgba(124, 58, 237, 0.15) 0%, transparent 50%),
                  radial-gradient(ellipse at 70% 60%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                  radial-gradient(ellipse at 50% 80%, rgba(167, 139, 250, 0.1) 0%, transparent 50%);
      animation: aurora 20s ease-in-out infinite;
    }
    @keyframes aurora {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(2%, 2%) rotate(1deg); }
      50% { transform: translate(-1%, 3%) rotate(-1deg); }
      75% { transform: translate(1%, -2%) rotate(0.5deg); }
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; }
    /* Header */
    .header {
      position: relative;
      padding: 4rem 0 3rem;
      text-align: center;
      background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg) 100%);
    }
    .logo-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--aurora-1);
      color: white;
      padding: 0.5rem 1.25rem;
      border-radius: 2rem;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-glow);
    }
    .logo-badge svg { width: 20px; height: 20px; }
    .title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: clamp(2.5rem, 5vw, 3.5rem);
      font-weight: 700;
      margin-bottom: 1rem;
      background: var(--aurora-1);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1.2;
    }
    .subtitle {
      font-size: 1.25rem;
      color: var(--text-secondary);
      margin-bottom: 2.5rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    /* Stats */
    .stats {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .stat {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.25rem 2rem;
      text-align: center;
      min-width: 140px;
      transition: all var(--transition);
    }
    .stat:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .stat-number {
      display: block;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2rem;
      font-weight: 700;
      background: var(--aurora-1);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .stat-label {
      font-size: 0.8125rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    /* Controls */
    .controls {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--glass-border);
      padding: 1.5rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .search-section {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .search-wrapper {
      flex: 1;
      position: relative;
    }
    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 1.25rem;
    }
    .search-input {
      width: 100%;
      padding: 1rem 1rem 1rem 3rem;
      border: 2px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      color: var(--text);
      font-size: 1rem;
      transition: all var(--transition);
    }
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }
    .search-input::placeholder { color: var(--text-muted); }
    /* Category Pills */
    .category-pills {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .category-pill {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 2rem;
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all var(--transition);
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }
    .category-pill:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    .category-pill.active {
      background: var(--aurora-1);
      color: white;
      border-color: transparent;
    }
    .category-pill .count {
      background: rgba(255,255,255,0.2);
      padding: 0.125rem 0.5rem;
      border-radius: 1rem;
      font-size: 0.75rem;
    }
    .category-pill:not(.active) .count {
      background: var(--bg-tertiary);
    }
    /* Theme Toggle */
    .theme-toggle {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 0.625rem 1rem;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text);
      transition: all var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .theme-toggle:hover {
      border-color: var(--primary);
    }
    .results-info {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    /* Main Content */
    .main {
      padding: 2rem 0 4rem;
      min-height: 60vh;
    }
    /* States */
    .state {
      text-align: center;
      padding: 4rem 2rem;
    }
    .state .icon {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      display: block;
    }
    .state h3 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.5rem;
      margin-bottom: 0.75rem;
    }
    .state p {
      color: var(--text-secondary);
      margin-bottom: 2rem;
    }
    .retry-btn {
      background: var(--aurora-1);
      color: white;
      border: none;
      padding: 0.875rem 2rem;
      border-radius: var(--radius-lg);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all var(--transition);
    }
    .retry-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-glow);
    }
    /* Workflow Grid */
    .workflow-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 1.5rem;
    }
    /* Workflow Card */
    .workflow-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      cursor: pointer;
      transition: all var(--transition);
      position: relative;
      overflow: hidden;
    }
    .workflow-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--aurora-1);
      opacity: 0;
      transition: opacity var(--transition);
    }
    .workflow-card:hover {
      border-color: var(--primary-light);
      box-shadow: var(--shadow-lg);
      transform: translateY(-4px);
    }
    .workflow-card:hover::before {
      opacity: 1;
    }
    .workflow-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1rem;
      gap: 1rem;
    }
    .workflow-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .category-badge {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--primary);
      background: var(--bg-tertiary);
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
    }
    .node-badge {
      font-size: 0.75rem;
      color: var(--text-muted);
      background: var(--bg-secondary);
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .workflow-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text);
      line-height: 1.4;
    }
    .workflow-description {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .workflow-integrations {
      border-top: 1px solid var(--border-light);
      padding-top: 1rem;
    }
    .integrations-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .integrations-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
    }
    .integration-tag {
      font-size: 0.6875rem;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
    }
    .integration-tag.model-tag {
      background: rgba(124, 58, 237, 0.1);
      color: var(--primary);
    }
    .workflow-icon {
      font-size: 1.5rem;
    }
    .llm-badge {
      background: rgba(124, 58, 237, 0.1);
      color: var(--primary);
    }
    /* æ¨¡å¼ç±»å‹æ ·å¼ */
    .mode-agent {
      background: rgba(167, 139, 250, 0.15);
      color: var(--primary);
      font-weight: 600;
    }
    .mode-completion {
      background: rgba(6, 182, 212, 0.15);
      color: var(--accent);
      font-weight: 600;
    }
    .mode-chatflow {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
      font-weight: 600;
    }
    .mode-workflow {
      background: var(--bg-secondary);
      color: var(--text-muted);
    }
    /* Load More */
    .load-more {
      text-align: center;
      padding: 2rem 0;
    }
    .load-more-btn {
      background: var(--bg-card);
      border: 2px solid var(--primary);
      color: var(--primary);
      padding: 0.875rem 2.5rem;
      border-radius: var(--radius-lg);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all var(--transition);
    }
    .load-more-btn:hover {
      background: var(--primary);
      color: white;
    }
    .hidden { display: none !important; }
    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 11, 26, 0.8);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg-secondary);
    }
    .modal-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.25rem;
      font-weight: 600;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.5rem;
      line-height: 1;
      transition: color var(--transition);
    }
    .modal-close:hover { color: var(--error); }
    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
    }
    .detail-section {
      margin-bottom: 1.5rem;
    }
    .detail-section h4 {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
    }
    .detail-section p {
      color: var(--text-secondary);
      line-height: 1.7;
    }
    .detail-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
    }
    .detail-stat {
      background: var(--bg-secondary);
      padding: 1rem;
      border-radius: var(--radius);
      text-align: center;
    }
    .detail-stat strong {
      display: block;
      font-size: 1.25rem;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }
    .detail-stat span {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .workflow-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      text-decoration: none;
      transition: all var(--transition);
    }
    .action-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    .action-btn.primary {
      background: var(--aurora-1);
      color: white;
      border-color: transparent;
    }
    .action-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-glow);
    }
    .yaml-viewer {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      overflow-x: auto;
      max-height: 300px;
      white-space: pre-wrap;
      color: var(--text-secondary);
    }
    /* Responsive */
    @media (max-width: 768px) {
      .workflow-grid {
        grid-template-columns: 1fr;
      }
      .stats {
        gap: 0.75rem;
      }
      .stat {
        padding: 1rem 1.25rem;
        min-width: 100px;
      }
      .category-pills {
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 0.5rem;
      }
    }
  </style>
</head>
<body>
<div class="aurora-bg"></div>
<div id="app">
  <header class="header">
    <div class="container">
      <div class="logo-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <span>Dify å·¥ä½œæµåº“</span>
      </div>
      <h1 class="title">380+ ç²¾é€‰ AI å·¥ä½œæµæ¨¡æ¿</h1>
      <p class="subtitle">æ¢ç´¢ã€ä¸‹è½½ã€å¯¼å…¥ï¼Œå¿«é€Ÿæ„å»ºä½ çš„ AI åº”ç”¨</p>
      <div class="stats">
        <div class="stat">
          <span class="stat-number" id="totalCount">0</span>
          <span class="stat-label">å·¥ä½œæµæ€»æ•°</span>
        </div>
        <div class="stat">
          <span class="stat-number" id="nodeCount">0</span>
          <span class="stat-label">èŠ‚ç‚¹æ€»æ•°</span>
        </div>
        <div class="stat">
          <span class="stat-number" id="llmCount">0</span>
          <span class="stat-label">LLM èŠ‚ç‚¹</span>
        </div>
        <div class="stat">
          <span class="stat-number" id="categoryCount">0</span>
          <span class="stat-label">åˆ†ç±»æ•°é‡</span>
        </div>
      </div>
    </div>
  </header>

  <div class="controls">
    <div class="container">
      <div class="search-section">
        <div class="search-wrapper">
          <span class="search-icon">ğŸ”</span>
          <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢å·¥ä½œæµåç§°ã€æè¿°...">
        </div>
        <button id="themeToggle" class="theme-toggle">
          <span id="themeIcon">ğŸŒ™</span>
          <span id="themeText">æ·±è‰²</span>
        </button>
      </div>
      <div class="category-pills" id="categoryPills">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div class="results-info">
        <span id="resultsCount">åŠ è½½ä¸­...</span>
      </div>
    </div>
  </div>

  <main class="main">
    <div class="container">
      <div id="loadingState" class="state">
        <span class="icon">âš¡</span>
        <h3>æ­£åœ¨åŠ è½½å·¥ä½œæµ...</h3>
        <p>è¯·ç¨å€™ï¼Œæ­£åœ¨æ‰«æ Dify å·¥ä½œæµæ–‡ä»¶</p>
      </div>
      <div id="errorState" class="state hidden">
        <span class="icon">âŒ</span>
        <h3>åŠ è½½å¤±è´¥</h3>
        <p id="errorMessage">å‡ºäº†ç‚¹é—®é¢˜</p>
        <button id="retryBtn" class="retry-btn">é‡æ–°åŠ è½½</button>
      </div>
      <div id="noResultsState" class="state hidden">
        <span class="icon">ğŸ”</span>
        <h3>æœªæ‰¾åˆ°å·¥ä½œæµ</h3>
        <p>è¯•è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–é€‰æ‹©å…¶ä»–åˆ†ç±»</p>
      </div>
      <div id="workflowGrid" class="workflow-grid hidden"></div>
      <div id="loadMoreContainer" class="load-more hidden">
        <button id="loadMoreBtn" class="load-more-btn">åŠ è½½æ›´å¤š</button>
      </div>
    </div>
  </main>
</div>

<!-- Modal -->
<div id="workflowModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">å·¥ä½œæµè¯¦æƒ…</h2>
      <button class="modal-close" id="modalClose">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="detail-section">
        <h4>æè¿°</h4>
        <p id="modalDescription">åŠ è½½ä¸­...</p>
      </div>
      <div class="detail-section">
        <h4>ç»Ÿè®¡ä¿¡æ¯</h4>
        <div class="detail-stats" id="modalStats"></div>
      </div>
      <div class="detail-section">
        <h4>é›†æˆæœåŠ¡</h4>
        <div class="integrations-list" id="modalIntegrations"></div>
      </div>
      <div class="detail-section">
        <h4>æ“ä½œ</h4>
        <div class="workflow-actions">
          <a id="downloadBtn" class="action-btn primary" href="#" download>ğŸ“¥ ä¸‹è½½ YML</a>
          <button id="viewYamlBtn" class="action-btn">ğŸ“„ æŸ¥çœ‹å†…å®¹</button>
          <button id="copyBtn" class="action-btn">ğŸ“‹ å¤åˆ¶</button>
        </div>
      </div>
      <div class="detail-section hidden" id="yamlSection">
        <h4>YAML å†…å®¹</h4>
        <pre class="yaml-viewer" id="yamlViewer"></pre>
      </div>
    </div>
  </div>
</div>

<script>

// åˆ†ç±»ä¸­æ–‡æ˜ å°„
const CATEGORY_NAMES = {
  'all': 'å…¨éƒ¨',
  'translation': 'ç¿»è¯‘&è¯­è¨€',
  'content': 'å†…å®¹åˆ›ä½œ',
  'ai-art': 'AI ç»˜ç”»',
  'data-analysis': 'æ•°æ®åˆ†æ',
  'document': 'æ–‡æ¡£å¤„ç†',
  'chatbot': 'èŠå¤©æœºå™¨äºº',
  'code': 'ä»£ç å¼€å‘',
  'research': 'æœç´¢&ç ”ç©¶',
  'agent': 'Agent&å·¥å…·',
  'education': 'æ•™è‚²å­¦ä¹ ',
  'media': 'åª’ä½“&è§†é¢‘',
  'utility': 'å®ç”¨å·¥å…·'
};

class DifyWorkflowApp {
  constructor() {
    this.state = {
      workflows: [],
      currentPage: 1,
      totalPages: 1,
      totalCount: 0,
      perPage: 20,
      isLoading: false,
      searchQuery: '',
      selectedCategory: 'all',
      categories: [],
      categoryCounts: {}
    };
    this.elements = {};
    this.searchDebounceTimer = null;
    this.currentWorkflow = null;
    this.currentYamlContent = null;
  }

  init() {
    this.cacheElements();
    this.setupEventListeners();
    this.setupTheme();
    this.loadInitialData();
  }

  cacheElements() {
    const ids = [
      'searchInput', 'categoryPills', 'themeToggle', 'themeIcon', 'themeText',
      'resultsCount', 'workflowGrid', 'loadMoreContainer', 'loadMoreBtn',
      'loadingState', 'errorState', 'noResultsState', 'errorMessage', 'retryBtn',
      'totalCount', 'nodeCount', 'llmCount', 'categoryCount',
      'workflowModal', 'modalTitle', 'modalClose', 'modalDescription',
      'modalStats', 'modalIntegrations', 'downloadBtn', 'viewYamlBtn',
      'copyBtn', 'yamlSection', 'yamlViewer'
    ];
    ids.forEach(id => this.elements[id] = document.getElementById(id));
  }

  setupEventListeners() {
    this.elements.searchInput.addEventListener('input', e => {
      this.state.searchQuery = e.target.value;
      this.debounceSearch();
    });
    this.elements.loadMoreBtn.addEventListener('click', () => this.loadMoreWorkflows());
    this.elements.retryBtn.addEventListener('click', () => this.loadInitialData());
    this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());
    this.elements.modalClose.addEventListener('click', () => this.closeModal());
    this.elements.workflowModal.addEventListener('click', e => {
      if (e.target === this.elements.workflowModal) this.closeModal();
    });
    this.elements.viewYamlBtn.addEventListener('click', () => this.toggleYamlView());
    this.elements.copyBtn.addEventListener('click', () => this.copyYaml());
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') this.closeModal();
    });
  }

  setupTheme() {
    const theme = localStorage.getItem('dify-theme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);
    this.updateThemeUI(theme);
  }

  toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('dify-theme', next);
    this.updateThemeUI(next);
  }

  updateThemeUI(theme) {
    this.elements.themeIcon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    this.elements.themeText.textContent = theme === 'dark' ? 'æµ…è‰²' : 'æ·±è‰²';
  }

  debounceSearch() {
    clearTimeout(this.searchDebounceTimer);
    this.searchDebounceTimer = setTimeout(() => {
      this.state.currentPage = 1;
      this.loadWorkflows(true);
    }, 300);
  }

  async apiCall(endpoint) {
    const res = await fetch('/api' + endpoint);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return res.json();
  }

  async loadInitialData() {
    this.showState('loading');
    try {
      const [stats, categories, counts] = await Promise.all([
        this.apiCall('/stats'),
        this.apiCall('/categories'),
        this.apiCall('/category-counts')
      ]);
      
      this.elements.totalCount.textContent = stats.total.toLocaleString();
      this.elements.nodeCount.textContent = stats.total_nodes.toLocaleString();
      this.elements.llmCount.textContent = stats.total_llm.toLocaleString();
      this.elements.categoryCount.textContent = stats.categories.toLocaleString();
      
      this.state.categories = categories.categories;
      this.state.categoryCounts = counts.counts;
      this.renderCategoryPills();
      
      await this.loadWorkflows(true);
    } catch (e) {
      this.showError('åŠ è½½å¤±è´¥: ' + e.message);
    }
  }

  renderCategoryPills() {
    const container = this.elements.categoryPills;
    let html = `<button class="category-pill active" data-category="all">
      å…¨éƒ¨ <span class="count">${this.state.totalCount || Object.values(this.state.categoryCounts).reduce((a,b)=>a+b,0)}</span>
    </button>`;
    
    this.state.categories.forEach(cat => {
      const count = this.state.categoryCounts[cat.id] || 0;
      html += `<button class="category-pill" data-category="${cat.id}">
        ${cat.name} <span class="count">${count}</span>
      </button>`;
    });
    
    container.innerHTML = html;
    
    container.querySelectorAll('.category-pill').forEach(pill => {
      pill.addEventListener('click', () => {
        container.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        this.state.selectedCategory = pill.dataset.category;
        this.state.currentPage = 1;
        this.loadWorkflows(true);
      });
    });
  }

  async loadWorkflows(reset) {
    if (reset) {
      this.state.currentPage = 1;
      this.state.workflows = [];
    }
    this.state.isLoading = true;
    
    try {
      const params = new URLSearchParams({
        q: this.state.searchQuery,
        category: this.state.selectedCategory,
        page: this.state.currentPage,
        per_page: this.state.perPage
      });
      
      const res = await this.apiCall('/workflows?' + params);
      
      if (reset) {
        this.state.workflows = res.workflows;
        this.state.totalCount = res.total;
        this.state.totalPages = res.pages;
      } else {
        this.state.workflows.push(...res.workflows);
      }
      
      this.updateUI();
    } catch (e) {
      this.showError('åŠ è½½å¤±è´¥: ' + e.message);
    }
    
    this.state.isLoading = false;
  }

  async loadMoreWorkflows() {
    if (this.state.currentPage < this.state.totalPages) {
      this.state.currentPage++;
      await this.loadWorkflows(false);
    }
  }

  updateUI() {
    const catName = CATEGORY_NAMES[this.state.selectedCategory] || this.state.selectedCategory;
    let resultText = `å…± ${this.state.totalCount.toLocaleString()} ä¸ªå·¥ä½œæµ`;
    if (this.state.selectedCategory !== 'all') {
      resultText = `ã€Œ${catName}ã€åˆ†ç±»å…± ${this.state.totalCount.toLocaleString()} ä¸ªå·¥ä½œæµ`;
    }
    this.elements.resultsCount.textContent = resultText;
    
    this.renderWorkflows();
    
    this.elements.loadMoreContainer.classList.toggle('hidden', 
      this.state.currentPage >= this.state.totalPages || this.state.workflows.length === 0);
    
    this.showState(this.state.workflows.length === 0 ? 'no-results' : 'content');
  }

  renderWorkflows() {
    this.elements.workflowGrid.innerHTML = this.state.workflows.map(w => this.createCard(w)).join('');
    this.elements.workflowGrid.querySelectorAll('.workflow-card').forEach((card, i) => {
      card.addEventListener('click', () => this.openDetail(this.state.workflows[i]));
    });
  }

  createCard(w) {
    const catName = CATEGORY_NAMES[w.category] || w.category;
    let modeText = 'Workflow';
    let modeClass = 'mode-workflow';
    if (w.mode === 'agent-chat' || w.mode === 'advanced-chat') {
      modeText = 'Agent';
      modeClass = 'mode-agent';
    } else if (w.mode === 'completion') {
      modeText = 'Completion';
      modeClass = 'mode-completion';
    } else if (w.mode === 'chatflow') {
      modeText = 'Chatflow';
      modeClass = 'mode-chatflow';
    }
    
    const nodeTypes = (w.node_types || []).slice(0, 4).map(t => 
      `<span class="integration-tag">${this.esc(t)}</span>`
    ).join('');
    const models = (w.models_used || []).slice(0, 2).map(m => 
      `<span class="integration-tag model-tag">${this.esc(m)}</span>`
    ).join('');
    
    return `
      <div class="workflow-card">
        <div class="workflow-header">
          <div class="workflow-meta">
            <span class="category-badge">${this.esc(catName)}</span>
            <span class="node-badge ${modeClass}">${modeText}</span>
            ${w.llm_count > 0 ? `<span class="node-badge llm-badge">ğŸ¤– ${w.llm_count} LLM</span>` : ''}
          </div>
          <span class="workflow-icon">${w.icon || 'ğŸ¤–'}</span>
        </div>
        <h3 class="workflow-title">${this.esc(w.name)}</h3>
        <p class="workflow-description">${this.esc(w.description)}</p>
        ${(w.node_types && w.node_types.length > 0) || (w.models_used && w.models_used.length > 0) ? `
          <div class="workflow-integrations">
            <h4 class="integrations-title">èŠ‚ç‚¹ç»„æˆ</h4>
            <div class="integrations-list">${nodeTypes}${models}</div>
          </div>
        ` : ''}
      </div>
    `;
  }

  openDetail(w) {
    this.currentWorkflow = w;
    const catName = CATEGORY_NAMES[w.category] || w.category;
    
    // æ­£ç¡®æ˜¾ç¤ºæ¨¡å¼ç±»å‹
    let modeText = 'Workflow';
    if (w.mode === 'agent-chat' || w.mode === 'advanced-chat') {
      modeText = 'Agent';
    } else if (w.mode === 'completion') {
      modeText = 'Completion';
    } else if (w.mode === 'chatflow') {
      modeText = 'Chatflow';
    }
    
    this.elements.modalTitle.textContent = (w.icon || 'ğŸ¤–') + ' ' + w.name;
    this.elements.modalDescription.textContent = w.description || 'æš‚æ— æè¿°';
    
    this.elements.modalStats.innerHTML = `
      <div class="detail-stat">
        <strong>${w.node_count}</strong>
        <span>èŠ‚ç‚¹æ•°é‡</span>
      </div>
      <div class="detail-stat">
        <strong>${w.llm_count || 0}</strong>
        <span>LLM èŠ‚ç‚¹</span>
      </div>
      <div class="detail-stat">
        <strong>${w.code_count || 0}</strong>
        <span>ä»£ç èŠ‚ç‚¹</span>
      </div>
      <div class="detail-stat">
        <strong>${modeText}</strong>
        <span>ç±»å‹</span>
      </div>
      <div class="detail-stat">
        <strong>${catName}</strong>
        <span>åˆ†ç±»</span>
      </div>
      <div class="detail-stat">
        <strong>${w.edge_count || 0}</strong>
        <span>è¿æ¥æ•°</span>
      </div>
    `;
    
    // æ˜¾ç¤ºèŠ‚ç‚¹ç±»å‹å’Œæ¨¡å‹
    let integrationsHtml = '';
    if (w.node_types && w.node_types.length > 0) {
      integrationsHtml += '<div style="margin-bottom:0.5rem"><strong style="font-size:0.75rem;color:var(--text-muted)">èŠ‚ç‚¹ç±»å‹:</strong></div>';
      integrationsHtml += w.node_types.map(t => `<span class="integration-tag">${this.esc(t)}</span>`).join(' ');
    }
    if (w.models_used && w.models_used.length > 0) {
      integrationsHtml += '<div style="margin:0.75rem 0 0.5rem"><strong style="font-size:0.75rem;color:var(--text-muted)">ä½¿ç”¨æ¨¡å‹:</strong></div>';
      integrationsHtml += w.models_used.map(m => `<span class="integration-tag model-tag">${this.esc(m)}</span>`).join(' ');
    }
    this.elements.modalIntegrations.innerHTML = integrationsHtml || '<span style="color: var(--text-muted)">æš‚æ— </span>';
    
    this.elements.downloadBtn.href = '/api/workflows/' + encodeURIComponent(w.filename) + '/download';
    this.elements.downloadBtn.download = w.filename;
    
    this.elements.yamlSection.classList.add('hidden');
    this.currentYamlContent = null;
    
    this.elements.workflowModal.classList.remove('hidden');
  }

  closeModal() {
    this.elements.workflowModal.classList.add('hidden');
    this.currentWorkflow = null;
    this.currentYamlContent = null;
  }

  async toggleYamlView() {
    if (!this.currentWorkflow) return;
    
    if (!this.elements.yamlSection.classList.contains('hidden')) {
      this.elements.yamlSection.classList.add('hidden');
      return;
    }
    
    try {
      this.elements.yamlViewer.textContent = 'åŠ è½½ä¸­...';
      this.elements.yamlSection.classList.remove('hidden');
      
      const data = await this.apiCall('/workflows/' + encodeURIComponent(this.currentWorkflow.filename));
      this.currentYamlContent = JSON.stringify(data.raw_yaml, null, 2);
      this.elements.yamlViewer.textContent = this.currentYamlContent;
    } catch (e) {
      this.elements.yamlViewer.textContent = 'åŠ è½½å¤±è´¥';
    }
  }

  async copyYaml() {
    if (!this.currentYamlContent) {
      await this.toggleYamlView();
    }
    if (this.currentYamlContent) {
      try {
        await navigator.clipboard.writeText(this.currentYamlContent);
        this.elements.copyBtn.textContent = 'âœ… å·²å¤åˆ¶';
        setTimeout(() => {
          this.elements.copyBtn.textContent = 'ğŸ“‹ å¤åˆ¶';
        }, 2000);
      } catch (e) {}
    }
  }

  showState(s) {
    this.elements.loadingState.classList.add('hidden');
    this.elements.errorState.classList.add('hidden');
    this.elements.noResultsState.classList.add('hidden');
    this.elements.workflowGrid.classList.add('hidden');
    
    if (s === 'loading') this.elements.loadingState.classList.remove('hidden');
    else if (s === 'error') this.elements.errorState.classList.remove('hidden');
    else if (s === 'no-results') this.elements.noResultsState.classList.remove('hidden');
    else if (s === 'content') this.elements.workflowGrid.classList.remove('hidden');
  }

  showError(msg) {
    this.elements.errorMessage.textContent = msg;
    this.showState('error');
  }

  esc(t) {
    const d = document.createElement('div');
    d.textContent = t || '';
    return d.innerHTML;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const app = new DifyWorkflowApp();
  app.init();
});
</script>
</body>
</html>
