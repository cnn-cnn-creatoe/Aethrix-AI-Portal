<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Aethrix | 以太�?- AI 工具导航与自建生�?>
    <meta name="keywords" content="AI工具,AI导航,人工智能,工具集合,以太�?Aethrix">
    <title>Aethrix | 以太�?/title>

    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Aethrix">

    <!-- Main CSS -->
    <link rel="stylesheet" href="style.css?v=206">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Firebase Modules -->
    <script src="js/firebase/firebaseConfig.js"></script>
    <script src="js/firebase/authStateManager.js"></script>
    <script src="js/firebase/roleManager.js"></script>

    <!-- Early theme initialization to prevent flash -->
    <script>
        (function () {
            const savedTheme = localStorage.getItem('hero-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>

<body data-theme="dark">
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="sr-only skip-link">跳转到主要内�?/a>

    <!-- Live Region for Screen Reader Announcements -->
    <div id="aria-live-region" class="aria-live-region" aria-live="polite" aria-atomic="true"></div>

    <!-- Site Header -->
    <header class="site-header" role="banner">
        <nav class="main-navigation" role="navigation" aria-label="主导�?>
            <div class="nav-container">
                <div class="nav-brand">
                    <a href="/" class="brand-link" aria-label="返回首页">
                        <span class="brand-text">Aethrix | 以太�?/span>
                    </a>
                </div>

                <div class="nav-menu" id="nav-menu">
                    <ul class="nav-list" role="menubar">
                        <li class="nav-item" role="none">
                            <a href="#portfolio" class="nav-link" role="menuitem">作品�?/a>
                        </li>
                        <li class="nav-item" role="none">
                            <a href="#services" class="nav-link" role="menuitem">服务</a>
                        </li>
                        <li class="nav-item" role="none">
                            <a href="#about" class="nav-link" role="menuitem">关于</a>
                        </li>
                        <li class="nav-item" role="none">
                            <a href="#" class="nav-link nav-link--primary" role="menuitem"
                                onclick="checkLoginAndGo(event)">AI 工具</a>
                        </li>
                    </ul>
                </div>

                <!-- Announcement Marquee -->
                <div class="announcement-marquee" id="announcement-marquee">
                    <div class="marquee-content" id="marquee-content">
                        <span class="marquee-text">欢迎访问 Aethrix | 以太�?/span>
                    </div>
                </div>

                <!-- Auth Buttons / User Avatar -->
                <div class="nav-auth" id="nav-auth">
                    <!-- Pause Toggle Button -->
                    <button class="nav-control-btn" id="nav-pause-toggle" aria-label="暂停动画" title="暂停/播放动画"
                        type="button">
                        <svg class="nav-control-icon nav-control-icon--pause" viewBox="0 0 24 24" fill="currentColor"
                            aria-hidden="true">
                            <rect x="6" y="4" width="4" height="16" />
                            <rect x="14" y="4" width="4" height="16" />
                        </svg>
                        <svg class="nav-control-icon nav-control-icon--play" viewBox="0 0 24 24" fill="currentColor"
                            aria-hidden="true" style="display:none;">
                            <polygon points="5,3 19,12 5,21" />
                        </svg>
                    </button>
                    <!-- Admin Panel Button (仅管理员可见) -->
                    <button class="nav-control-btn" id="nav-admin-btn" aria-label="管理员后�? title="进入管理员后�? type="button"
                        style="visibility: hidden;" onclick="window.location.href='/admin.html'">
                        <svg class="nav-control-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" aria-hidden="true">
                            <path d="M12 2L2 7l10 5 10-5-10-5z" />
                            <path d="M2 17l10 5 10-5" />
                            <path d="M2 12l10 5 10-5" />
                        </svg>
                    </button>
                    <!-- Theme Toggle Button -->
                    <button class="nav-control-btn" id="nav-theme-toggle" aria-label="切换主题" title="切换白天/夜晚模式"
                        type="button">
                        <svg class="nav-control-icon nav-control-icon--sun" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <circle cx="12" cy="12" r="5" />
                            <line x1="12" y1="1" x2="12" y2="3" />
                            <line x1="12" y1="21" x2="12" y2="23" />
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                            <line x1="1" y1="12" x2="3" y2="12" />
                            <line x1="21" y1="12" x2="23" y2="12" />
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                        </svg>
                        <svg class="nav-control-icon nav-control-icon--moon" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                        </svg>
                    </button>
                    <a href="auth.html" class="btn btn--outline btn--sm" id="login-btn" style="display: none;">登录</a>
                    <a href="auth.html?tab=register" class="btn btn--primary btn--sm" id="register-btn"
                        style="display: none;">注册</a>
                    <div class="user-avatar" id="user-avatar" style="display: none;" onclick="toggleProfilePopup()">
                        <span class="avatar-text" id="avatar-text"></span>
                    </div>
                </div>

                <button class="nav-toggle" id="nav-toggle" aria-label="切换导航菜单" aria-expanded="false"
                    aria-controls="nav-menu">
                    <span class="nav-toggle-line" aria-hidden="true"></span>
                    <span class="nav-toggle-line" aria-hidden="true"></span>
                    <span class="nav-toggle-line" aria-hidden="true"></span>
                </button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="site-main" id="main-content" role="main">
        <!-- Hero Section -->
        <section class="hero-section" id="hero" aria-labelledby="hero-title" data-theme="dark" role="region"
            aria-label="首页横幅">
            <!-- Particle Canvas Background -->
            <canvas id="hero-particles-canvas" class="hero-particles-canvas" aria-hidden="true"
                role="presentation"></canvas>

            <!-- Hero Content -->
            <div class="hero-content" id="hero-content">
                <h1 class="hero-title" id="hero-title" data-text="Aethrix | 以太�?>
                    <span class="hero-title-text">Aethrix | 以太�?/span>
                </h1>
                <p class="hero-subtitle" id="hero-subtitle" aria-describedby="hero-title">
                    <span class="hero-subtitle-text">以太夜漫漫，粒子生生不息</span>
                </p>
                <div class="hero-actions" id="hero-actions" role="group" aria-label="主要操作">
                    <a href="#portfolio" class="btn btn--primary hero-btn hero-btn--primary" id="hero-btn-portfolio"
                        role="button" aria-label="查看作品�?>查看作品</a>
                    <a href="#" class="btn btn--secondary hero-btn hero-btn--secondary" id="hero-btn-tools"
                        onclick="checkLoginAndGo(event)" role="button" aria-label="探索 AI 工具导航">探索 AI 工具</a>
                </div>

                <!-- Cute Robot Mascot moved to fixed position at bottom of body -->
            </div>
            <div class="scroll-indicator" aria-hidden="true" role="presentation">
                <div class="scroll-line"></div>
                <span class="scroll-text">向下滚动</span>
            </div>
        </section>

        <!-- Portfolio Section -->
        <section class="portfolio-section" id="portfolio" aria-labelledby="portfolio-title">
            <div class="container">
                <header class="section-header">
                    <h2 class="section-title" id="portfolio-title">精选作�?/h2>
                    <p class="section-subtitle">展示最新的创意项目和技术实�?/p>
                </header>

                <!-- Portfolio Filter -->
                <div class="portfolio-filter" role="tablist" aria-label="作品分类筛�?>
                    <button class="filter-btn filter-btn--active" data-filter="all" role="tab" aria-selected="true">
                        全部
                    </button>
                    <button class="filter-btn" data-filter="ai-tools" role="tab" aria-selected="false">
                        AI 工具
                    </button>
                    <button class="filter-btn" data-filter="web-design" role="tab" aria-selected="false">
                        网页设计
                    </button>
                    <button class="filter-btn" data-filter="branding" role="tab" aria-selected="false">
                        品牌设计
                    </button>
                </div>

                <!-- Portfolio Grid -->
                <div class="portfolio-grid" id="portfolio-grid" role="tabpanel" aria-label="作品列表">
                    <!-- Portfolio items will be loaded dynamically from settings.json -->
                    <p class="loading-text">加载�?..</p>
                </div>
            </div>
        </section>

        <!-- Services Section -->
        <section class="services-section" id="services" aria-labelledby="services-title">
            <div class="container">
                <header class="section-header">
                    <h2 class="section-title" id="services-title">专业服务</h2>
                    <p class="section-subtitle">提供全方位的数字化解决方�?/p>
                </header>

                <div class="services-grid">
                    <article class="service-card fade-in">
                        <div class="service-icon" aria-hidden="true">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <h3 class="service-title">AI 工具开�?/h3>
                        <p class="service-description">定制�?AI 工具开发，包括文本生成、图像处理、数据分析等功能模块</p>
                    </article>

                    <article class="service-card fade-in">
                        <div class="service-icon" aria-hidden="true">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
                                <line x1="8" y1="21" x2="16" y2="21" />
                                <line x1="12" y1="17" x2="12" y2="21" />
                            </svg>
                        </div>
                        <h3 class="service-title">网站设计开�?/h3>
                        <p class="service-description">现代化响应式网站设计与开发，注重性能优化和用户体�?/p>
                    </article>

                    <article class="service-card fade-in">
                        <div class="service-icon" aria-hidden="true">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <circle cx="12" cy="12" r="3" />
                                <path
                                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                            </svg>
                        </div>
                        <h3 class="service-title">系统集成</h3>
                        <p class="service-description">企业级系统集成服务，提供完整的数字化转型解决方案</p>
                    </article>

                    <article class="service-card fade-in">
                        <div class="service-icon" aria-hidden="true">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <path
                                    d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                            </svg>
                        </div>
                        <h3 class="service-title">品牌设计</h3>
                        <p class="service-description">专业的品牌视觉识别设计，打造独特的品牌形象和用户体�?/p>
                    </article>
                </div>
            </div>
        </section>

        <!-- About Section -->
        <section class="about-section" id="about" aria-labelledby="about-title">
            <div class="container">
                <div class="about-content">
                    <div class="about-text">
                        <header class="section-header">
                            <h2 class="section-title" id="about-title">关于我们</h2>
                            <p class="section-subtitle">专注创新与品质的设计团队</p>
                        </header>

                        <div class="about-description">
                            <p>我们是一支专注于现代化数字体验的创意团队，致力于将最新的 AI 技术与优秀的设计理念相结合，为客户提供创新的解决方案�?/p>

                            <p>从概念到实现，我们关注每一个细节，确保每个项目都能达到最高的品质标准。我们相信好的设计不仅要美观，更要实用和有意义�?/p>
                        </div>

                        <div class="about-stats">
                            <div class="stat-item">
                                <div class="stat-number">50+</div>
                                <div class="stat-label">完成项目</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">3�?/div>
                                <div class="stat-label">行业经验</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">100%</div>
                                <div class="stat-label">客户满意�?/div>
                            </div>
                        </div>
                    </div>

                    <div class="about-image">
                        <img id="about-section-image"
                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='400' viewBox='0 0 500 400'%3E%3Crect width='500' height='400' fill='%23f5f5f5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Inter, sans-serif' font-size='18' fill='%23666'%3E团队工作场景%3C/text%3E%3C/svg%3E"
                            alt="创意工作室团队工作场�? loading="lazy" width="500" height="400" style="object-fit: cover;">
                    </div>
                </div>
            </div>
        </section>

        <!-- Solopreneur Section - 一人公司工作流卡片列表 -->
        <section class="solopreneur-section" id="solopreneur" aria-labelledby="solopreneur-title">
            <div class="container">
                <header class="section-header">
                    <h2 class="section-title" id="solopreneur-title">一人公�?/h2>
                    <p class="section-subtitle" id="solo-description">加载�?..</p>
                </header>

                <!-- 工作流卡片列�?- 和admin.html一样的样式 -->
                <div class="workflow-cards-container">
                    <h3 class="workflow-cards-title">工作流列�?(<span id="workflows-count">0</span>)</h3>
                    <div id="workflows-grid" class="workflows-grid">
                        <p class="loading-text">加载�?..</p>
                    </div>
                </div>
            </div>

            <!-- 工作流查看器模态框 -->
            <div id="workflow-viewer-modal" class="workflow-viewer-modal">
                <div class="workflow-viewer-content">
                    <div class="workflow-viewer-header">
                        <h3 id="workflow-viewer-title" class="workflow-viewer-title"></h3>
                        <button class="workflow-viewer-close" onclick="closeWorkflowViewer()">×</button>
                    </div>
                    <div class="workflow-viewer-canvas-container">
                        <div id="workflow-viewer-canvas" class="workflow-viewer-canvas"></div>
                        <svg id="workflow-viewer-connections"
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3;"></svg>
                    </div>
                </div>
            </div>

            <!-- 节点详情模态框 -->
            <div id="node-detail-modal" class="node-detail-modal">
                <div class="node-detail-content">
                    <button class="node-detail-close" onclick="closeNodeDetail()">×</button>
                    <h3 id="node-detail-title" class="node-detail-title"></h3>
                    <p id="node-detail-desc" class="node-detail-desc"></p>
                    <div id="node-detail-text" class="node-detail-text"></div>
                    <a id="node-detail-link" class="node-detail-link" href="#" target="_blank"
                        style="display: none;">访问工具 �?/a>
                </div>
            </div>
        </section>
    </main>

    <!-- Bookmark Toast Modal -->
    <div class="bookmark-toast" id="bookmark-toast">
        <p class="bookmark-toast-text">请按 <kbd>Ctrl+D</kbd> 收藏本站，谢谢您的支持！</p>
    </div>

    <!-- Site Footer -->
    <footer class="site-footer" role="contentinfo">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <h3 class="footer-title" id="footer-site-name">Aethrix | 以太�?/h3>
                    <p class="footer-description" id="footer-slogan">以太夜漫漫，粒子生生不息</p>
                </div>

                <div class="footer-links">
                    <div class="footer-column">
                        <h4 class="footer-column-title">服务</h4>
                        <ul class="footer-list" id="footer-services-list">
                            <!-- 动态加载服务列�?-->
                        </ul>
                    </div>

                    <div class="footer-column">
                        <h4 class="footer-column-title">资源</h4>
                        <ul class="footer-list" id="footer-resources-list">
                            <!-- 动态加载资源列�?-->
                        </ul>
                    </div>

                    <div class="footer-column">
                        <h4 class="footer-column-title">联系</h4>
                        <ul class="footer-list" id="footer-contact-list">
                            <!-- 动态加载联系信�?-->
                        </ul>
                    </div>
                </div>
            </div>

            <div class="footer-bottom">
                <p class="footer-copyright" id="footer-copyright-text">
                    © 2025 Aethrix | 以太�? 保留所有权�?
                </p>
                <div class="footer-social">
                    <button class="social-link" aria-label="回到顶部"
                        onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" aria-hidden="true">
                            <path d="M12 19V5M5 12l7-7 7 7" />
                        </svg>
                    </button>
                    <button class="social-link bookmark-btn" aria-label="收藏本站" onclick="handleSiteBookmark()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z" />
                        </svg>
                        <span class="bookmark-count" id="site-bookmark-count">0</span>
                    </button>
                </div>
            </div>
        </div>
    </footer>

    <!-- Background Mode Switcher (Optional) -->
    <div class="bg-mode-switcher" id="bg-mode-switcher" style="display: none;">
        <button class="bg-mode-btn active" data-mode="energy" onclick="switchBgMode('energy')">能量�?/button>
        <button class="bg-mode-btn" data-mode="snow" onclick="switchBgMode('snow')">下雪</button>
        <button class="bg-mode-btn" data-mode="stars" onclick="switchBgMode('stars')">星空</button>
    </div>

    <script>
        // Background mode switcher
        function switchBgMode(mode) {
            if (window.setBackgroundMode) {
                window.setBackgroundMode(mode);
            }
            // Update active button
            document.querySelectorAll('.bg-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
        }

        // Toggle switcher visibility (press 'B' key)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'b' || e.key === 'B') {
                const switcher = document.getElementById('bg-mode-switcher');
                if (switcher) {
                    switcher.style.display = switcher.style.display === 'none' ? 'flex' : 'none';
                }
            }
        });
    </script>

    <!-- JavaScript -->
    <script src="main.js?v=206" defer></script>

    <!-- Ensure cursor effect is initialized -->
    <script>
        // Force cursor initialization after main.js loads
        window.addEventListener('load', function () {
            // Check if cursor already exists
            if (!document.querySelector('.cursor-dot')) {
                // Manually create cursor if not initialized
                if (typeof window.CustomCursorModule !== 'undefined') {
                    // Only initialize on desktop with fine pointer
                    if (!window.matchMedia('(max-width: 767px)').matches &&
                        !window.matchMedia('(pointer: coarse)').matches) {
                        new window.CustomCursorModule();
                    }
                }
            }
        });
    </script>

    <!-- User Profile Script -->
    <script>
        let userProfile = null;
        let isPasswordVisible = false;

        // Quick initial auth check using stored state (prevents flash)
        // 支持 Firebase 登录�?GitHub OAuth 直接登录两种方式
        (function quickAuthCheck() {
            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.getElementById('register-btn');
            const userAvatar = document.getElementById('user-avatar');
            const avatarText = document.getElementById('avatar-text');

            // Check localStorage for stored auth state (Firebase or GitHub OAuth)
            try {
                let authState = null;
                let authType = null;

                // 优先检�?Firebase 认证
                const storedAuth = localStorage.getItem('firebase_auth_state');
                if (storedAuth) {
                    authState = JSON.parse(storedAuth);
                    authType = 'firebase';
                }

                // 如果没有 Firebase 认证，检�?GitHub OAuth 认证
                if (!authState) {
                    const githubAuth = localStorage.getItem('github_auth_state');
                    if (githubAuth) {
                        authState = JSON.parse(githubAuth);
                        authType = 'github';
                    }
                }

                if (authState && authState.uid) {
                    // 检查是否过期（1小时�?                    const tokenAge = Date.now() - (authState.timestamp || 0);
                    if (tokenAge < 60 * 60 * 1000) {
                        // User was logged in - show avatar immediately
                        if (loginBtn) loginBtn.style.display = 'none';
                        if (registerBtn) registerBtn.style.display = 'none';
                        if (userAvatar) {
                            userAvatar.style.display = 'flex';
                            const displayText = authState.displayName
                                ? authState.displayName.charAt(0).toUpperCase()
                                : (authState.email ? authState.email.charAt(0).toUpperCase() : 'U');
                            if (avatarText) avatarText.textContent = displayText;
                        }

                        // Also populate userProfile from stored state for profile popup
                        userProfile = {
                            uid: authState.uid,
                            email: authState.email,
                            nickname: authState.displayName || (authState.email ? authState.email.split('@')[0] : 'User'),
                            displayName: authState.displayName,
                            photoURL: authState.photoURL,
                            emailVerified: authState.emailVerified,
                            isAdmin: false, // Will be updated by checkUserStatus
                            provider: authType
                        };

                        // 保存认证类型供后续使�?                        window._authType = authType;

                        return; // Don't show login buttons
                    }
                }
            } catch (e) {
                console.log('Quick auth check failed:', e);
            }

            // No stored auth - show login/register buttons
            if (loginBtn) loginBtn.style.display = 'inline-flex';
            if (registerBtn) registerBtn.style.display = 'inline-flex';
        })();

        // Check user login status and update UI
        async function checkUserStatus() {
            try {
                const loginBtn = document.getElementById('login-btn');
                const registerBtn = document.getElementById('register-btn');
                const userAvatar = document.getElementById('user-avatar');
                const avatarText = document.getElementById('avatar-text');

                // 首先检�?GitHub OAuth 登录状�?                let githubAuth = null;
                try {
                    const githubAuthStr = localStorage.getItem('github_auth_state');
                    if (githubAuthStr) {
                        githubAuth = JSON.parse(githubAuthStr);
                        const tokenAge = Date.now() - (githubAuth.timestamp || 0);
                        // 检查是否过期（1小时�?                        if (tokenAge >= 60 * 60 * 1000) {
                            localStorage.removeItem('github_auth_state');
                            githubAuth = null;
                        }
                    }
                } catch (e) {
                    console.log('解析 GitHub 认证状态失�?', e);
                    localStorage.removeItem('github_auth_state');
                }

                // 如果�?GitHub OAuth 登录，使用它
                if (githubAuth && githubAuth.uid) {
                    console.log('检测到 GitHub OAuth 登录:', githubAuth.email || githubAuth.displayName);

                    // 显示头像
                    if (loginBtn) loginBtn.style.display = 'none';
                    if (registerBtn) registerBtn.style.display = 'none';
                    if (userAvatar) {
                        userAvatar.style.display = 'flex';
                        const displayText = githubAuth.displayName
                            ? githubAuth.displayName.charAt(0).toUpperCase()
                            : (githubAuth.email ? githubAuth.email.charAt(0).toUpperCase() : 'U');
                        if (avatarText) avatarText.textContent = displayText;
                    }

                    // 设置用户资料
                    userProfile = {
                        uid: githubAuth.uid,
                        email: githubAuth.email,
                        nickname: githubAuth.displayName || (githubAuth.email ? githubAuth.email.split('@')[0] : 'User'),
                        displayName: githubAuth.displayName,
                        photoURL: githubAuth.photoURL,
                        emailVerified: true,
                        isAdmin: githubAuth.isAdmin || false,
                        provider: 'github'
                    };
                    updateProfilePopup();
                    return;
                }

                // 如果没有 GitHub OAuth 登录，检�?Firebase 登录
                window.FirebaseConfig.initializeFirebase();

                // Wait for auth state - 增加等待时间
                let user = await window.AuthStateManager.waitForAuthReady(5000);

                // 如果没有用户，再检查一次存储的状�?                if (!user && window.AuthStateManager.getStoredAuthState) {
                    const storedState = window.AuthStateManager.getStoredAuthState();
                    if (storedState && storedState.uid) {
                        console.log('从存储中恢复认证状�?..');
                        user = await window.AuthStateManager.waitForAuthReady(3000);
                    }
                }

                if (user) {
                    // User is logged in via Firebase - show avatar
                    console.log('检测到 Firebase 登录:', user.email);
                    if (loginBtn) loginBtn.style.display = 'none';
                    if (registerBtn) registerBtn.style.display = 'none';
                    if (userAvatar) {
                        userAvatar.style.display = 'flex';
                        // Use display name or email first letter
                        const displayText = user.displayName
                            ? user.displayName.charAt(0).toUpperCase()
                            : user.email.charAt(0).toUpperCase();
                        avatarText.textContent = displayText;
                    }
                    // Load full profile
                    loadUserProfile(user);
                } else {
                    // User not logged in - show login/register buttons
                    console.log('未检测到登录状�?);
                    if (loginBtn) loginBtn.style.display = 'inline-flex';
                    if (registerBtn) registerBtn.style.display = 'inline-flex';
                    if (userAvatar) userAvatar.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to check user status:', error);
                // On error, show login buttons
                const loginBtn = document.getElementById('login-btn');
                const registerBtn = document.getElementById('register-btn');
                if (loginBtn) loginBtn.style.display = 'inline-flex';
                if (registerBtn) registerBtn.style.display = 'inline-flex';
            }
        }

        // Load user profile data
        async function loadUserProfile(user) {
            try {
                // Create profile from Firebase user
                userProfile = {
                    uid: user.uid,
                    email: user.email,
                    nickname: user.displayName || user.email.split('@')[0],
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    emailVerified: user.emailVerified,
                    isAdmin: window.RoleManager.checkAdminStatus(user.email)
                };
                updateProfilePopup();
            } catch (error) {
                console.error('Failed to load user profile:', error);
            }
        }

        // Update profile popup with user data
        function updateProfilePopup() {
            if (!userProfile) return;

            const nicknameEl = document.getElementById('profile-nickname');
            const emailEl = document.getElementById('profile-email');

            if (nicknameEl) nicknameEl.textContent = userProfile.nickname || userProfile.displayName || '-';
            if (emailEl) emailEl.textContent = userProfile.email || '-';
        }

        // Show profile message (success or error)
        function showProfileMessage(message, type = 'success') {
            const msgEl = document.getElementById('profile-message');
            if (!msgEl) return;

            msgEl.textContent = message;
            msgEl.style.display = 'block';

            if (type === 'success') {
                msgEl.style.background = '#e8f5e9';
                msgEl.style.color = '#2e7d32';
                msgEl.style.border = '1px solid #a5d6a7';
            } else {
                msgEl.style.background = '#ffebee';
                msgEl.style.color = '#c62828';
                msgEl.style.border = '1px solid #ef9a9a';
            }

            // Auto hide after 3 seconds
            setTimeout(() => {
                msgEl.style.display = 'none';
            }, 3000);
        }

        // Toggle profile popup
        function toggleProfilePopup() {
            const popup = document.getElementById('profile-popup');
            if (popup.style.display === 'none') {
                popup.style.display = 'block';
            } else {
                popup.style.display = 'none';
            }
        }

        // Close profile popup
        function closeProfilePopup() {
            document.getElementById('profile-popup').style.display = 'none';
        }

        // Enter edit mode
        function enterEditMode() {
            document.getElementById('profile-view-mode').style.display = 'none';
            document.getElementById('profile-edit-mode').style.display = 'block';
            document.getElementById('profile-view-buttons').style.display = 'none';
            document.getElementById('profile-edit-buttons').style.display = 'block';

            // Pre-fill current values
            document.getElementById('edit-nickname').value = userProfile?.nickname || '';
            document.getElementById('edit-email').textContent = userProfile?.email || '-';
            document.getElementById('edit-error').textContent = '';
        }

        // Cancel edit mode
        function cancelEditMode() {
            document.getElementById('profile-view-mode').style.display = 'block';
            document.getElementById('profile-edit-mode').style.display = 'none';
            document.getElementById('profile-view-buttons').style.display = 'block';
            document.getElementById('profile-edit-buttons').style.display = 'none';
            document.getElementById('edit-error').textContent = '';
        }

        // Save profile changes
        async function saveProfileChanges() {
            const nickname = document.getElementById('edit-nickname').value.trim();
            const errorEl = document.getElementById('edit-error');

            // Validation
            if (!nickname || nickname.length < 2 || nickname.length > 20) {
                errorEl.textContent = '昵称长度需要在2-20个字符之�?;
                return;
            }

            try {
                const auth = window.FirebaseConfig?.getAuth();

                // 首先同步 Firebase 用户到后端（确保�?user_token cookie�?                if (auth?.currentUser) {
                    console.log('正在同步 Firebase 用户到后�?..');
                    try {
                        const idToken = await auth.currentUser.getIdToken();
                        const syncResponse = await fetch('/api/auth/firebase-sync', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${idToken}`
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                uid: auth.currentUser.uid,
                                email: auth.currentUser.email,
                                displayName: auth.currentUser.displayName,
                                photoURL: auth.currentUser.photoURL,
                                provider: auth.currentUser.providerData[0]?.providerId || 'password'
                            })
                        });

                        const syncResult = await syncResponse.json();
                        console.log('Firebase sync result:', syncResult);

                        if (!syncResponse.ok) {
                            console.error('Firebase sync failed:', syncResult);
                            errorEl.textContent = '同步用户信息失败，请重新登录后再�?;
                            return;
                        }
                    } catch (syncErr) {
                        console.error('同步到后端失�?', syncErr);
                        errorEl.textContent = '网络错误，请稍后重试';
                        return;
                    }
                }

                // 等待一小段时间确保 cookie 已设�?                await new Promise(resolve => setTimeout(resolve, 100));

                console.log('正在更新用户资料...');
                const response = await fetch('/api/user/update-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ nickname })
                });

                const result = await response.json();
                console.log('Update profile response:', result);

                if (result.success) {
                    // Update local profile
                    userProfile.nickname = nickname;
                    updateProfilePopup();

                    // Update Firebase displayName if available
                    if (auth?.currentUser) {
                        try {
                            await auth.currentUser.updateProfile({ displayName: nickname });
                            console.log('Firebase displayName 已更�?);
                        } catch (e) {
                            console.log('更新 Firebase displayName 失败:', e);
                        }
                    }

                    // Update avatar text
                    const avatarText = document.getElementById('avatar-text');
                    if (avatarText) {
                        avatarText.textContent = nickname.charAt(0).toUpperCase();
                    }

                    cancelEditMode();

                    // Show inline success message
                    showProfileMessage('信息更新成功�?, 'success');
                } else {
                    errorEl.textContent = result.message || '更新失败，请稍后重试';
                }
            } catch (error) {
                console.error('Update profile error:', error);
                errorEl.textContent = '更新失败，请稍后重试';
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                // 先清除本地存储状态（防止页面闪烁�?                // 同时清除 Firebase �?GitHub OAuth 的认证状�?                if (window.AuthStateManager && window.AuthStateManager.clearAuthState) {
                    window.AuthStateManager.clearAuthState();
                } else {
                    localStorage.removeItem('firebase_auth_state');
                }
                localStorage.removeItem('github_auth_state');

                // Logout from Firebase (如果�?Firebase 登录)
                const auth = window.FirebaseConfig.getAuth();
                if (auth && auth.currentUser) {
                    await auth.signOut();
                }

                // 清除后端 session
                try {
                    await fetch('/api/user/logout', { method: 'POST' });
                } catch (e) {
                    console.log('清除后端 session 失败:', e);
                }

                // Reload page
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
                // 确保清除本地状�?                localStorage.removeItem('firebase_auth_state');
                // Force reload anyway
                window.location.reload();
            }
        }

        // Close popup when clicking outside
        document.addEventListener('click', function (e) {
            const popup = document.getElementById('profile-popup');
            const avatar = document.getElementById('user-avatar');
            if (popup && popup.style.display === 'block' &&
                !popup.contains(e.target) && !avatar.contains(e.target)) {
                popup.style.display = 'none';
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', checkUserStatus);
    </script>

    <!-- Site Bookmark Script -->
    <script>
        // Bookmark state key in localStorage
        const BOOKMARK_KEY = 'site_bookmarked';

        // Check if user has bookmarked
        function hasBookmarked() {
            return localStorage.getItem(BOOKMARK_KEY) === 'true';
        }

        // Set bookmark state
        function setBookmarkState(bookmarked) {
            localStorage.setItem(BOOKMARK_KEY, bookmarked ? 'true' : 'false');
        }

        // Show bookmark toast with custom message
        function showBookmarkToast(isBookmarked) {
            const toast = document.getElementById('bookmark-toast');
            const textEl = toast.querySelector('.bookmark-toast-text');
            textEl.innerHTML = '请自行收藏网站，谢谢支持！！';
            toast.classList.add('show');
            // Auto close after 3 seconds
            setTimeout(() => closeBookmarkToast(), 3000);
        }

        // Close bookmark toast
        function closeBookmarkToast() {
            const toast = document.getElementById('bookmark-toast');
            toast.classList.remove('show');
        }

        // Update bookmark button UI
        function updateBookmarkUI(isBookmarked) {
            const bookmarkBtn = document.querySelector('.bookmark-btn');
            if (bookmarkBtn) {
                if (isBookmarked) {
                    bookmarkBtn.classList.add('active');
                    bookmarkBtn.setAttribute('aria-label', '取消收藏');
                } else {
                    bookmarkBtn.classList.remove('active');
                    bookmarkBtn.setAttribute('aria-label', '收藏本站');
                }
            }
        }

        // Handle site bookmark toggle
        async function handleSiteBookmark() {
            const isCurrentlyBookmarked = hasBookmarked();
            const newState = !isCurrentlyBookmarked;
            const action = newState ? 'add' : 'remove';

            console.log('Bookmark toggle:', { isCurrentlyBookmarked, newState, action });

            // 只在收藏时显示提示框（newState = true 表示收藏�?            if (newState) {
                showBookmarkToast(newState);
            }

            // Update local state immediately for responsive UI
            setBookmarkState(newState);
            updateBookmarkUI(newState);

            // Sync with server
            try {
                const response = await fetch('/api/site/bookmark', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                const data = await response.json();
                console.log('Server response:', data);
                const bookmarkCount = document.getElementById('site-bookmark-count');
                if (bookmarkCount && data.bookmarks !== undefined) {
                    bookmarkCount.textContent = data.bookmarks;
                }
                // Add animation
                const bookmarkBtn = document.querySelector('.bookmark-btn');
                if (bookmarkBtn) {
                    bookmarkBtn.classList.add('bookmarked');
                    setTimeout(() => bookmarkBtn.classList.remove('bookmarked'), 300);
                }
            } catch (error) {
                console.error('Failed to sync bookmark:', error);
                // Revert local state on error
                setBookmarkState(isCurrentlyBookmarked);
                updateBookmarkUI(isCurrentlyBookmarked);
            }
        }

        // Load bookmarks on page load
        async function loadSiteBookmarks() {
            try {
                const response = await fetch('/api/site/bookmarks');
                const data = await response.json();
                const bookmarkCount = document.getElementById('site-bookmark-count');
                if (bookmarkCount && data.bookmarks !== undefined) {
                    bookmarkCount.textContent = data.bookmarks;
                }
                // Update UI based on local bookmark state
                updateBookmarkUI(hasBookmarked());
            } catch (error) {
                console.error('Failed to load bookmarks:', error);
            }
        }
        document.addEventListener('DOMContentLoaded', loadSiteBookmarks);

        // Heartbeat for online tracking
        function sendHeartbeat() {
            fetch('/api/heartbeat', { method: 'POST', credentials: 'include' }).catch(() => { });
        }
        // Send heartbeat every 30 seconds
        setInterval(sendHeartbeat, 30000);
        // Send initial heartbeat
        document.addEventListener('DOMContentLoaded', sendHeartbeat);
    </script>

    <!-- Login Check Script -->
    <script>
        // Check login status and redirect to tools page or login page
        async function checkLoginAndGo(event) {
            event.preventDefault();

            try {
                // 首先检�?GitHub OAuth 登录状�?                let isLoggedIn = false;
                try {
                    const githubAuthStr = localStorage.getItem('github_auth_state');
                    if (githubAuthStr) {
                        const githubAuth = JSON.parse(githubAuthStr);
                        const tokenAge = Date.now() - (githubAuth.timestamp || 0);
                        // 检查是否过期（1小时�?                        if (githubAuth.uid && tokenAge < 60 * 60 * 1000) {
                            isLoggedIn = true;
                            console.log('检测到 GitHub OAuth 登录，跳转到工具�?);
                        }
                    }
                } catch (e) {
                    console.log('检�?GitHub 认证状态失�?', e);
                }

                // 如果 GitHub OAuth 已登录，直接跳转
                if (isLoggedIn) {
                    // Record click
                    fetch('/api/metrics/events', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'ai_tool_click' })
                    }).catch(err => console.log('Metrics error:', err));

                    window.location.href = '/tools.html';
                    return;
                }

                // 如果没有 GitHub OAuth 登录，检�?Firebase 登录
                // Initialize Firebase if not already done
                if (!window.FirebaseConfig) {
                    console.error('Firebase not loaded');
                    window.location.href = '/auth.html?returnUrl=/tools.html';
                    return;
                }

                // Wait for Firebase auth state to be ready (important!)
                let user = await window.AuthStateManager.waitForAuthReady(5000);

                // 如果没有用户，再检查一次存储的状�?                if (!user && window.AuthStateManager.getStoredAuthState) {
                    const storedState = window.AuthStateManager.getStoredAuthState();
                    if (storedState && storedState.uid) {
                        console.log('从存储中恢复认证状态，等待 Firebase 同步...');
                        user = await window.AuthStateManager.waitForAuthReady(3000);
                    }
                }

                if (user) {
                    // User is logged in via Firebase, record click and go to tools page
                    console.log('检测到 Firebase 登录，跳转到工具�?);
                    fetch('/api/metrics/events', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'ai_tool_click' })
                    }).catch(err => console.log('Metrics error:', err));

                    window.location.href = '/tools.html';
                } else {
                    // User not logged in, redirect to login page
                    console.log('未检测到登录状态，跳转到登录页');
                    window.location.href = '/auth.html?returnUrl=/tools.html';
                }
            } catch (error) {
                console.error('Login check error:', error);
                // On error, redirect to login page
                window.location.href = '/auth.html?returnUrl=/tools.html';
            }
        }
    </script>

    <!-- Portfolio Loading Script - Runs BEFORE main.js -->
    <script>
        (function () {
            'use strict';

            // Escape HTML to prevent XSS
            function escapeHtmlPortfolio(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Handle portfolio item click
            async function handlePortfolioClick(event, link) {
                event.preventDefault();
                event.stopPropagation();
                console.log('[Portfolio] Link clicked:', link);

                if (!link) return;

                // Check if it's a tools link
                const isToolsLink = link === 'tools' || link === '/tools.html' || link.includes('tools.html');

                if (isToolsLink) {
                    // Check Firebase auth status - wait for auth state to be ready
                    try {
                        if (window.AuthStateManager) {
                            let user = await window.AuthStateManager.waitForAuthReady(5000);

                            // 如果没有用户，再检查一次存储的状�?                            if (!user && window.AuthStateManager.getStoredAuthState) {
                                const storedState = window.AuthStateManager.getStoredAuthState();
                                if (storedState && storedState.uid) {
                                    user = await window.AuthStateManager.waitForAuthReady(3000);
                                }
                            }

                            if (user) {
                                window.location.href = '/tools.html';
                            } else {
                                window.location.href = '/auth.html?returnUrl=/tools.html';
                            }
                        } else {
                            window.location.href = '/auth.html?returnUrl=/tools.html';
                        }
                    } catch (error) {
                        console.error('Auth check error:', error);
                        window.location.href = '/auth.html?returnUrl=/tools.html';
                    }
                } else if (link.startsWith('http://') || link.startsWith('https://')) {
                    // External link - open in new tab
                    window.open(link, '_blank', 'noopener,noreferrer');
                } else {
                    // Internal link
                    window.location.href = '/' + link;
                }
            }

            // Bind click events to portfolio links
            function bindPortfolioLinkEvents() {
                const grid = document.getElementById('portfolio-grid');
                if (!grid) return;

                grid.querySelectorAll('.portfolio-link--active').forEach(link => {
                    link.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const encodedLink = this.dataset.link;
                        if (encodedLink) {
                            const decodedLink = decodeURIComponent(encodedLink);
                            handlePortfolioClick(e, decodedLink);
                        }
                    });
                });
            }

            // Bind filter button events using event delegation
            let filterEventsBound = false;
            function bindFilterEvents() {
                const filterContainer = document.querySelector('.portfolio-filter');
                if (!filterContainer) {
                    console.log('[Portfolio] Filter container not found');
                    return;
                }

                // Prevent duplicate event binding
                if (filterEventsBound) {
                    console.log('[Portfolio] Filter events already bound, skipping');
                    return;
                }
                filterEventsBound = true;

                console.log('[Portfolio] Binding filter events using event delegation');

                // Use event delegation - bind to container, works even if buttons are regenerated
                filterContainer.addEventListener('click', function (e) {
                    const btn = e.target.closest('.filter-btn');
                    if (!btn) return;

                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[Portfolio] Filter clicked:', btn.dataset.filter);

                    // Update active state
                    filterContainer.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('filter-btn--active');
                        b.setAttribute('aria-selected', 'false');
                    });
                    btn.classList.add('filter-btn--active');
                    btn.setAttribute('aria-selected', 'true');

                    // Filter items - simple show/hide without animation
                    const filter = btn.dataset.filter;
                    document.querySelectorAll('.portfolio-item').forEach(item => {
                        const shouldShow = filter === 'all' || item.dataset.category === filter;
                        item.style.display = shouldShow ? '' : 'none';
                    });
                });
            }

            // Render portfolio items
            function renderPortfolioItems(items) {
                console.log('[Portfolio] Rendering', items.length, 'items');
                const grid = document.getElementById('portfolio-grid');
                if (!grid) {
                    console.error('[Portfolio] Grid element not found');
                    return;
                }

                grid.innerHTML = items.map((item) => {
                    const hasLink = item.link && item.link.trim() !== '';
                    const encodedLink = hasLink ? encodeURIComponent(item.link) : '';

                    // Use custom image if available, otherwise use SVG placeholder
                    const hasImage = item.image && item.image.trim() !== '';
                    const imageSrc = hasImage
                        ? item.image
                        : `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f5f5f5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Inter, sans-serif' font-size='16' fill='%23666'%3E${escapeHtmlPortfolio(item.title)}%3C/text%3E%3C/svg%3E`;

                    return `
                        <article class="portfolio-item fade-in visible" data-category="${escapeHtmlPortfolio(item.category || 'all')}">
                            <div class="portfolio-image">
                                <img src="${hasImage ? escapeHtmlPortfolio(imageSrc) : imageSrc}" 
                                     alt="${escapeHtmlPortfolio(item.title)}" 
                                     loading="lazy" width="400" height="300"
                                     style="${hasImage ? 'object-fit: cover;' : ''}">
                            </div>
                            <div class="portfolio-content">
                                <h3 class="portfolio-title">${escapeHtmlPortfolio(item.title)}</h3>
                                <p class="portfolio-description">${escapeHtmlPortfolio(item.description)}</p>
                                <div class="portfolio-tags">
                                    ${(item.tags || []).map(tag => `<span class="tag">${escapeHtmlPortfolio(tag)}</span>`).join('')}
                                </div>
                            </div>
                            <div class="portfolio-actions">
                                ${hasLink ?
                            `<a href="#" class="portfolio-link portfolio-link--active" data-link="${encodedLink}">点此预览 <span class="link-arrow">�?/span></a>` :
                            `<span class="portfolio-link portfolio-link--disabled">暂无预览</span>`
                        }
                            </div>
                        </article>
                    `;
                }).join('');

                // Bind click events after rendering
                bindPortfolioLinkEvents();
            }

            // Update filter buttons
            function updateFilterButtons(filters) {
                const filterContainer = document.querySelector('.portfolio-filter');
                if (!filterContainer) return;

                const filterMap = {
                    '全部': 'all',
                    'AI 工具': 'ai-tools',
                    '网页设计': 'web-design',
                    '品牌设计': 'branding',
                    '应用': 'app'
                };

                filterContainer.innerHTML = filters.map((filter, index) => {
                    const category = filterMap[filter] || filter.toLowerCase().replace(/\s+/g, '-');
                    const isActive = index === 0;
                    return `<button class="filter-btn ${isActive ? 'filter-btn--active' : ''}" data-filter="${category}" role="tab" aria-selected="${isActive}">${escapeHtmlPortfolio(filter)}</button>`;
                }).join('');
            }

            // Load portfolio data
            async function loadPortfolio() {
                console.log('[Portfolio] Loading...');
                try {
                    const response = await fetch('/api/settings');
                    const settings = await response.json();

                    if (settings.portfolio && settings.portfolio.items) {
                        // Update filter buttons first
                        if (settings.portfolio.filters) {
                            updateFilterButtons(settings.portfolio.filters);
                        }
                        // Render items
                        renderPortfolioItems(settings.portfolio.items);
                        // Bind filter events after everything is rendered
                        bindFilterEvents();
                        console.log('[Portfolio] Loaded successfully');
                    }
                } catch (error) {
                    console.error('[Portfolio] Failed to load:', error);
                    const grid = document.getElementById('portfolio-grid');
                    if (grid) grid.innerHTML = '<p class="error-text">加载失败，请刷新页面</p>';
                }
            }

            // Initialize on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadPortfolio);
            } else {
                loadPortfolio();
            }
        })();
    </script>

        <!-- User Profile Popup -->
    <div id="profile-popup" class="profile-popup" style="display: none;">
        <div class="profile-popup-content">
            <button class="profile-popup-close" onclick="closeProfilePopup()" aria-label="鍏抽棴">&times;</button>
            <div class="profile-popup-header">
                <div class="profile-popup-avatar" id="profile-popup-avatar"></div>
                <div class="profile-popup-info">
                    <h3 id="profile-popup-name">鐢ㄦ埛</h3>
                    <p id="profile-popup-email">user@example.com</p>
                </div>
            </div>
            <div class="profile-popup-body">
                <div class="profile-popup-stats">
                    <div class="profile-stat">
                        <span class="profile-stat-value" id="profile-view-count">0</span>
                        <span class="profile-stat-label">璁块棶娆℃暟</span>
                    </div>
                    <div class="profile-stat">
                        <span class="profile-stat-value" id="profile-nickname">鏃?/span>
                        <span class="profile-stat-label">鏄电О</span>
                    </div>
                </div>
                <button class="profile-logout-btn" onclick="logoutUser()">閫€鍑虹櫥褰?/button>
            </div>
        </div>
    </div>
<!-- Aethrix Assistant -->
<div class="aethrix-assistant" id="aethrix-assistant" aria-label="Aethrix 助手">
    <!-- Floating Icon -->
    <div class="aethrix-icon" id="aethrix-icon" onclick="window.aethrixToggle()" role="button" tabindex="0"
        aria-label="打开AI助手" aria-expanded="false">
        <div class="aethrix-icon-inner">
            <span class="aethrix-logo">A</span>
        </div>
        <div class="aethrix-pulse"></div>
    </div>
    <!-- Speech Bubble on Hover -->
    <div class="aethrix-speech" id="aethrix-speech">
        <span>欢迎来到以太夜 ✨</span>
    </div>
</div>

<!-- Aethrix Chat Modal - Phone Style -->
<div class="aethrix-chat-modal" id="aethrix-chat-modal" role="dialog" aria-labelledby="aethrix-chat-title"
    aria-hidden="true">
    <div class="aethrix-chat-container">
        <div class="aethrix-chat-header">
            <div class="aethrix-chat-header-left">
                <div class="aethrix-chat-avatar">A</div>
                <div class="aethrix-chat-title">
                    <h3 id="aethrix-chat-title">Aethrix 助手</h3>
                    <div class="aethrix-chat-status">在线</div>
                </div>
            </div>
            <button class="aethrix-chat-close" id="aethrix-chat-close" aria-label="关闭聊天">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="aethrix-chat-messages" id="aethrix-chat-messages">
            <div class="aethrix-message aethrix-message--bot">
                <div class="aethrix-message-avatar">A</div>
                <div class="aethrix-message-content">
                    <p>你好！我是 Aethrix 助手 👋</p>
                    <p>欢迎来到以太夜，有什么可以帮助你的吗？</p>
                </div>
            </div>
        </div>
        <div class="aethrix-chat-input-container">
            <input type="text" class="aethrix-chat-input" id="aethrix-chat-input" placeholder="输入消息..."
                aria-label="输入消息">
            <button class="aethrix-chat-send" id="aethrix-chat-send" aria-label="发送消息">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    // Aethrix Assistant - 完整版（可拖动 + API 集成）
    (function () {
        'use strict';

        const STORAGE_KEY = 'aethrix_assistant_position';
        const API_ENDPOINT = '/api/assistant/chat';

        // 知识库（API 失败时的备用）
        const KNOWLEDGE_BASE = [
            { keywords: ['ai', 'ai工具', '人工智能', '工具', 'tools'], title: 'AI 工具平台', description: '最新最全的 AI 工具集合', link: '/tools.html', section: '导航栏「AI 工具」' },
            { keywords: ['作品', '作品集', '项目', 'portfolio'], title: '精选作品', description: '创意项目和技术实现展示', link: '#portfolio', section: '首页「精选作品」' },
            { keywords: ['服务', 'service', '开发'], title: '专业服务', description: '全方位数字化解决方案', link: '#services', section: '首页「专业服务」' },
            { keywords: ['关于', 'about', '团队'], title: '关于我们', description: '以太夜团队介绍', link: '#about', section: '首页「关于」' },
            { keywords: ['教程', 'tutorial', '学习'], title: '教程中心', description: 'AI 工具使用教程', link: '/tutorials.html', section: '导航栏「教程」' },
            { keywords: ['登录', '注册', 'login'], title: '登录 / 注册', description: '账号管理', link: '/auth.html', section: '右上角「登录」' }
        ];

        function matchKnowledge(query) {
            const lowerQuery = query.toLowerCase();
            for (const item of KNOWLEDGE_BASE) {
                for (const kw of item.keywords) {
                    if (lowerQuery.includes(kw.toLowerCase())) {
                        return `我找到了相关内容！\n\n<strong>${item.title}</strong>\n${item.description}\n\n📍 位置: ${item.section}\n🔗 <a href="${item.link}">点击前往 →</a>`;
                    }
                }
            }
            return '感谢你的提问！你可以：\n• 访问 <a href="/tools.html">AI 工具平台</a>\n• 查看 <a href="#portfolio">精选作品</a>\n• 浏览 <a href="#about">关于我们</a>';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 可拖动功能
        function initDraggable() {
            const assistant = document.getElementById('aethrix-assistant');
            if (!assistant) return;

            let isDragging = false;
            let hasMoved = false;
            let startX, startY, startLeft, startBottom;

            const savedPos = localStorage.getItem(STORAGE_KEY);
            if (savedPos) {
                try {
                    const pos = JSON.parse(savedPos);
                    assistant.style.right = 'auto';
                    assistant.style.left = pos.left + 'px';
                    assistant.style.bottom = pos.bottom + 'px';
                } catch (e) { }
            }

            const icon = document.getElementById('aethrix-icon');
            if (!icon) return;

            icon.addEventListener('mousedown', function (e) {
                isDragging = true;
                hasMoved = false;
                startX = e.clientX;
                startY = e.clientY;
                const rect = assistant.getBoundingClientRect();
                startLeft = rect.left;
                startBottom = window.innerHeight - rect.bottom;
                assistant.style.transition = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function (e) {
                if (!isDragging) return;
                const deltaX = e.clientX - startX;
                const deltaY = startY - e.clientY;
                if (Math.abs(deltaX) > 3 || Math.abs(deltaY) > 3) hasMoved = true;
                let newLeft = startLeft + deltaX;
                let newBottom = startBottom + deltaY;

                const maxLeft = window.innerWidth - 80;
                const maxBottom = window.innerHeight - 80;
                newLeft = Math.max(10, Math.min(maxLeft, newLeft));
                newBottom = Math.max(10, Math.min(maxBottom, newBottom));

                assistant.style.right = 'auto';
                assistant.style.left = newLeft + 'px';
                assistant.style.bottom = newBottom + 'px';
            });

            document.addEventListener('mouseup', function (e) {
                if (!isDragging) return;
                isDragging = false;
                assistant.style.transition = '';

                const rect = assistant.getBoundingClientRect();
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    left: rect.left,
                    bottom: window.innerHeight - rect.bottom
                }));

                if (!hasMoved) {
                    window.aethrixToggle();
                }
            });

            // 触摸支持
            icon.addEventListener('touchstart', function (e) {
                isDragging = true;
                hasMoved = false;
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                const rect = assistant.getBoundingClientRect();
                startLeft = rect.left;
                startBottom = window.innerHeight - rect.bottom;
                assistant.style.transition = 'none';
            }, { passive: true });

            document.addEventListener('touchmove', function (e) {
                if (!isDragging) return;
                const touch = e.touches[0];
                const deltaX = touch.clientX - startX;
                const deltaY = startY - touch.clientY;
                if (Math.abs(deltaX) > 3 || Math.abs(deltaY) > 3) hasMoved = true;
                let newLeft = startLeft + deltaX;
                let newBottom = startBottom + deltaY;

                const maxLeft = window.innerWidth - 80;
                const maxBottom = window.innerHeight - 80;
                newLeft = Math.max(10, Math.min(maxLeft, newLeft));
                newBottom = Math.max(10, Math.min(maxBottom, newBottom));

                assistant.style.right = 'auto';
                assistant.style.left = newLeft + 'px';
                assistant.style.bottom = newBottom + 'px';
            }, { passive: true });

            document.addEventListener('touchend', function () {
                if (!isDragging) return;
                isDragging = false;
                assistant.style.transition = '';

                const rect = assistant.getBoundingClientRect();
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    left: rect.left,
                    bottom: window.innerHeight - rect.bottom
                }));

                if (!hasMoved) {
                    window.aethrixToggle();
                }
            });
        }

        window.aethrixToggle = function () {
            const modal = document.getElementById('aethrix-chat-modal');
            const icon = document.getElementById('aethrix-icon');
            const assistant = document.getElementById('aethrix-assistant');

            if (!modal || !icon) return;

            const isOpen = modal.classList.contains('active');

            if (isOpen) {
                modal.classList.remove('active');
                icon.classList.remove('active');
                if (assistant) assistant.classList.remove('chat-open');
                modal.setAttribute('aria-hidden', 'true');
            } else {
                modal.classList.add('active');
                icon.classList.add('active');
                if (assistant) assistant.classList.add('chat-open');
                modal.setAttribute('aria-hidden', 'false');
                const input = document.getElementById('aethrix-chat-input');
                if (input) setTimeout(() => input.focus(), 100);
            }
        };

        async function callAI(message, messageHistory) {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, history: messageHistory })
                });

                if (!response.ok) throw new Error('API error');

                const data = await response.json();
                return data.reply || data.message || matchKnowledge(message);
            } catch (error) {
                console.log('[Aethrix] API 调用失败，使用本地知识库');
                return matchKnowledge(message);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const closeBtn = document.getElementById('aethrix-chat-close');
            const sendBtn = document.getElementById('aethrix-chat-send');
            const input = document.getElementById('aethrix-chat-input');
            const messages = document.getElementById('aethrix-chat-messages');
            const messageHistory = [];

            initDraggable();

            if (closeBtn) {
                closeBtn.addEventListener('click', function () {
                    const modal = document.getElementById('aethrix-chat-modal');
                    const icon = document.getElementById('aethrix-icon');
                    const assistant = document.getElementById('aethrix-assistant');
                    if (modal) modal.classList.remove('active');
                    if (icon) icon.classList.remove('active');
                    if (assistant) assistant.classList.remove('chat-open');
                });
            }

            async function sendMessage() {
                if (!input || !messages) return;
                const text = input.value.trim();
                if (!text) return;

                const userMsg = document.createElement('div');
                userMsg.className = 'aethrix-message aethrix-message--user';
                userMsg.innerHTML = `<div class="aethrix-message-content"><p>${escapeHtml(text)}</p></div>`;
                messages.appendChild(userMsg);
                input.value = '';
                messages.scrollTop = messages.scrollHeight;

                messageHistory.push({ role: 'user', content: text });

                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'aethrix-message aethrix-message--bot';
                typingIndicator.id = 'typing-indicator';
                typingIndicator.innerHTML = `<div class="aethrix-message-avatar">A</div><div class="aethrix-message-content"><div class="aethrix-typing"><span></span><span></span><span></span></div></div>`;
                messages.appendChild(typingIndicator);
                messages.scrollTop = messages.scrollHeight;

                const response = await callAI(text, messageHistory);

                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();

                messageHistory.push({ role: 'assistant', content: response });

                const botMsg = document.createElement('div');
                botMsg.className = 'aethrix-message aethrix-message--bot';
                botMsg.innerHTML = `<div class="aethrix-message-avatar">A</div><div class="aethrix-message-content"><p>${response.replace(/\n/g, '</p><p>')}</p></div>`;
                messages.appendChild(botMsg);
                messages.scrollTop = messages.scrollHeight;
            }

            if (sendBtn) sendBtn.addEventListener('click', sendMessage);
            if (input) input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

            console.log('[Aethrix] 助手已初始化');
        });
    })();
</script>
</body>

</html>