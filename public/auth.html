<!DOCTYPE html>
<html lang="zh-CN" translate="no">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Aethrix | ä»¥å¤ªå¤œ - ç™»å½•/æ³¨å†Œ">
    <!-- ç¦æ­¢ç¿»è¯‘æ‰©å±•ç¿»è¯‘æ­¤é¡µé¢ï¼Œé¿å…å¹²æ‰° OAuth ç™»å½•æµç¨‹ -->
    <meta name="google" content="notranslate">
    <meta name="translate" content="no">
    <meta http-equiv="Content-Language" content="zh-CN">
    <title>ç™»å½• / æ³¨å†Œ - Aethrix | ä»¥å¤ªå¤œ</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="style.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        .auth-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
        }

        .auth-header {
            padding: 20px 40px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
        }

        .auth-header .logo-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #000;
        }

        .auth-header .logo-text {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .auth-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .auth-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 420px;
            overflow: hidden;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
        }

        .auth-tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            background: #f9f9f9;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auth-tab.active {
            background: #fff;
            color: #000;
            border-bottom: 2px solid #000;
        }

        .auth-tab:hover:not(.active) {
            background: #f0f0f0;
        }

        .auth-form-container {
            padding: 32px;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .form-input-wrapper {
            position: relative;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .form-input.error {
            border-color: #e53935;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            padding: 4px;
        }

        .password-toggle:hover {
            color: #000;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .form-checkbox input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            background: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auth-btn:hover {
            background: #333;
        }

        .auth-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: #999;
            font-size: 14px;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e0e0e0;
        }

        .auth-divider span {
            padding: 0 16px;
        }

        .social-login-btn {
            width: 100%;
            padding: 12px;
            font-size: 15px;
            font-weight: 500;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
            margin-bottom: 12px;
        }

        .social-login-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .social-login-btn svg {
            width: 20px;
            height: 20px;
        }

        .github-btn {
            background: #24292e;
            color: #fff;
            border-color: #24292e;
        }

        .github-btn:hover {
            background: #1b1f23;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .auth-switch a {
            color: #000;
            font-weight: 600;
            text-decoration: none;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .auth-footer {
            text-align: center;
            padding: 16px 32px 24px;
            font-size: 12px;
            color: #999;
            border-top: 1px solid #f0f0f0;
        }

        .auth-footer a {
            color: #666;
            text-decoration: none;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0;
            transition: all 0.3s ease;
        }

        .password-strength-bar.weak {
            width: 33%;
            background: #e53935;
        }

        .password-strength-bar.medium {
            width: 66%;
            background: #fb8c00;
        }

        .password-strength-bar.strong {
            width: 100%;
            background: #43a047;
        }

        .password-strength-text {
            font-size: 12px;
            margin-top: 4px;
            color: #666;
        }

        .form-error {
            color: #e53935;
            font-size: 12px;
            margin-top: 4px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .forgot-password {
            text-align: right;
            margin-top: -12px;
            margin-bottom: 20px;
        }

        .forgot-password a {
            font-size: 13px;
            color: #666;
            text-decoration: none;
        }

        .forgot-password a:hover {
            color: #000;
            text-decoration: underline;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 480px) {
            .auth-header {
                padding: 16px 20px;
            }

            .auth-form-container {
                padding: 24px 20px;
            }
        }

        /* é‚®ç®±éªŒè¯ç›¸å…³æ ·å¼ */
        .email-verify-wrapper {
            display: flex;
            gap: 10px;
        }

        .email-verify-wrapper .form-input {
            flex: 1;
        }

        .verify-code-btn {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            color: #fff;
            background: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .verify-code-btn:hover:not(:disabled) {
            background: #333;
        }

        .verify-code-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .verify-code-btn.counting {
            background: #666;
        }

        .email-verify-status {
            font-size: 12px;
            margin-top: 6px;
            display: none;
        }

        .email-verify-status.show {
            display: block;
        }

        .email-verify-status.success {
            color: #43a047;
        }

        .email-verify-status.pending {
            color: #fb8c00;
        }

        .email-verify-status.error {
            color: #e53935;
        }

        /* éªŒè¯ç å¼¹çª—æ ·å¼ */
        .verification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .verification-modal.show {
            display: flex;
        }

        .verification-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .verification-modal-content {
            position: relative;
            background: #fff;
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        .verification-modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .verification-modal-close:hover {
            background: #f0f0f0;
            color: #000;
        }

        .verification-modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .verification-modal-header h3 {
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 8px 0;
        }

        .verification-modal-header p {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .verification-modal-header .email-display {
            color: #000;
            font-weight: 500;
        }

        .code-input-wrapper {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .code-input {
            width: 45px;
            height: 55px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .code-input:focus {
            outline: none;
            border-color: #000;
        }

        .code-input.filled {
            border-color: #43a047;
            background: #f1f8e9;
        }

        .verification-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .verification-modal-actions button {
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .resend-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            color: #333;
        }

        .resend-btn:hover:not(:disabled) {
            background: #eee;
        }

        .resend-btn:disabled {
            color: #999;
            cursor: not-allowed;
        }

        .verify-btn {
            background: #000;
            border: none;
            color: #fff;
        }

        .verify-btn:hover:not(:disabled) {
            background: #333;
        }

        .verify-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .verification-hint {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-top: 16px;
        }

        .verification-error {
            text-align: center;
            font-size: 13px;
            color: #e53935;
            margin-top: 12px;
            display: none;
        }

        .verification-error.show {
            display: block;
        }
    </style>
</head>

<body class="auth-page">
    <header class="auth-header">
        <a href="/" class="logo-link">
            <span class="logo-text">Aethrix | ä»¥å¤ªå¤œ</span>
        </a>
    </header>

    <main class="auth-container">
        <div class="auth-card">
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">ç™»å½•</button>
                <button class="auth-tab" data-tab="register">æ³¨å†Œ</button>
            </div>

            <div class="auth-form-container">
                <div id="auth-alert"></div>

                <!-- Login Form -->
                <form class="auth-form active" id="login-form" onsubmit="return false;">
                    <div class="form-group">
                        <label class="form-label" for="login-email">é‚®ç®±</label>
                        <input type="email" class="form-input" id="login-email" name="email" placeholder="è¯·è¾“å…¥é‚®ç®±"
                            required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="login-password">å¯†ç </label>
                        <div class="form-input-wrapper">
                            <input type="password" class="form-input" id="login-password" name="password"
                                placeholder="è¯·è¾“å…¥å¯†ç " required>
                            <button type="button" class="password-toggle" data-target="login-password"
                                aria-label="æ˜¾ç¤º/éšè—å¯†ç ">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                                    <circle cx="12" cy="12" r="3" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="forgot-password">
                        <a href="#" id="forgot-password-link">å¿˜è®°å¯†ç ï¼Ÿ</a>
                    </div>

                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" name="remember" id="remember-me">
                            <span>è®°ä½æˆ‘</span>
                        </label>
                    </div>

                    <button type="submit" class="auth-btn" id="login-btn">ç™»å½•</button>

                    <div class="auth-divider"><span>æˆ–</span></div>

                    <button type="button" class="social-login-btn github-btn" id="github-login-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                        </svg>
                        ä½¿ç”¨ GitHub ç™»å½•
                    </button>

                    <p class="auth-switch">
                        è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" data-switch="register">ç«‹å³æ³¨å†Œ</a>
                    </p>
                </form>

                <!-- Register Form -->
                <form class="auth-form" id="register-form" onsubmit="return false;">
                    <div class="form-group">
                        <label class="form-label" for="register-nickname">æ˜µç§° <span
                                style="color: #e53935;">*</span></label>
                        <input type="text" class="form-input" id="register-nickname" name="nickname"
                            placeholder="è¯·è¾“å…¥æ˜µç§°ï¼ˆ2-20ä¸ªå­—ç¬¦ï¼‰" required minlength="2" maxlength="20">
                        <div class="form-error" id="nickname-error"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="register-email">é‚®ç®± <span style="color: #e53935;">*</span></label>
                        <div class="email-verify-wrapper">
                            <input type="email" class="form-input" id="register-email" name="email" placeholder="è¯·è¾“å…¥é‚®ç®±"
                                required>
                            <button type="button" class="verify-code-btn" id="send-code-btn" disabled>è·å–éªŒè¯ç </button>
                        </div>
                        <div class="email-verify-status" id="email-verify-status"></div>
                        <div class="form-error" id="email-error"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="register-password">å¯†ç  <span
                                style="color: #e53935;">*</span></label>
                        <div class="form-input-wrapper">
                            <input type="password" class="form-input" id="register-password" name="password"
                                placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6">
                            <button type="button" class="password-toggle" data-target="register-password"
                                aria-label="æ˜¾ç¤º/éšè—å¯†ç ">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                                    <circle cx="12" cy="12" r="3" />
                                </svg>
                            </button>
                        </div>
                        <div class="password-strength">
                            <div class="password-strength-bar" id="password-strength-bar"></div>
                        </div>
                        <div class="password-strength-text" id="password-strength-text"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="register-confirm">ç¡®è®¤å¯†ç  <span
                                style="color: #e53935;">*</span></label>
                        <div class="form-input-wrapper">
                            <input type="password" class="form-input" id="register-confirm" name="confirm"
                                placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
                            <button type="button" class="password-toggle" data-target="register-confirm"
                                aria-label="æ˜¾ç¤º/éšè—å¯†ç ">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                                    <circle cx="12" cy="12" r="3" />
                                </svg>
                            </button>
                        </div>
                        <div class="form-error" id="confirm-error"></div>
                    </div>

                    <button type="submit" class="auth-btn" id="register-btn">æ³¨å†Œ</button>

                    <p class="auth-switch">
                        å·²æœ‰è´¦å·ï¼Ÿ<a href="#" data-switch="login">ç«‹å³ç™»å½•</a>
                    </p>
                </form>
            </div>

            <div class="auth-footer">
                ç»§ç»­å³è¡¨ç¤ºåŒæ„ <a href="#">ã€Šç”¨æˆ·åè®®ã€‹</a> å’Œ <a href="#">ã€Šéšç§æ”¿ç­–ã€‹</a>
            </div>
        </div>
    </main>

    <!-- Firebase Modules (SDK already loaded in head) -->
    <script src="js/firebase/firebaseConfig.js"></script>
    <script src="js/firebase/emailAuth.js"></script>
    <script src="js/firebase/githubAuth.js"></script>
    <script src="js/firebase/authStateManager.js"></script>
    <script src="js/firebase/githubOAuthDirect.js"></script>

    <script>
        // ğŸŒ å…¨å±€å˜é‡å’Œå‡½æ•°ï¼ˆåœ¨ DOMContentLoaded ä¹‹å‰å®šä¹‰ï¼Œç¡®ä¿ githubOAuthDirect.js å¯ä»¥è®¿é—®ï¼‰
        let githubOAuthPolling = null;

        // å¯åŠ¨ localStorage è½®è¯¢ï¼ˆç”¨äº GitHub OAuth å¼¹çª—é€šä¿¡ï¼‰
        window.startGitHubOAuthPolling = function () {
            // å¦‚æœå·²ç»åœ¨è½®è¯¢ï¼Œå…ˆåœæ­¢
            if (githubOAuthPolling) {
                clearInterval(githubOAuthPolling);
            }

            console.log('å¼€å§‹è½®è¯¢ GitHub OAuth ç»“æœ...');
            let pollCount = 0;
            const maxPolls = 100; // 20 ç§’è¶…æ—¶ï¼ˆæ¯ 200ms ä¸€æ¬¡ï¼‰

            githubOAuthPolling = setInterval(() => {
                pollCount++;

                // æ£€æŸ¥è¶…æ—¶
                if (pollCount > maxPolls) {
                    console.log('GitHub OAuth è½®è¯¢è¶…æ—¶');
                    clearInterval(githubOAuthPolling);
                    githubOAuthPolling = null;
                    return;
                }

                // æ£€æŸ¥ localStorage
                const resultStr = localStorage.getItem('github_oauth_result');
                if (!resultStr) {
                    return; // è¿˜æ²¡æœ‰ç»“æœï¼Œç»§ç»­è½®è¯¢
                }

                console.log('æ£€æµ‹åˆ° GitHub OAuth ç»“æœ');

                // åœæ­¢è½®è¯¢
                clearInterval(githubOAuthPolling);
                githubOAuthPolling = null;

                // æ¸…é™¤ç»“æœï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰
                localStorage.removeItem('github_oauth_result');

                try {
                    const result = JSON.parse(resultStr);
                    console.log('GitHub OAuth ç»“æœ:', result);

                    if (result.type === 'github_oauth_success') {
                        // ç™»å½•æˆåŠŸ
                        console.log('GitHub ç™»å½•æˆåŠŸ');

                        // ä¿å­˜è®¤è¯çŠ¶æ€
                        if (result.userData) {
                            localStorage.setItem('github_auth_state', JSON.stringify(result.userData));
                        }

                        // âœ… æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜ï¼‰éƒ½ç›´æ¥è·³è½¬åˆ°ä¸»é¡µ
                        console.log('ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°ä¸»é¡µ');
                        const alertDiv = document.getElementById('auth-alert');
                        if (alertDiv) {
                            alertDiv.innerHTML = '<div class="alert alert-success">ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...</div>';
                        }
                        setTimeout(() => {
                            window.location.href = '/tools.html';  // GitHubç™»å½•æˆåŠŸè·³è½¬åˆ°å·¥å…·é¡µ
                        }, 500);
                    } else if (result.type === 'github_oauth_error') {
                        // ç™»å½•å¤±è´¥
                        console.error('GitHub ç™»å½•å¤±è´¥:', result.error, result.message);
                        const alertDiv = document.getElementById('auth-alert');
                        if (alertDiv) {
                            alertDiv.innerHTML = `<div class="alert alert-error">${result.message || 'GitHub ç™»å½•å¤±è´¥'}</div>`;
                        }
                    }
                } catch (e) {
                    console.error('è§£æ GitHub OAuth ç»“æœå¤±è´¥:', e);
                    const alertDiv = document.getElementById('auth-alert');
                    if (alertDiv) {
                        alertDiv.innerHTML = '<div class="alert alert-error">ç™»å½•å¤„ç†å¤±è´¥</div>';
                    }
                }
            }, 200);
        };

        // åœæ­¢ GitHub OAuth è½®è¯¢
        window.stopGitHubOAuthPolling = function () {
            if (githubOAuthPolling) {
                clearInterval(githubOAuthPolling);
                githubOAuthPolling = null;
                console.log('å·²åœæ­¢ GitHub OAuth è½®è¯¢');
            }
        };

        console.log('âœ… GitHub OAuth è½®è¯¢å‡½æ•°å·²å®šä¹‰ä¸ºå…¨å±€å‡½æ•°');

        // ğŸŒ å…¨å±€å‡½æ•°ï¼šé™é»˜å¤„ç†ç®¡ç†å‘˜ç™»å½•ï¼ˆä¸æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼‰
        window.showAdminChoiceModal = function () {
            console.log('ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼Œé™é»˜è·³è½¬åˆ°ç®¡ç†åå°ï¼ˆä¸æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼‰');
            // âœ… ä¸æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼Œç›´æ¥è·³è½¬
            // ä¿ç•™æ­¤å‡½æ•°ä»¥å…¼å®¹ç°æœ‰ä»£ç è°ƒç”¨ï¼Œä½†ä¸æ‰§è¡Œæ˜¾ç¤ºæ“ä½œ
            window.location.href = '/admin.html';
        };

        // ğŸŒ å…¨å±€å‡½æ•°ï¼šå¤„ç† GitHub ç™»å½•æˆåŠŸï¼ˆåœ¨ DOMContentLoaded ä¹‹å‰å®šä¹‰ï¼‰
        window.handleGitHubLoginSuccess = function (result) {
            console.log('âœ… handleGitHubLoginSuccess è¢«è°ƒç”¨:', result);

            // âœ… å…¼å®¹æ—§çš„è°ƒç”¨æ–¹å¼ï¼ˆåªä¼  userDataï¼‰å’Œæ–°çš„è°ƒç”¨æ–¹å¼ï¼ˆä¼  loginResultï¼‰
            const userData = result.userData || result;
            const returnUrl = result.returnUrl || '/';  // âœ… æ”¹ä¸ºè·³è½¬åˆ°ä¸»é¡µ
            const isAdmin = result.isAdmin || userData.isAdmin || false;

            // ä¿å­˜è®¤è¯çŠ¶æ€
            if (userData) {
                localStorage.setItem('github_auth_state', JSON.stringify(userData));
            }

            // âœ… æ— è®ºç®¡ç†å‘˜è¿˜æ˜¯æ™®é€šç”¨æˆ·ï¼Œéƒ½ç›´æ¥è·³è½¬åˆ°ä¸»é¡µ
            console.log('ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°ä¸»é¡µ:', returnUrl);

            const alertDiv = document.getElementById('auth-alert');
            if (alertDiv) {
                alertDiv.innerHTML = '<div class="alert alert-success">ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...</div>';
            }

            // ğŸ”¥ å‡å°‘å»¶è¿Ÿåˆ° 500msï¼Œä¸é‚®ç®±ç™»å½•ä¿æŒä¸€è‡´
            setTimeout(() => {
                window.location.href = returnUrl;
            }, 500);
        };

        console.log('âœ… GitHub ç™»å½•å¤„ç†å‡½æ•°å·²å®šä¹‰ä¸ºå…¨å±€å‡½æ•°');

        // ğŸŒ æ·»åŠ  postMessage ç›‘å¬å™¨ï¼ˆä½œä¸º window.opener ç›´æ¥è°ƒç”¨çš„å¤‡ç”¨æ–¹æ¡ˆï¼‰
        window.addEventListener('message', function (event) {
            // éªŒè¯æ¥æºï¼ˆåªæ¥å—åŒæºæ¶ˆæ¯ï¼‰
            if (event.origin !== window.location.origin) {
                console.log('âš ï¸ å¿½ç•¥éåŒæºæ¶ˆæ¯:', event.origin);
                return;
            }

            console.log('ğŸ“¨ æ”¶åˆ° postMessage:', event.data);

            // æ£€æŸ¥æ¶ˆæ¯ç±»å‹
            if (event.data && event.data.type === 'github_oauth_success') {
                console.log('âœ… æ”¶åˆ° GitHub OAuth æˆåŠŸæ¶ˆæ¯');
                window.handleGitHubLoginSuccess(event.data);
            } else if (event.data && event.data.type === 'github_oauth_error') {
                console.error('âŒ æ”¶åˆ° GitHub OAuth é”™è¯¯æ¶ˆæ¯:', event.data);
                const alertDiv = document.getElementById('auth-alert');
                if (alertDiv) {
                    alertDiv.innerHTML = `<div class="alert alert-error">${event.data.message || 'GitHub ç™»å½•å¤±è´¥'}</div>`;
                }
            }
        });

        console.log('âœ… postMessage ç›‘å¬å™¨å·²æ·»åŠ ');

        document.addEventListener('DOMContentLoaded', async function () {
            console.log('Auth page loaded');

            // ğŸ§ª è‡ªåŠ¨æµ‹è¯•æ¨¡å¼æ£€æŸ¥
            const autoTest = sessionStorage.getItem('auto_test_modal');
            if (autoTest === 'true') {
                console.log('ğŸ§ª [è‡ªåŠ¨æµ‹è¯•] æ£€æµ‹åˆ°è‡ªåŠ¨æµ‹è¯•æ ‡è®°');
                sessionStorage.removeItem('auto_test_modal');

                // å»¶è¿Ÿä¸€ç‚¹ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
                setTimeout(() => {
                    console.log('ğŸ§ª [è‡ªåŠ¨æµ‹è¯•] æ£€æŸ¥ localStorage ä¸­çš„æµ‹è¯•æ•°æ®');
                    const testResult = localStorage.getItem('github_oauth_result');

                    if (testResult) {
                        console.log('ğŸ§ª [è‡ªåŠ¨æµ‹è¯•] æ‰¾åˆ°æµ‹è¯•æ•°æ®ï¼Œå¯åŠ¨è½®è¯¢');

                        // å¯åŠ¨è½®è¯¢
                        if (typeof window.startGitHubOAuthPolling === 'function') {
                            window.startGitHubOAuthPolling();
                            console.log('ğŸ§ª [è‡ªåŠ¨æµ‹è¯•] è½®è¯¢å·²å¯åŠ¨');
                        } else {
                            console.error('ğŸ§ª [è‡ªåŠ¨æµ‹è¯•] è½®è¯¢å‡½æ•°ä¸å­˜åœ¨ï¼');

                            // æ‰‹åŠ¨è§¦å‘
                            try {
                                const data = JSON.parse(testResult);
                                console.log('ğŸ§ª [è‡ªåŠ¨æµ‹è¯•] æ‰‹åŠ¨è§£ææ•°æ®:', data);

                                if (data.isAdmin) {
                                    console.log('ğŸ§ª [è‡ªåŠ¨æµ‹è¯•] æ£€æµ‹åˆ°ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†');

                                    // æŸ¥æ‰¾ showAdminChoiceModal å‡½æ•°
                                    if (typeof showAdminChoiceModal === 'function') {
                                        showAdminChoiceModal();
                                        console.log('ğŸ§ª [è‡ªåŠ¨æµ‹è¯•] âœ… æ¨¡æ€æ¡†åº”è¯¥å·²æ˜¾ç¤º');
                                    } else {
                                        console.error('ğŸ§ª [è‡ªåŠ¨æµ‹è¯•] âŒ showAdminChoiceModal å‡½æ•°ä¸å­˜åœ¨');
                                    }
                                }
                            } catch (e) {
                                console.error('ğŸ§ª [è‡ªåŠ¨æµ‹è¯•] è§£æå¤±è´¥:', e);
                            }
                        }
                    } else {
                        console.error('ğŸ§ª [è‡ªåŠ¨æµ‹è¯•] æœªæ‰¾åˆ°æµ‹è¯•æ•°æ®');
                    }
                }, 1000);
            }

            // å…¨å±€æ ‡å¿—ï¼šæ˜¯å¦æ­£åœ¨æ˜¾ç¤ºç®¡ç†å‘˜é€‰æ‹©ç•Œé¢
            window.isShowingAdminChoice = false;

            // åˆå§‹åŒ– Firebase
            let firebaseApp = null;
            let useFirebase = false;

            try {
                firebaseApp = window.FirebaseConfig.initializeFirebase();
                useFirebase = firebaseApp && window.FirebaseConfig.isConfigured();
                console.log('Firebase configured:', useFirebase);
            } catch (e) {
                console.log('Firebase åˆå§‹åŒ–å¤±è´¥:', e);
            }

            // æ£€æŸ¥ URL å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const returnUrl = urlParams.get('returnUrl');
            const switchAccount = urlParams.get('switch');
            const showAdminChoice = urlParams.get('showAdminChoice');

            // å…¨å±€å‡½æ•°ï¼šè¿›å…¥ç®¡ç†å‘˜åå°
            window.goToAdmin = async function () {
                console.log('ç”¨æˆ·é€‰æ‹©ï¼šç®¡ç†å‘˜åå°');

                // ç¡®ä¿åç«¯ session å·²åˆ›å»º
                try {
                    const auth = window.FirebaseConfig.getAuth();
                    const user = auth.currentUser;

                    if (user) {
                        console.log('åŒæ­¥åç«¯ session...');
                        const syncRes = await fetch('/api/auth/firebase-sync', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({
                                uid: user.uid,
                                email: user.email,
                                displayName: user.displayName,
                                photoURL: user.photoURL,
                                provider: user.providerData[0]?.providerId || 'unknown'
                            })
                        });

                        if (syncRes.ok) {
                            console.log('åç«¯ session åŒæ­¥æˆåŠŸ');
                        } else {
                            console.warn('åç«¯ session åŒæ­¥å¤±è´¥');
                        }
                    }
                } catch (error) {
                    console.error('åŒæ­¥ session å¤±è´¥:', error);
                }

                // æ¸…é™¤ showAdminChoice æ ‡è®°,é¿å…å¾ªç¯
                localStorage.removeItem('showAdminChoice');
                sessionStorage.removeItem('showAdminChoice');

                // å»¶è¿Ÿè·³è½¬,ç¡®ä¿ cookie å·²è®¾ç½®
                setTimeout(() => {
                    window.location.href = '/admin.html';
                }, 300);
            };

            // å…¨å±€å‡½æ•°ï¼šè¿›å…¥ç”¨æˆ·ç•Œé¢
            window.goToUser = function () {
                console.log('ç”¨æˆ·é€‰æ‹©ï¼šç”¨æˆ·ç•Œé¢');
                // æ¸…é™¤ showAdminChoice æ ‡è®°
                localStorage.removeItem('showAdminChoice');
                sessionStorage.removeItem('showAdminChoice');
                const urlParams = new URLSearchParams(window.location.search);
                const returnUrl = urlParams.get('returnUrl') || '/tools.html';
                window.location.href = returnUrl;
            };

            // å…¨å±€å‡½æ•°ï¼šå…³é—­ç®¡ç†å‘˜é€‰æ‹©æ¨¡æ€æ¡†
            window.closeAdminChoiceModal = function () {
                console.log('å…³é—­ç®¡ç†å‘˜é€‰æ‹©æ¨¡æ€æ¡†');
                const modal = document.getElementById('admin-choice-modal');
                if (modal) {
                    modal.style.display = 'none';
                    window.isShowingAdminChoice = false;
                }
                // æ¸…é™¤æ ‡è®°
                localStorage.removeItem('showAdminChoice');
                sessionStorage.removeItem('showAdminChoice');
                // å…³é—­åç•™åœ¨å½“å‰é¡µé¢(auth.html),ä¸è·³è½¬
                // ç”¨æˆ·å¯ä»¥é‡æ–°é€‰æ‹©ç™»å½•æ–¹å¼
                console.log('æ¨¡æ€æ¡†å·²å…³é—­,ç•™åœ¨ç™»å½•é¡µé¢');
            };

            // å¦‚æœéœ€è¦æ˜¾ç¤ºç®¡ç†å‘˜é€‰æ‹©ç•Œé¢
            if (showAdminChoice === 'true') {
                console.log('æ˜¾ç¤ºç®¡ç†å‘˜é€‰æ‹©ç•Œé¢');
                // ç§»é™¤å‚æ•°é¿å…åˆ·æ–°æ—¶é‡å¤æ˜¾ç¤º
                window.history.replaceState({}, '', '/auth.html' + (returnUrl ? '?returnUrl=' + returnUrl : ''));
                // æ˜¾ç¤ºé€‰æ‹©ç•Œé¢
                setTimeout(() => {
                    showAdminChoiceModal();
                }, 500);
            }

            // å¦‚æœæ˜¯åˆ‡æ¢è´¦å·ï¼Œå…ˆç™»å‡º
            if (switchAccount === 'true') {
                console.log('åˆ‡æ¢è´¦å·æ¨¡å¼ï¼Œå…ˆç™»å‡º...');
                try {
                    // å…ˆç™»å‡º Firebase
                    if (useFirebase) {
                        const auth = window.FirebaseConfig.getAuth();
                        await auth.signOut();
                    }
                    await fetch('/api/user/logout', { method: 'POST' });
                    // æ¸…é™¤ localStorageï¼ˆFirebase å’Œ GitHub OAuthï¼‰
                    localStorage.removeItem('firebase_auth_state');
                    localStorage.removeItem('github_auth_state');
                } catch (e) {
                    console.log('ç™»å‡ºå¤±è´¥:', e);
                }
                // ç§»é™¤ switch å‚æ•°ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤ç™»å‡º
                window.history.replaceState({}, '', '/auth.html' + (returnUrl ? '?returnUrl=' + returnUrl : ''));
            }

            // è®¾ç½® Firebase Auth çŠ¶æ€ç›‘å¬å™¨ï¼ˆç”¨äºæ£€æµ‹ OAuth ç™»å½•æˆåŠŸï¼‰
            if (useFirebase) {
                const auth = window.FirebaseConfig.getAuth();
                let authHandled = false;

                auth.onAuthStateChanged(async (user) => {
                    console.log('Firebase Auth çŠ¶æ€å˜åŒ–:', user ? user.email : 'æœªç™»å½•');

                    // å¦‚æœç”¨æˆ·å·²ç™»å½•ä¸”ä¸æ˜¯åˆ‡æ¢è´¦å·æ¨¡å¼
                    if (user && !switchAccount && !authHandled) {
                        authHandled = true;
                        console.log('æ£€æµ‹åˆ°å·²ç™»å½•ç”¨æˆ·:', user.email);

                        // ä¿å­˜è®¤è¯çŠ¶æ€
                        if (window.AuthStateManager && window.AuthStateManager.persistAuthState) {
                            await window.AuthStateManager.persistAuthState(user);
                        }

                        // å¦‚æœ URL å‚æ•°ä¸­æœ‰ showAdminChoice æˆ–æ­£åœ¨æ˜¾ç¤ºç®¡ç†å‘˜é€‰æ‹©ç•Œé¢ï¼Œä¸è¦è‡ªåŠ¨è·³è½¬
                        if (showAdminChoice === 'true' || window.isShowingAdminChoice) {
                            console.log('ç®¡ç†å‘˜é€‰æ‹©æ¨¡å¼ï¼Œä¸è‡ªåŠ¨è·³è½¬');
                            return;
                        }

                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜ï¼ˆåœ¨è·³è½¬å‰ï¼‰
                        try {
                            const adminResponse = await fetch('/api/admin/status');
                            const adminData = await adminResponse.json();

                            if (adminData.isAdmin) {
                                console.log('æ£€æµ‹åˆ°ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºé€‰æ‹©ç•Œé¢');
                                window.isShowingAdminChoice = true;
                                showAdminChoiceModal();
                                return;
                            }
                        } catch (error) {
                            console.error('æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€å¤±è´¥:', error);
                        }

                        // æ™®é€šç”¨æˆ·ï¼šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¹¶è·³è½¬
                        const alertDiv = document.getElementById('auth-alert');
                        if (alertDiv) {
                            alertDiv.innerHTML = '<div class="alert alert-success">ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...</div>';
                        }

                        setTimeout(() => {
                            window.location.href = returnUrl || '/tools.html';
                        }, 800);
                    }
                });
            }

            // åªæœ‰åœ¨æœ‰ returnUrl æ—¶æ‰æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶è‡ªåŠ¨è·³è½¬
            // ç›´æ¥è®¿é—® auth.html æ—¶ä¸è‡ªåŠ¨è·³è½¬ï¼Œè®©ç”¨æˆ·å¯ä»¥åˆ‡æ¢è´¦å·
            // å¦‚æœæœ‰ showAdminChoice å‚æ•°ï¼Œä¹Ÿä¸è¦è‡ªåŠ¨è·³è½¬
            if (returnUrl && !switchAccount && showAdminChoice !== 'true') {
                // é¦–å…ˆæ£€æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰æœ‰æ•ˆçš„è®¤è¯çŠ¶æ€
                // æ”¯æŒ Firebase å’Œ GitHub OAuth ä¸¤ç§ç™»å½•æ–¹å¼
                const storedAuth = localStorage.getItem('firebase_auth_state');
                const githubAuth = localStorage.getItem('github_auth_state');
                let hasValidLocalAuth = false;

                // æ£€æŸ¥ Firebase è®¤è¯
                if (storedAuth) {
                    try {
                        const authState = JSON.parse(storedAuth);
                        const tokenAge = Date.now() - (authState.timestamp || 0);
                        if (authState && authState.uid && authState.email && tokenAge < 60 * 60 * 1000) {
                            hasValidLocalAuth = true;
                        }
                    } catch (e) {
                        console.log('è§£æå­˜å‚¨çš„ Firebase è®¤è¯çŠ¶æ€å¤±è´¥:', e);
                    }
                }

                // æ£€æŸ¥ GitHub OAuth è®¤è¯
                if (!hasValidLocalAuth && githubAuth) {
                    try {
                        const authState = JSON.parse(githubAuth);
                        const tokenAge = Date.now() - (authState.timestamp || 0);
                        if (authState && authState.uid && tokenAge < 60 * 60 * 1000) {
                            hasValidLocalAuth = true;
                        }
                    } catch (e) {
                        console.log('è§£æå­˜å‚¨çš„ GitHub è®¤è¯çŠ¶æ€å¤±è´¥:', e);
                    }
                }

                // åªæœ‰åœ¨ localStorage æœ‰æœ‰æ•ˆè®¤è¯çŠ¶æ€æ—¶æ‰è·³è½¬
                if (hasValidLocalAuth) {
                    console.log('ç”¨æˆ·å·²ç™»å½•ï¼ˆlocalStorageï¼‰ï¼Œè·³è½¬åˆ°:', returnUrl);
                    window.location.replace(returnUrl);
                    return;
                }
                // æ²¡æœ‰æœ‰æ•ˆçš„æœ¬åœ°è®¤è¯çŠ¶æ€ï¼Œç•™åœ¨ç™»å½•é¡µ
                console.log('æ²¡æœ‰æœ‰æ•ˆçš„æœ¬åœ°è®¤è¯çŠ¶æ€ï¼Œæ˜¾ç¤ºç™»å½•é¡µ');
            }

            // Tab switching
            const tabs = document.querySelectorAll('.auth-tab');
            const forms = document.querySelectorAll('.auth-form');
            const switchLinks = document.querySelectorAll('[data-switch]');

            function switchTab(tabName) {
                tabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === tabName);
                });
                forms.forEach(form => {
                    form.classList.toggle('active', form.id === tabName + '-form');
                });
                document.getElementById('auth-alert').innerHTML = '';
            }

            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            switchLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab(link.dataset.switch);
                });
            });

            // Check URL params for initial tab
            if (urlParams.get('tab') === 'register') {
                switchTab('register');
            }

            // Password toggle
            document.querySelectorAll('.password-toggle').forEach(btn => {
                btn.addEventListener('click', function () {
                    const input = document.getElementById(this.dataset.target);
                    const type = input.type === 'password' ? 'text' : 'password';
                    input.type = type;

                    const svg = this.querySelector('svg');
                    if (type === 'text') {
                        svg.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
                    } else {
                        svg.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
                    }
                });
            });

            // Password strength
            const passwordInput = document.getElementById('register-password');
            const strengthBar = document.getElementById('password-strength-bar');
            const strengthText = document.getElementById('password-strength-text');

            passwordInput.addEventListener('input', function () {
                const password = this.value;
                let strength = 0;
                let text = '';

                if (password.length >= 6) strength++;
                if (password.length >= 10) strength++;
                if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
                if (/\d/.test(password)) strength++;
                if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength++;

                strengthBar.className = 'password-strength-bar';
                if (password.length === 0) {
                    text = '';
                } else if (strength <= 2) {
                    strengthBar.classList.add('weak');
                    text = 'å¼± - å»ºè®®ä½¿ç”¨æ›´å¤æ‚çš„å¯†ç ';
                } else if (strength <= 3) {
                    strengthBar.classList.add('medium');
                    text = 'ä¸­ - å¯ä»¥æ›´å¼º';
                } else {
                    strengthBar.classList.add('strong');
                    text = 'å¼º - å¾ˆå¥½ï¼';
                }

                strengthText.textContent = text;
            });

            // Confirm password validation
            const confirmInput = document.getElementById('register-confirm');
            const confirmError = document.getElementById('confirm-error');

            confirmInput.addEventListener('input', function () {
                if (this.value && this.value !== passwordInput.value) {
                    confirmError.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                    this.classList.add('error');
                } else {
                    confirmError.textContent = '';
                    this.classList.remove('error');
                }
            });

            // Show alert
            function showAlert(message, type) {
                const alertDiv = document.getElementById('auth-alert');
                alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            }

            // Set button loading state
            function setButtonLoading(btn, loading) {
                if (loading) {
                    btn.disabled = true;
                    btn.dataset.originalText = btn.textContent;
                    btn.innerHTML = '<span class="loading-spinner"></span>å¤„ç†ä¸­...';
                } else {
                    btn.disabled = false;
                    btn.textContent = btn.dataset.originalText || btn.textContent;
                }
            }

            // Redirect after login
            async function redirectAfterLogin() {
                // âœ… æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜ï¼‰éƒ½ç›´æ¥è·³è½¬åˆ°å·¥å…·é¡µ
                console.log('ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°å·¥å…·é¡µ');
                window.location.href = '/tools.html';
            }

            // Login form submit
            document.getElementById('login-form').addEventListener('submit', async function (e) {
                e.preventDefault();

                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const loginBtn = document.getElementById('login-btn');

                setButtonLoading(loginBtn, true);

                try {
                    if (useFirebase) {
                        console.log('ä½¿ç”¨ Firebase ç™»å½•...');

                        // ç›´æ¥ä½¿ç”¨ Firebase Auth API ç™»å½•ï¼Œé¿å…æ¨¡å—è°ƒç”¨é—®é¢˜
                        const auth = window.FirebaseConfig.getAuth();

                        try {
                            const userCredential = await auth.signInWithEmailAndPassword(email, password);
                            console.log('Firebase ç™»å½•æˆåŠŸ:', userCredential.user.email);

                            // ç«‹å³ä¿å­˜è®¤è¯çŠ¶æ€åˆ° localStorageï¼ˆé˜²æ­¢è·³è½¬åé—ªçƒï¼‰
                            if (window.AuthStateManager && window.AuthStateManager.persistAuthState) {
                                await window.AuthStateManager.persistAuthState(userCredential.user);
                                console.log('è®¤è¯çŠ¶æ€å·²ä¿å­˜åˆ° localStorage');
                            }

                            // åŒæ­¥åˆ°åç«¯ï¼ˆå¿…é¡»ç­‰å¾…å®Œæˆï¼‰
                            if (window.EmailAuth && window.EmailAuth.syncUserToBackend) {
                                try {
                                    await window.EmailAuth.syncUserToBackend(userCredential.user);
                                    console.log('åç«¯åŒæ­¥æˆåŠŸ');
                                } catch (err) {
                                    console.error('åç«¯åŒæ­¥å¤±è´¥:', err);
                                }
                            }

                            // ç«‹å³æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€ï¼ˆä½†ä¸æ˜¾ç¤ºé€‰æ‹©ç•Œé¢ï¼Œåªæ˜¯ä¸ºäº†åŒæ­¥åç«¯ï¼‰
                            try {
                                const adminResponse = await fetch('/api/admin/status');
                                if (adminResponse.ok) {
                                    const adminData = await adminResponse.json();
                                    console.log('ç®¡ç†å‘˜çŠ¶æ€:', adminData.isAdmin);
                                } else {
                                    console.warn('æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€å¤±è´¥: HTTP', adminResponse.status);
                                }
                            } catch (err) {
                                console.error('æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€å¤±è´¥:', err);
                                // ä¸è¦æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­ç™»å½•æµç¨‹
                            }

                            // âœ… æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜ï¼‰éƒ½æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¹¶è·³è½¬åˆ°ä¸»é¡µ
                            showAlert('ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                            setTimeout(() => {
                                window.location.href = '/tools.html';  // è·³è½¬åˆ°å·¥å…·é¡µ
                            }, 500);
                        } catch (firebaseError) {
                            console.error('Firebase ç™»å½•å¤±è´¥:', firebaseError.code, firebaseError.message);

                            let message = 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ';
                            switch (firebaseError.code) {
                                case 'auth/user-not-found':
                                    message = 'ç”¨æˆ·ä¸å­˜åœ¨';
                                    break;
                                case 'auth/wrong-password':
                                    message = 'å¯†ç é”™è¯¯';
                                    break;
                                case 'auth/invalid-email':
                                    message = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®';
                                    break;
                                case 'auth/user-disabled':
                                    message = 'è¯¥è´¦å·å·²è¢«ç¦ç”¨';
                                    break;
                                case 'auth/too-many-requests':
                                    message = 'ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•';
                                    break;
                                case 'auth/invalid-credential':
                                case 'auth/invalid-login-credentials':
                                    message = 'é‚®ç®±æˆ–å¯†ç é”™è¯¯';
                                    break;
                                case 'auth/network-request-failed':
                                    message = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                                    break;
                            }

                            showAlert(message, 'error');
                            setButtonLoading(loginBtn, false);
                            return; // ğŸ”¥ æ·»åŠ returnï¼Œé˜²æ­¢å¤–å±‚catchå†æ¬¡å¤„ç†
                        }
                    } else {
                        // ä½¿ç”¨åç«¯ API ç™»å½•
                        const response = await fetch('/api/user/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ nickname: email, password: password })
                        });

                        const data = await response.json();

                        if (data.success) {
                            showAlert('ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                            setTimeout(redirectAfterLogin, 1000);
                        } else {
                            showAlert(data.message || data.error || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ', 'error');
                            setButtonLoading(loginBtn, false);
                        }
                    }
                } catch (error) {
                    console.error('ç™»å½•é”™è¯¯:', error);
                    showAlert('ç™»å½•å¤±è´¥: ' + (error.message || 'è¯·ç¨åé‡è¯•'), 'error');
                    setButtonLoading(loginBtn, false);
                }
            });

            // Register form submit
            document.getElementById('register-form').addEventListener('submit', async function (e) {
                e.preventDefault();

                const nickname = document.getElementById('register-nickname').value.trim();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirm = document.getElementById('register-confirm').value;
                const registerBtn = document.getElementById('register-btn');

                // Validation
                if (!nickname || nickname.length < 2 || nickname.length > 20) {
                    showAlert('æ˜µç§°é•¿åº¦éœ€è¦åœ¨2-20ä¸ªå­—ç¬¦ä¹‹é—´', 'error');
                    return;
                }

                if (password !== confirm) {
                    showAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                    return;
                }

                if (password.length < 6) {
                    showAlert('å¯†ç é•¿åº¦è‡³å°‘6ä½', 'error');
                    return;
                }

                setButtonLoading(registerBtn, true);

                try {
                    if (useFirebase) {
                        // ä½¿ç”¨ Firebase æ³¨å†Œ
                        console.log('å°è¯• Firebase æ³¨å†Œ...');

                        // æ·»åŠ è¶…æ—¶æœºåˆ¶
                        const timeoutPromise = new Promise((_, reject) => {
                            setTimeout(() => reject(new Error('æ³¨å†Œè¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')), 30000);
                        });

                        const result = await Promise.race([
                            window.EmailAuth.registerWithEmail(email, password),
                            timeoutPromise
                        ]);
                        console.log('Firebase æ³¨å†Œç»“æœ:', result);

                        if (result.success) {
                            // è®¾ç½® Firebase displayName ä¸ºæ˜µç§°
                            try {
                                await result.user.updateProfile({ displayName: nickname });
                            } catch (e) {
                                console.log('è®¾ç½® displayName å¤±è´¥:', e);
                            }

                            // ç«‹å³ä¿å­˜è®¤è¯çŠ¶æ€åˆ° localStorageï¼ˆé˜²æ­¢è·³è½¬åé—ªçƒï¼‰
                            if (window.AuthStateManager && window.AuthStateManager.persistAuthState) {
                                await window.AuthStateManager.persistAuthState(result.user);
                                console.log('è®¤è¯çŠ¶æ€å·²ä¿å­˜åˆ° localStorage');
                            }

                            // åŒæ­¥åˆ°åç«¯ï¼ˆåŒ…å«æ˜µç§°ï¼‰
                            fetch('/api/auth/firebase-sync', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    uid: result.user.uid,
                                    email: result.user.email,
                                    displayName: nickname,
                                    provider: 'password'
                                })
                            }).catch(err => {
                                console.log('åŒæ­¥åˆ°åç«¯å¤±è´¥ï¼ˆä¸å½±å“ç™»å½•ï¼‰:', err);
                            });
                            showAlert('æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                            setTimeout(redirectAfterLogin, 1000);
                        } else {
                            showAlert(result.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                            setButtonLoading(registerBtn, false);
                        }
                    } else {
                        // ä½¿ç”¨åç«¯ API æ³¨å†Œ
                        console.log('å°è¯•åç«¯ API æ³¨å†Œ...');
                        const response = await fetch('/api/user/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: email, nickname: nickname, password: password })
                        });

                        const data = await response.json();
                        console.log('åç«¯æ³¨å†Œç»“æœ:', data);

                        if (data.success) {
                            // è‡ªåŠ¨ç™»å½•
                            await fetch('/api/user/login', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ nickname: email, password: password })
                            });
                            showAlert('æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                            setTimeout(redirectAfterLogin, 1000);
                        } else {
                            showAlert(data.message || data.error || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                            setButtonLoading(registerBtn, false);
                        }
                    }
                } catch (error) {
                    console.error('æ³¨å†Œé”™è¯¯:', error);
                    showAlert('æ³¨å†Œå¤±è´¥: ' + (error.message || 'è¯·ç¨åé‡è¯•'), 'error');
                    setButtonLoading(registerBtn, false);
                }
            });

            // æ£€æŸ¥æ˜¯å¦æœ‰ GitHub é‡å®šå‘ç™»å½•ç»“æœ
            if (useFirebase) {
                const auth = window.FirebaseConfig.getAuth();
                auth.getRedirectResult().then(async (result) => {
                    if (result.user) {
                        console.log('=== GitHub é‡å®šå‘ç™»å½•æˆåŠŸ ===');
                        console.log('ç”¨æˆ·:', result.user.email);

                        // ä¿å­˜è®¤è¯çŠ¶æ€
                        if (window.AuthStateManager && window.AuthStateManager.persistAuthState) {
                            await window.AuthStateManager.persistAuthState(result.user);
                        }

                        // åŒæ­¥åˆ°åç«¯
                        const credential = result.credential;
                        const githubToken = credential ? credential.accessToken : null;

                        fetch('/api/auth/firebase-sync', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                uid: result.user.uid,
                                email: result.user.email,
                                displayName: result.user.displayName,
                                photoURL: result.user.photoURL,
                                provider: 'github.com',
                                githubToken: githubToken
                            })
                        }).catch(err => console.log('åç«¯åŒæ­¥å¤±è´¥ï¼ˆä¸å½±å“ç™»å½•ï¼‰:', err));

                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
                        try {
                            const adminResponse = await fetch('/api/admin/status');
                            const adminData = await adminResponse.json();

                            if (adminData.isAdmin) {
                                console.log('æ£€æµ‹åˆ°ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºé€‰æ‹©ç•Œé¢');
                                window.isShowingAdminChoice = true;
                                showAdminChoiceModal();
                                return;
                            }
                        } catch (error) {
                            console.error('æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€å¤±è´¥:', error);
                        }

                        // æ™®é€šç”¨æˆ·ï¼šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯å¹¶è·³è½¬
                        showAlert('ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');

                        // è·å–ä¿å­˜çš„è¿”å› URL
                        const savedReturnUrl = sessionStorage.getItem('github_return_url');
                        sessionStorage.removeItem('github_return_url');
                        const finalReturnUrl = savedReturnUrl || returnUrl || '/tools.html';

                        setTimeout(() => {
                            window.location.href = finalReturnUrl;
                        }, 800);
                    }
                }).catch((error) => {
                    if (error.code && error.code !== 'auth/popup-closed-by-user') {
                        console.error('GitHub é‡å®šå‘ç»“æœé”™è¯¯:', error.code, error.message);
                        let message = 'GitHub ç™»å½•å¤±è´¥: ' + (error.message || error.code);
                        showAlert(message, 'error');
                    }
                });
            }

            // GitHub login - ä½¿ç”¨é‡å®šå‘æ–¹å¼ï¼ˆä¸ä½¿ç”¨å¼¹çª—ï¼‰
            document.getElementById('github-login-btn').addEventListener('click', async function () {
                console.log('=== GitHub ç™»å½•æŒ‰é’®ç‚¹å‡» ===');

                // æ£€æŸ¥æ˜¯å¦æœ‰ç›´æ¥ OAuth æ¨¡å—
                if (window.GitHubOAuthDirect && window.GitHubOAuthDirect.startGitHubLogin) {
                    console.log('ä½¿ç”¨ç›´æ¥ GitHub OAuth ç™»å½•...');
                    console.log('Redirect URI:', window.GitHubOAuthDirect.config.redirectUri);

                    // ä¿å­˜è¿”å› URL
                    const returnUrl = new URLSearchParams(window.location.search).get('returnUrl') || '/tools.html';
                    sessionStorage.setItem('github_oauth_return_url', returnUrl);

                    // å¼€å§‹ OAuth æµç¨‹ï¼ˆä¼šé‡å®šå‘åˆ° GitHubï¼‰
                    window.GitHubOAuthDirect.startGitHubLogin();
                    return;
                }

                // ä½¿ç”¨ Firebase é‡å®šå‘æ–¹å¼ï¼ˆä¸ä½¿ç”¨å¼¹çª—ï¼‰
                if (!useFirebase) {
                    showAlert('GitHub ç™»å½•æš‚ä¸å¯ç”¨', 'error');
                    return;
                }

                setButtonLoading(this, true);

                try {
                    const auth = window.FirebaseConfig.getAuth();

                    console.log('åˆ›å»º GithubAuthProvider...');
                    const provider = new firebase.auth.GithubAuthProvider();
                    provider.addScope('user:email');
                    provider.addScope('read:user');

                    // ä¿å­˜è¿”å› URL åˆ° sessionStorage
                    const returnUrl = new URLSearchParams(window.location.search).get('returnUrl') || '/tools.html';
                    sessionStorage.setItem('github_return_url', returnUrl);

                    console.log('ä½¿ç”¨é‡å®šå‘æ–¹å¼ç™»å½•ï¼ˆä¸ä½¿ç”¨å¼¹çª—ï¼‰...');
                    // ä½¿ç”¨é‡å®šå‘æ–¹å¼è€Œä¸æ˜¯å¼¹çª—
                    await auth.signInWithRedirect(provider);
                    // æ³¨æ„ï¼šè¿™é‡Œä¼šé‡å®šå‘åˆ° GitHubï¼Œç„¶åè¿”å›åˆ°å½“å‰é¡µé¢
                    // è¿”å›åä¼šåœ¨ getRedirectResult() ä¸­å¤„ç†ç»“æœ

                } catch (error) {
                    console.error('GitHub ç™»å½•é”™è¯¯:', error.code, error.message);

                    let message = 'GitHub ç™»å½•å¤±è´¥';
                    switch (error.code) {
                        case 'auth/operation-not-allowed':
                            message = 'GitHub ç™»å½•æœªå¯ç”¨';
                            break;
                        case 'auth/unauthorized-domain':
                            message = 'å½“å‰åŸŸåæœªæˆæƒ';
                            break;
                        default:
                            message = 'GitHub ç™»å½•å¤±è´¥: ' + (error.message || error.code);
                    }
                    showAlert(message, 'error');
                    setButtonLoading(this, false);
                }
            })

            // Forgot password
            document.getElementById('forgot-password-link').addEventListener('click', async function (e) {
                e.preventDefault();

                const email = document.getElementById('login-email').value;

                if (!email) {
                    showAlert('è¯·å…ˆè¾“å…¥é‚®ç®±åœ°å€', 'error');
                    return;
                }

                if (!useFirebase) {
                    showAlert('å¯†ç é‡ç½®åŠŸèƒ½éœ€è¦é…ç½® Firebaseï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
                    return;
                }

                try {
                    const result = await window.EmailAuth.sendPasswordReset(email);

                    if (result.success) {
                        showAlert(result.message, 'success');
                    } else {
                        showAlert(result.message, 'error');
                    }
                } catch (error) {
                    console.error('å¯†ç é‡ç½®é”™è¯¯:', error);
                    showAlert('å‘é€é‡ç½®é‚®ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            });

            // ğŸ”„ é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰ GitHub OAuth ç»“æœ
            // è¿™æ˜¯ä¸ºäº†å¤„ç†å¼¹çª—å…³é—­åï¼Œä¸»é¡µé¢æ£€æµ‹ç™»å½•ç»“æœçš„æƒ…å†µ
            setTimeout(() => {
                const oauthResult = localStorage.getItem('github_oauth_result');
                if (oauthResult) {
                    console.log('ğŸ”„ [è‡ªåŠ¨æ£€æŸ¥] æ£€æµ‹åˆ° localStorage ä¸­æœ‰ OAuth ç»“æœï¼Œå¯åŠ¨è½®è¯¢');
                    // å¯åŠ¨è½®è¯¢æ¥å¤„ç†è¿™ä¸ªç»“æœ
                    if (typeof startGitHubOAuthPolling === 'function') {
                        startGitHubOAuthPolling();
                    }
                }
            }, 500); // å»¶è¿Ÿ 500msï¼Œç¡®ä¿æ‰€æœ‰å‡½æ•°éƒ½å·²å®šä¹‰

            // ========================================
            // ğŸ“§ é‚®ç®±éªŒè¯ç åŠŸèƒ½
            // ========================================

            // éªŒè¯ç çŠ¶æ€ç®¡ç†
            let emailVerified = false;  // é‚®ç®±æ˜¯å¦å·²éªŒè¯
            let verifiedEmail = '';     // å·²éªŒè¯çš„é‚®ç®±åœ°å€
            let countdownTimer = null;  // å€’è®¡æ—¶å®šæ—¶å™¨
            let modalCountdownTimer = null;  // å¼¹çª—å€’è®¡æ—¶

            const registerEmailInput = document.getElementById('register-email');
            const sendCodeBtn = document.getElementById('send-code-btn');
            const emailVerifyStatus = document.getElementById('email-verify-status');

            // éªŒè¯ç å¼¹çª—å…ƒç´ 
            const verificationModal = document.getElementById('verification-modal');
            const modalEmailDisplay = document.getElementById('modal-email-display');
            const modalResendBtn = document.getElementById('modal-resend-btn');
            const modalVerifyBtn = document.getElementById('modal-verify-btn');
            const verificationError = document.getElementById('verification-error');
            const codeInputs = document.querySelectorAll('.code-input');

            // ç›‘å¬é‚®ç®±è¾“å…¥ - å¯ç”¨/ç¦ç”¨è·å–éªŒè¯ç æŒ‰é’®
            registerEmailInput.addEventListener('input', function () {
                const email = this.value.trim();
                const isValidEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

                // å¦‚æœé‚®ç®±æ”¹å˜ï¼Œé‡ç½®éªŒè¯çŠ¶æ€
                if (email !== verifiedEmail) {
                    emailVerified = false;
                    updateEmailVerifyStatus('', '');
                }

                sendCodeBtn.disabled = !isValidEmail || emailVerified;

                // å¦‚æœå·²éªŒè¯ï¼Œæ˜¾ç¤ºçŠ¶æ€
                if (emailVerified && email === verifiedEmail) {
                    updateEmailVerifyStatus('âœ“ é‚®ç®±å·²éªŒè¯', 'success');
                    sendCodeBtn.textContent = 'å·²éªŒè¯';
                    sendCodeBtn.disabled = true;
                }
            });

            // æ›´æ–°é‚®ç®±éªŒè¯çŠ¶æ€æ˜¾ç¤º
            function updateEmailVerifyStatus(message, type) {
                emailVerifyStatus.textContent = message;
                emailVerifyStatus.className = 'email-verify-status';
                if (message) {
                    emailVerifyStatus.classList.add('show', type);
                }
            }

            // å‘é€éªŒè¯ç æŒ‰é’®ç‚¹å‡»
            sendCodeBtn.addEventListener('click', async function () {
                const email = registerEmailInput.value.trim();

                if (!email) {
                    showAlert('è¯·è¾“å…¥é‚®ç®±åœ°å€', 'error');
                    return;
                }

                // å‘é€éªŒè¯ç 
                await sendVerificationCode(email);
            });

            // å‘é€éªŒè¯ç å‡½æ•°
            async function sendVerificationCode(email) {
                try {
                    sendCodeBtn.disabled = true;
                    sendCodeBtn.textContent = 'å‘é€ä¸­...';

                    // ğŸš€ ç«‹å³æ˜¾ç¤ºå¼¹çª—ï¼Œå¸¦ Loading çŠ¶æ€
                    openVerificationModal(email, true); // true = loading

                    const response = await fetch('/api/auth/send-verification-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    });

                    const data = await response.json();

                    if (data.success) {
                        console.log('éªŒè¯ç å‘é€æˆåŠŸ');
                        updateEmailVerifyStatus('éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶', 'pending');

                        // ğŸ”„ æ›´æ–°å¼¹çª—ä¸ºè¾“å…¥çŠ¶æ€
                        updateVerificationModalState('ready');

                        // å¯åŠ¨å€’è®¡æ—¶
                        startCountdown(60);
                    } else {
                        showAlert(data.message || 'å‘é€éªŒè¯ç å¤±è´¥', 'error');
                        closeVerificationModal();
                        sendCodeBtn.disabled = false;
                        sendCodeBtn.textContent = 'è·å–éªŒè¯ç ';
                    }
                } catch (error) {
                    console.error('å‘é€éªŒè¯ç å¤±è´¥:', error);
                    showAlert('å‘é€éªŒè¯ç å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    closeVerificationModal();
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.textContent = 'è·å–éªŒè¯ç ';
                }
            }

            // å¯åŠ¨å€’è®¡æ—¶
            function startCountdown(seconds) {
                let remaining = seconds;

                sendCodeBtn.classList.add('counting');
                sendCodeBtn.textContent = `é‡æ–°å‘é€(${remaining}s)`;
                sendCodeBtn.disabled = true;

                modalResendBtn.textContent = `é‡æ–°å‘é€(${remaining}s)`;
                modalResendBtn.disabled = true;

                countdownTimer = setInterval(() => {
                    remaining--;
                    sendCodeBtn.textContent = `é‡æ–°å‘é€(${remaining}s)`;
                    modalResendBtn.textContent = `é‡æ–°å‘é€(${remaining}s)`;

                    if (remaining <= 0) {
                        clearInterval(countdownTimer);
                        countdownTimer = null;

                        sendCodeBtn.classList.remove('counting');
                        sendCodeBtn.textContent = 'è·å–éªŒè¯ç ';
                        sendCodeBtn.disabled = emailVerified;

                        modalResendBtn.textContent = 'é‡æ–°å‘é€';
                        modalResendBtn.disabled = false;
                    }
                }, 1000);
            }

            // æ‰“å¼€éªŒè¯ç å¼¹çª—
            window.openVerificationModal = function (email, isLoading = false) {
                modalEmailDisplay.textContent = email;
                verificationModal.classList.add('show');
                verificationError.classList.remove('show');

                // æ¸…ç©ºè¾“å…¥æ¡†
                codeInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('filled');
                });

                // æ ¹æ® isLoading æ˜¾ç¤ºä¸åŒå†…å®¹
                const inputWrapper = document.querySelector('.code-input-wrapper');
                const modalActions = document.querySelector('.verification-modal-actions');
                const hint = document.querySelector('.verification-hint');
                const loadingEl = document.getElementById('verification-loading');

                if (isLoading) {
                    // Loading çŠ¶æ€ï¼šéšè—è¾“å…¥æ¡†å’ŒæŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                    if (inputWrapper) inputWrapper.style.display = 'none';
                    if (modalActions) modalActions.style.display = 'none';
                    if (hint) hint.style.display = 'none';

                    if (loadingEl) {
                        loadingEl.style.display = 'flex';
                    } else {
                        // åŠ¨æ€åˆ›å»º loading å…ƒç´ 
                        const loader = document.createElement('div');
                        loader.id = 'verification-loading';
                        loader.innerHTML = `
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 0;">
                                <div style="width: 30px; height: 30px; border: 2px solid #f3f3f3; border-top: 2px solid #000; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                                <p style="margin-top: 16px; color: #666; font-size: 14px;">æ­£åœ¨å‘é€éªŒè¯ç ...</p>
                                <p style="margin-top: 4px; color: #999; font-size: 12px;">è¯·ç¨ç­‰......</p>
                            </div>
                        `;
                        const modalContent = verificationModal.querySelector('.verification-modal-content');
                        if (modalContent) {
                            // æ’å…¥åˆ° inputWrapper ä¹‹å‰æˆ– append
                            if (inputWrapper) {
                                modalContent.insertBefore(loader, inputWrapper);
                            } else {
                                modalContent.appendChild(loader);
                            }
                        }
                    }
                } else {
                    // Ready çŠ¶æ€ï¼šæ˜¾ç¤ºè¾“å…¥æ¡†
                    if (inputWrapper) inputWrapper.style.display = 'flex';
                    if (modalActions) modalActions.style.display = 'flex';
                    if (hint) hint.style.display = 'block';
                    if (loadingEl) loadingEl.style.display = 'none';
                    // èšç„¦ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
                    codeInputs[0].focus();
                }
            };

            // æ›´æ–°å¼¹çª—çŠ¶æ€
            window.updateVerificationModalState = function (state) {
                const inputWrapper = document.querySelector('.code-input-wrapper');
                const modalActions = document.querySelector('.verification-modal-actions');
                const hint = document.querySelector('.verification-hint');
                const loadingEl = document.getElementById('verification-loading');

                if (state === 'ready') {
                    if (inputWrapper) inputWrapper.style.display = 'flex';
                    if (modalActions) modalActions.style.display = 'flex';
                    if (hint) hint.style.display = 'block';
                    if (loadingEl) loadingEl.style.display = 'none';
                    // èšç„¦ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
                    codeInputs[0].focus();
                }
            };

            // å…³é—­éªŒè¯ç å¼¹çª—
            window.closeVerificationModal = function () {
                verificationModal.classList.remove('show');
                // æ¸…ç† loading å…ƒç´ 
                const loadingEl = document.getElementById('verification-loading');
                if (loadingEl) loadingEl.remove();

                // æ¢å¤é»˜è®¤æ˜¾ç¤ºçŠ¶æ€ï¼ˆä»¥é˜²ä¸‹æ¬¡æ‰“å¼€æ—¶çŠ¶æ€ä¸å¯¹ï¼‰
                const inputWrapper = document.querySelector('.code-input-wrapper');
                const modalActions = document.querySelector('.verification-modal-actions');
                const hint = document.querySelector('.verification-hint');
                if (inputWrapper) inputWrapper.style.display = 'flex';
                if (modalActions) modalActions.style.display = 'flex';
                if (hint) hint.style.display = 'block';
            };

            // éªŒè¯ç è¾“å…¥æ¡†é€»è¾‘
            codeInputs.forEach((input, index) => {
                // è¾“å…¥æ—¶è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€ä¸ª
                input.addEventListener('input', function (e) {
                    const value = e.target.value;

                    // åªå…è®¸æ•°å­—
                    if (!/^\d*$/.test(value)) {
                        e.target.value = '';
                        return;
                    }

                    if (value.length === 1) {
                        e.target.classList.add('filled');
                        // è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€ä¸ª
                        if (index < codeInputs.length - 1) {
                            codeInputs[index + 1].focus();
                        }
                    } else {
                        e.target.classList.remove('filled');
                    }

                    // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å¡«å†™
                    checkCodeComplete();
                });

                // é”®ç›˜äº‹ä»¶ - é€€æ ¼åˆ é™¤
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        codeInputs[index - 1].focus();
                        codeInputs[index - 1].value = '';
                        codeInputs[index - 1].classList.remove('filled');
                    }
                });

                // ç²˜è´´äº‹ä»¶
                input.addEventListener('paste', function (e) {
                    e.preventDefault();
                    const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);

                    pastedData.split('').forEach((char, i) => {
                        if (codeInputs[i]) {
                            codeInputs[i].value = char;
                            codeInputs[i].classList.add('filled');
                        }
                    });

                    // èšç„¦åˆ°æœ€åä¸€ä¸ªå¡«å†™çš„ä½ç½®æˆ–éªŒè¯æŒ‰é’®
                    if (pastedData.length === 6) {
                        modalVerifyBtn.focus();
                    } else if (codeInputs[pastedData.length]) {
                        codeInputs[pastedData.length].focus();
                    }

                    checkCodeComplete();
                });
            });

            // æ£€æŸ¥éªŒè¯ç æ˜¯å¦å¡«å†™å®Œæ•´
            function checkCodeComplete() {
                const code = getCodeValue();
                modalVerifyBtn.disabled = code.length !== 6;
            }

            // è·å–éªŒè¯ç å€¼
            function getCodeValue() {
                return Array.from(codeInputs).map(input => input.value).join('');
            }

            // é‡æ–°å‘é€éªŒè¯ç 
            modalResendBtn.addEventListener('click', async function () {
                const email = modalEmailDisplay.textContent;
                await sendVerificationCode(email);
            });

            // éªŒè¯éªŒè¯ç 
            modalVerifyBtn.addEventListener('click', async function () {
                const email = modalEmailDisplay.textContent;
                const code = getCodeValue();

                if (code.length !== 6) {
                    showVerificationError('è¯·è¾“å…¥å®Œæ•´çš„6ä½éªŒè¯ç ');
                    return;
                }

                try {
                    modalVerifyBtn.disabled = true;
                    modalVerifyBtn.textContent = 'éªŒè¯ä¸­...';

                    const response = await fetch('/api/auth/verify-code', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email, code: code })
                    });

                    const data = await response.json();

                    if (data.success && data.verified) {
                        console.log('é‚®ç®±éªŒè¯æˆåŠŸ');
                        emailVerified = true;
                        verifiedEmail = email;

                        // æ›´æ–°ç•Œé¢çŠ¶æ€
                        updateEmailVerifyStatus('âœ“ é‚®ç®±éªŒè¯æˆåŠŸ', 'success');
                        sendCodeBtn.textContent = 'å·²éªŒè¯';
                        sendCodeBtn.disabled = true;
                        sendCodeBtn.classList.remove('counting');

                        // æ¸…é™¤å€’è®¡æ—¶
                        if (countdownTimer) {
                            clearInterval(countdownTimer);
                            countdownTimer = null;
                        }

                        // å…³é—­å¼¹çª—
                        closeVerificationModal();

                        // èšç„¦åˆ°å¯†ç è¾“å…¥æ¡†
                        document.getElementById('register-password').focus();
                    } else {
                        showVerificationError(data.message || 'éªŒè¯ç é”™è¯¯');
                        modalVerifyBtn.disabled = false;
                        modalVerifyBtn.textContent = 'ç¡®è®¤éªŒè¯';
                    }
                } catch (error) {
                    console.error('éªŒè¯å¤±è´¥:', error);
                    showVerificationError('éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    modalVerifyBtn.disabled = false;
                    modalVerifyBtn.textContent = 'ç¡®è®¤éªŒè¯';
                }
            });

            // æ˜¾ç¤ºéªŒè¯é”™è¯¯
            function showVerificationError(message) {
                verificationError.textContent = message;
                verificationError.classList.add('show');
            }

            // ä¿®æ”¹æ³¨å†Œè¡¨å•éªŒè¯ - å¿…é¡»éªŒè¯é‚®ç®±
            const originalRegisterFormSubmit = document.getElementById('register-form').onsubmit;
            document.getElementById('register-form').addEventListener('submit', function (e) {
                // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²éªŒè¯
                const email = registerEmailInput.value.trim();

                if (!emailVerified || email !== verifiedEmail) {
                    e.preventDefault();
                    e.stopPropagation();
                    showAlert('è¯·å…ˆéªŒè¯é‚®ç®±åå†æ³¨å†Œ', 'error');
                    return false;
                }
            }, true);  // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œä¼˜å…ˆæ‰§è¡Œ

        });
    </script>

    <!-- ç®¡ç†å‘˜è§’è‰²é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="admin-choice-modal" class="role-modal" style="display: none;">
        <div class="role-modal-overlay"></div>
        <div class="role-modal-content">
            <!-- å…³é—­æŒ‰é’® -->
            <button class="role-modal-close" onclick="closeAdminChoiceModal()" aria-label="å…³é—­">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <div class="role-modal-header">
                <h2>é€‰æ‹©è®¿é—®æ–¹å¼</h2>
                <p>æ‚¨æ˜¯ç®¡ç†å‘˜ï¼Œè¯·é€‰æ‹©è¦è®¿é—®çš„ç•Œé¢</p>
            </div>
            <div class="role-modal-body">
                <button class="role-choice-btn admin-btn" onclick="goToAdmin()">
                    <div class="role-info">
                        <h3>ç®¡ç†å‘˜åå°</h3>
                        <p>ç®¡ç†å·¥å…·ã€ç”¨æˆ·å’Œç³»ç»Ÿè®¾ç½®</p>
                    </div>
                </button>
                <button class="role-choice-btn user-btn" onclick="goToUser()">
                    <div class="role-info">
                        <h3>ç”¨æˆ·ç•Œé¢</h3>
                        <p>æµè§ˆå’Œä½¿ç”¨ AI å·¥å…·</p>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <style>
        /* è§’è‰²é€‰æ‹©æ¨¡æ€æ¡†æ ·å¼ */
        .role-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .role-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }

        .role-modal-content {
            position: relative;
            background: #fff;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        /* å…³é—­æŒ‰é’®æ ·å¼ */
        .role-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
        }

        .role-modal-close:hover {
            background: #f0f0f0;
            color: #000;
        }

        .role-modal-close:active {
            transform: scale(0.95);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .role-modal-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .role-modal-header h2 {
            font-size: 28px;
            font-weight: 800;
            color: #000;
            margin: 0 0 10px 0;
            letter-spacing: -0.02em;
        }

        .role-modal-header p {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .role-modal-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .role-choice-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .role-choice-btn:hover {
            border-color: #000;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .role-choice-btn.admin-btn:hover {
            background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%);
        }

        .role-choice-btn.user-btn:hover {
            background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%);
        }

        .role-info {
            width: 100%;
        }

        .role-info h3 {
            font-size: 18px;
            font-weight: 700;
            color: #000;
            margin: 0 0 8px 0;
        }

        .role-info p {
            font-size: 14px;
            color: #666;
            margin: 0;
            line-height: 1.5;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 600px) {
            .role-modal-content {
                padding: 30px 20px;
            }

            .role-modal-header h2 {
                font-size: 24px;
            }

            .role-choice-btn {
                padding: 20px 15px;
            }

            .role-info h3 {
                font-size: 16px;
            }

            .role-info p {
                font-size: 13px;
            }
        }
    </style>

    <!-- é‚®ç®±éªŒè¯ç å¼¹çª— -->
    <div id="verification-modal" class="verification-modal">
        <div class="verification-modal-overlay" onclick="closeVerificationModal()"></div>
        <div class="verification-modal-content">
            <button class="verification-modal-close" onclick="closeVerificationModal()" aria-label="å…³é—­">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <div class="verification-modal-header">
                <h3>é‚®ç®±éªŒè¯</h3>
                <p>éªŒè¯ç å·²å‘é€è‡³: <span class="email-display" id="modal-email-display"></span></p>
            </div>

            <div class="code-input-wrapper">
                <input type="text" class="code-input" maxlength="1" data-index="0" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" data-index="1" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" data-index="2" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" data-index="3" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" data-index="4" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" data-index="5" inputmode="numeric">
            </div>

            <div class="verification-error" id="verification-error"></div>

            <div class="verification-modal-actions">
                <button type="button" class="resend-btn" id="modal-resend-btn" disabled>é‡æ–°å‘é€(60s)</button>
                <button type="button" class="verify-btn" id="modal-verify-btn">ç¡®è®¤éªŒè¯</button>
            </div>

            <p class="verification-hint">æ²¡æœ‰æ”¶åˆ°é‚®ä»¶ï¼Ÿè¯·æ£€æŸ¥åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹</p>
        </div>
    </div>
</body>

</html>