<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Firebase Modules -->
    <script src="js/firebase/firebaseConfig.js"></script>
    <script src="js/firebase/emailAuth.js"></script>
    <script src="js/firebase/authStateManager.js"></script>
    <script src="js/firebase/roleManager.js"></script>
    <script src="js/firebase/errorHandler.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        /* Header */
        .admin-header {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-title {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }

        .admin-title span {
            color: #3b82f6;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: #fff;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-danger {
            background: #ef4444;
            color: #fff;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Layout */
        .admin-layout {
            display: flex;
            min-height: calc(100vh - 65px);
        }

        /* Sidebar */
        .admin-sidebar {
            width: 240px;
            background: #1e293b;
            border-right: 1px solid #334155;
            padding: 20px 0;
            flex-shrink: 0;
            position: sticky;
            top: 65px;
            height: calc(100vh - 65px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* 自定义滚动条样式 */
        .admin-sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .admin-sidebar::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .admin-sidebar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        .admin-sidebar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            color: #94a3b8;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: #334155;
            color: #fff;
        }

        .nav-item.active {
            background: #3b82f6;
            color: #fff;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        .nav-section {
            padding: 12px 24px 8px;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            color: #fff;
        }

        /* Cards */
        .card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #fff;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
        }

        .stat-label {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #3b82f6;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }

        th {
            font-size: 12px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
        }

        td {
            font-size: 14px;
            color: #e2e8f0;
        }

        tr:hover {
            background: #334155;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-admin {
            background: #3b82f6;
            color: #fff;
        }

        .badge-user {
            background: #334155;
            color: #94a3b8;
        }

        .badge-active {
            background: #22c55e;
            color: #fff;
        }

        .badge-banned {
            background: #ef4444;
            color: #fff;
        }

        /* Form */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #e2e8f0;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px 14px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 14px;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Model Quick Select Buttons */
        .model-quick-btn {
            padding: 4px 10px;
            font-size: 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 4px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
        }

        .model-quick-btn:hover {
            background: #334155;
            color: #e2e8f0;
            border-color: #3b82f6;
        }

        .model-quick-btn:active {
            background: #3b82f6;
            color: #fff;
        }

        /* Model Tags */
        .model-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            font-size: 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 4px;
            color: #94a3b8;
        }

        .model-tag span {
            cursor: pointer;
            transition: color 0.2s;
        }

        .model-tag span:hover {
            color: #3b82f6;
        }

        .model-tag-delete {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            padding: 0 2px;
            transition: color 0.2s;
        }

        .model-tag-delete:hover {
            color: #ef4444;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: relative;
            width: 44px;
            height: 24px;
            background: #334155;
            border-radius: 24px;
            transition: background 0.3s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            left: 3px;
            top: 3px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch input:checked+.toggle-slider {
            background: #22c55e;
        }

        .toggle-switch input:checked+.toggle-slider::before {
            transform: translateX(20px);
        }

        /* Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Login Overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-box {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 24px;
            color: #fff;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .login-btn:hover {
            background: #2563eb;
        }

        .login-link {
            display: block;
            text-align: center;
            margin-top: 16px;
            color: #94a3b8;
            text-decoration: none;
            font-size: 14px;
        }

        .login-link:hover {
            color: #3b82f6;
        }

        /* Tool Item */
        .tool-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .tool-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .tool-info p {
            font-size: 12px;
            color: #94a3b8;
        }

        .tool-actions {
            display: flex;
            gap: 8px;
        }

        /* Category Item - Expandable */
        .category-expandable {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }

        .category-header:hover {
            background: #1e293b;
        }

        .category-header.expanded {
            background: #1e293b;
            border-bottom: 1px solid #334155;
        }

        .category-name {
            flex: 1;
            font-weight: 500;
            color: #fff;
        }

        .category-count {
            font-size: 12px;
            color: #64748b;
            background: #334155;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .expand-icon {
            color: #64748b;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .category-header.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .category-tools {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #0f172a;
        }

        .category-tools.expanded {
            max-height: 2000px;
        }

        .category-tools-inner {
            padding: 12px;
        }

        .category-tool-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s;
        }

        .category-tool-item:last-child {
            margin-bottom: 0;
        }

        .category-tool-item:hover {
            border-color: #3b82f6;
        }

        .category-tool-item.dragging {
            opacity: 0.5;
            border-color: #3b82f6;
            background: #334155;
        }

        .category-tool-item.drag-over {
            border-color: #22c55e;
            background: #1e3a2f;
        }

        .drag-handle {
            color: #64748b;
            cursor: grab;
            font-size: 14px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .tool-item-info {
            flex: 1;
            min-width: 0;
        }

        .tool-item-title {
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tool-item-url {
            font-size: 11px;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tool-item-delete {
            background: transparent;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 16px;
            transition: all 0.2s;
        }

        .tool-item-delete:hover {
            background: #ef4444;
            color: #fff;
        }

        .empty-category {
            text-align: center;
            color: #64748b;
            padding: 20px;
            font-size: 13px;
        }

        /* Legacy Category Item (for backwards compatibility) */
        .category-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: grab;
        }

        .category-item:active {
            cursor: grabbing;
        }

        /* Thought Item */
        .thought-item {
            background: #0f172a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .thought-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .thought-meta {
            font-size: 12px;
            color: #64748b;
        }

        .thought-category {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }

        .thought-category.emotion {
            background: #7c3aed;
            color: #fff;
        }

        .thought-category.advice {
            background: #f59e0b;
            color: #fff;
        }

        .thought-content {
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Alert */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-success {
            background: #166534;
            color: #bbf7d0;
        }

        .alert-error {
            background: #991b1b;
            color: #fecaca;
        }

        /* Tool Card */
        .tool-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }

        .tool-card:hover {
            border-color: #3b82f6;
        }

        .tool-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .tool-card-header h4 {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .tool-card-category {
            display: inline-block;
            padding: 2px 8px;
            background: #3b82f6;
            color: #fff;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }

        .tool-card-desc {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .tool-card-link {
            font-size: 12px;
            color: #3b82f6;
            text-decoration: none;
            word-break: break-all;
        }

        .tool-card-link:hover {
            text-decoration: underline;
        }

        .tool-card-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 12px;
        }

        /* Dynamic Items List */
        .dynamic-items-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .dynamic-item {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            position: relative;
        }

        .dynamic-item:hover {
            border-color: #475569;
        }

        .dynamic-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .dynamic-item-title {
            font-size: 13px;
            font-weight: 600;
            color: #94a3b8;
        }

        .dynamic-item-delete {
            background: transparent;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dynamic-item-delete:hover {
            background: #ef4444;
            color: #fff;
        }

        .dynamic-item .form-group {
            margin-bottom: 12px;
        }

        .dynamic-item .form-group:last-child {
            margin-bottom: 0;
        }

        .dynamic-item .form-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .dynamic-item .form-input,
        .dynamic-item .form-select,
        .dynamic-item .form-textarea {
            font-size: 13px;
            padding: 8px 12px;
        }

        .dynamic-item-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .empty-list-hint {
            text-align: center;
            color: #64748b;
            padding: 20px;
            font-size: 13px;
            background: #0f172a;
            border: 1px dashed #334155;
            border-radius: 8px;
        }

        /* Category Manager Styles */
        .category-manager {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .category-tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .category-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 20px;
            font-size: 13px;
            color: #e2e8f0;
        }

        .category-tag.fixed {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .category-tag-remove {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: #94a3b8;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-tag-remove:hover {
            background: #ef4444;
            color: #fff;
        }

        .category-add-row {
            display: flex;
            gap: 8px;
        }

        .category-add-input {
            flex: 1;
            max-width: 200px;
        }

        /* Collapsible Items Styles */
        .collapsible-list .dynamic-item {
            overflow: hidden;
        }

        .collapsible-list .dynamic-item.collapsed .dynamic-item-body {
            display: none;
        }

        .collapsible-list .dynamic-item-header {
            cursor: pointer;
            user-select: none;
        }

        .collapsible-list .dynamic-item-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .dynamic-item-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            font-size: 12px;
            color: #64748b;
            transition: transform 0.2s;
        }

        .dynamic-item.collapsed .dynamic-item-toggle {
            transform: rotate(-90deg);
        }

        .dynamic-item-preview {
            font-size: 12px;
            color: #64748b;
            margin-left: 8px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dynamic-item-body {
            padding-top: 12px;
            border-top: 1px solid #334155;
            margin-top: 12px;
        }

        /* Settings Tab Styles */
        .settings-tab-btn.active {
            background: #3b82f6 !important;
            color: #fff !important;
        }

        .settings-tab-btn:hover:not(.active) {
            background: #334155 !important;
            color: #fff !important;
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
        }

        /* Workflow Context Menu */
        .workflow-context-menu {
            position: fixed;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 4px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 160px;
            z-index: 10000;
            display: none;
            pointer-events: auto;
            /* 确保可以点击 */
        }

        .workflow-context-menu-item {
            padding: 8px 16px;
            color: #e2e8f0;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .workflow-context-menu-item:hover {
            background: #334155;
        }

        .workflow-context-menu-item.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .workflow-context-menu-divider {
            height: 1px;
            background: #334155;
            margin: 4px 0;
        }

        /* Workflow Card Styles */
        .workflow-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .workflow-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .workflow-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .workflow-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin: 0 0 4px 0;
        }

        .workflow-card-desc {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .workflow-card-preview {
            width: 100%;
            height: 120px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .workflow-card-preview-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scale(0.15);
            transform-origin: 0 0;
        }

        .workflow-card-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 12px;
        }

        .workflow-card-actions {
            display: flex;
            gap: 8px;
        }

        .workflow-card-actions button {
            flex: 1;
        }

        .empty-workflows {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-workflows svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <!-- Login Overlay (默认隐藏) -->
    <div class="login-overlay hidden" id="login-overlay">
        <div class="login-box">
            <h2 class="login-title">管理员登录</h2>
            <div id="login-alert"></div>
            <div class="form-group">
                <label class="form-label">邮箱</label>
                <input type="email" class="form-input" id="login-email" placeholder="请输入管理员邮箱">
            </div>
            <div class="form-group">
                <label class="form-label">密码</label>
                <input type="password" class="form-input" id="login-password" placeholder="请输入密码">
            </div>
            <button class="login-btn" onclick="performLogin()">登录后台</button>
            <a href="/" class="login-link">← 返回首页</a>
        </div>
    </div>

    <!-- Admin Panel (默认显示,加载中状态) -->
    <div id="admin-panel">
        <header class="admin-header">
            <div class="admin-title">
                <a href="/tools.html"
                    style="color: #94a3b8; text-decoration: none; font-size: 14px; margin-right: 20px; transition: color 0.2s;"
                    onmouseover="this.style.color='#3b82f6'" onmouseout="this.style.color='#94a3b8'">← 返回主页</a>
                <span id="admin-site-name">Aethrix | 以太夜</span> <span>管理后台</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.location.href='/tools.html'">返回主页</button>
                <button class="btn btn-secondary" onclick="switchAccount()">切换账号</button>
                <button class="btn btn-danger" onclick="logout()">退出登录</button>
            </div>
        </header>

        <div class="admin-layout">
            <nav class="admin-sidebar">
                <div class="nav-section">概览</div>
                <a class="nav-item active" data-section="dashboard" onclick="showSection('dashboard')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>
                    仪表盘
                </a>

                <div class="nav-section">内容管理</div>
                <a class="nav-item" data-section="tools" onclick="showSection('tools')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
                    </svg>
                    AI工具管理
                </a>
                <a class="nav-item" data-section="categories" onclick="showSection('categories')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6" />
                        <line x1="8" y1="12" x2="21" y2="12" />
                        <line x1="8" y1="18" x2="21" y2="18" />
                        <line x1="3" y1="6" x2="3.01" y2="6" />
                        <line x1="3" y1="12" x2="3.01" y2="12" />
                        <line x1="3" y1="18" x2="3.01" y2="18" />
                    </svg>
                    分类管理
                </a>
                <a class="nav-item" data-section="workshop" onclick="showSection('workshop')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 2 7 12 12 22 7 12 2" />
                        <polyline points="2 17 12 22 22 17" />
                        <polyline points="2 12 12 17 22 12" />
                    </svg>
                    AI开发工坊
                </a>
                <a class="nav-item" data-section="tutorials" onclick="showSection('tutorials')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                    </svg>
                    教程/案例
                </a>
                <a class="nav-item" data-section="apis" onclick="showSection('apis')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 20V10" />
                        <path d="M12 20V4" />
                        <path d="M6 20v-6" />
                    </svg>
                    API集合
                </a>
                <a class="nav-item" data-section="trends" onclick="showSection('trends')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                        <polyline points="17 6 23 6 23 12" />
                    </svg>
                    热点趋势
                </a>
                <a class="nav-item" data-section="solo" onclick="showSection('solo')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg>
                    一人公司
                </a>
                <a class="nav-item" data-section="ai-rankings" onclick="showSection('ai-rankings')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
                    </svg>
                    AI排行榜
                </a>
                <a class="nav-item" data-section="thoughts" onclick="showSection('thoughts')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                    </svg>
                    匿名思想墙
                </a>

                <div class="nav-section">系统</div>
                <a class="nav-item" data-section="users" onclick="showSection('users')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                    用户管理
                </a>
                <a class="nav-item" data-section="settings" onclick="showSection('settings')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3" />
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                    </svg>
                    站点设置
                </a>
            </nav>

            <main class="admin-main">
                <!-- Dashboard Section -->
                <div class="section active" id="section-dashboard">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
                        <h1 class="page-title" style="margin-bottom:0;">仪表盘</h1>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span id="last-refresh-time" style="font-size:12px;color:#64748b;">自动刷新中...</span>
                            <button class="btn btn-secondary" onclick="loadDashboard()"
                                style="padding:6px 12px;font-size:12px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" style="vertical-align:middle;margin-right:4px;">
                                    <path d="M23 4v6h-6" />
                                    <path d="M1 20v-6h6" />
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                                </svg>
                                刷新
                            </button>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">注册用户数</div>
                            <div class="stat-value" id="stat-users">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">AI工具点击</div>
                            <div class="stat-value" id="stat-clicks">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">热点趋势查看</div>
                            <div class="stat-value" id="stat-views">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">思想集帖子</div>
                            <div class="stat-value" id="stat-thoughts">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">同时在线人数</div>
                            <div class="stat-value" id="stat-online">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">站点收藏数</div>
                            <div class="stat-value" id="stat-bookmarks">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">最近登录用户</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>用户</th>
                                        <th>最后登录</th>
                                        <th>登录次数</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-users"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tools Section -->
                <div class="section" id="section-tools">
                    <h1 class="page-title">AI工具管理</h1>

                    <!-- Alert container -->
                    <div id="tools-alert"></div>

                    <!-- Search Tool -->
                    <div class="card" style="margin-bottom:20px;">
                        <h3 class="card-title">搜索工具</h3>
                        <div class="form-group" style="margin-bottom:0;">
                            <input type="text" class="form-input" id="tool-search-input" placeholder="输入工具名称搜索..."
                                oninput="searchTools(this.value)">
                        </div>
                        <div id="tool-search-results" style="margin-top:12px;display:none;">
                            <!-- Search results will be displayed here -->
                        </div>
                    </div>

                    <!-- Add Tool Form -->
                    <div class="card">
                        <h3 class="card-title" id="tool-form-title">添加新工具</h3>
                        <input type="hidden" id="edit-tool-id" value="">
                        <div class="form-group">
                            <label class="form-label">大标题 <span style="color:#ef4444;">*</span></label>
                            <input type="text" class="form-input" id="tool-title" placeholder="如: ChatGPT">
                            <div class="form-error" id="tool-title-error"
                                style="color:#ef4444;font-size:12px;margin-top:4px;display:none;"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">介绍</label>
                            <textarea class="form-textarea" id="tool-desc" placeholder="工具简介..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">链接 <span style="color:#ef4444;">*</span></label>
                            <input type="url" class="form-input" id="tool-url" placeholder="https://...">
                            <div class="form-error" id="tool-url-error"
                                style="color:#ef4444;font-size:12px;margin-top:4px;display:none;"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Logo URL (可选)</label>
                            <input type="url" class="form-input" id="tool-logo" placeholder="https://... (留空自动获取网站图标)">
                            <div style="font-size:12px;color:#64748b;margin-top:4px;">留空将自动从网站获取图标</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">分类 <span style="color:#ef4444;">*</span></label>
                            <select class="form-select" id="tool-category">
                                <!-- Categories will be loaded dynamically -->
                            </select>
                        </div>
                        <div style="display:flex;gap:12px;">
                            <button class="btn btn-primary" onclick="saveTool()">保存工具</button>
                            <button class="btn btn-secondary" id="cancel-edit-btn" onclick="cancelEdit()"
                                style="display:none;">取消编辑</button>
                        </div>
                    </div>

                    <!-- Tools List -->
                    <div class="card">
                        <h3 class="card-title">已添加的工具 (<span id="tools-count">0</span>)</h3>
                        <div id="tools-list">
                            <div style="text-align:center;color:#64748b;padding:20px;">加载中...</div>
                        </div>
                    </div>
                </div>

                <!-- Categories Section -->
                <div class="section" id="section-categories">
                    <h1 class="page-title">分类管理</h1>

                    <!-- Alert container -->
                    <div id="categories-alert"></div>

                    <div class="card">
                        <h3 class="card-title">当前分类 (<span id="categories-count">0</span>个)</h3>
                        <p style="font-size:13px;color:#64748b;margin-bottom:16px;">点击分类展开查看工具列表，拖拽工具可调整顺序</p>
                        <div id="categories-list">
                            <div style="text-align:center;color:#64748b;padding:20px;">加载中...</div>
                        </div>
                    </div>
                </div>

                <!-- Apps Section -->
                <div class="section" id="section-apps">
                    <h1 class="page-title">个人App/产品管理</h1>

                    <!-- Alert container -->
                    <div id="apps-alert"></div>

                    <!-- Tab Navigation -->
                    <div class="tab-nav" style="display:flex;gap:0;margin-bottom:20px;border-bottom:1px solid #334155;">
                        <button class="tab-btn active" id="tab-apps" onclick="switchAppsTab('apps')"
                            style="padding:12px 24px;background:transparent;border:none;color:#fff;font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid #3b82f6;">App</button>
                        <button class="tab-btn" id="tab-products" onclick="switchAppsTab('products')"
                            style="padding:12px 24px;background:transparent;border:none;color:#94a3b8;font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;">产品</button>
                    </div>

                    <!-- Apps Tab Content -->
                    <div id="apps-tab-content">
                        <!-- Add App Form -->
                        <div class="card">
                            <h3 class="card-title" id="app-form-title">添加新App</h3>
                            <input type="hidden" id="edit-app-id" value="">
                            <div class="form-group">
                                <label class="form-label">标题 <span style="color:#ef4444;">*</span></label>
                                <input type="text" class="form-input" id="app-title" placeholder="如: Rocket.Chat">
                            </div>
                            <div class="form-group">
                                <label class="form-label">介绍</label>
                                <textarea class="form-textarea" id="app-desc" placeholder="App简介..."
                                    rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">端口链接 <span style="color:#ef4444;">*</span></label>
                                <input type="text" class="form-input" id="app-port"
                                    placeholder="如: http://localhost:4001">
                            </div>
                            <div class="form-group">
                                <label class="form-label">标签</label>
                                <input type="text" class="form-input" id="app-tags" placeholder="用逗号分隔，如: 聊天, 自托管">
                                <p style="font-size:12px;color:#64748b;margin-top:4px;">多个标签用逗号分隔</p>
                            </div>
                            <div style="display:flex;gap:12px;">
                                <button class="btn btn-primary" onclick="saveApp()">保存App</button>
                                <button class="btn btn-secondary" id="cancel-app-edit-btn" onclick="cancelAppEdit()"
                                    style="display:none;">取消编辑</button>
                            </div>
                        </div>

                        <!-- Apps List -->
                        <div class="card">
                            <h3 class="card-title">已添加的App (<span id="apps-count">0</span>)</h3>
                            <div id="apps-list">
                                <div style="text-align:center;color:#64748b;padding:20px;">加载中...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Products Tab Content -->
                    <div id="products-tab-content" style="display:none;">
                        <!-- Add Product Form -->
                        <div class="card">
                            <h3 class="card-title" id="product-form-title">添加新产品</h3>
                            <input type="hidden" id="edit-product-id" value="">
                            <div class="form-group">
                                <label class="form-label">名称 <span style="color:#ef4444;">*</span></label>
                                <input type="text" class="form-input" id="product-title" placeholder="如: n8n工作流模板">
                            </div>
                            <div class="form-group">
                                <label class="form-label">介绍</label>
                                <textarea class="form-textarea" id="product-desc" placeholder="产品简介..."
                                    rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">上传文件</label>
                                <input type="file" class="form-input" id="product-file"
                                    accept=".json,.txt,.yaml,.yml,.xml,.csv,.md,.js,.py,.sh,.bat,.ps1,.zip"
                                    style="padding:8px;">
                                <p style="font-size:12px;color:#64748b;margin-top:4px;">支持: JSON, TXT, YAML, XML, CSV,
                                    MD, JS, PY, SH, BAT, PS1, ZIP (最大10MB)</p>
                                <div id="current-file-info"
                                    style="display:none;margin-top:8px;padding:8px;background:#1e293b;border-radius:4px;">
                                    <span id="current-file-name" style="color:#3b82f6;"></span>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeProductFile()"
                                        style="margin-left:8px;">删除文件</button>
                                </div>
                            </div>
                            <div style="display:flex;gap:12px;">
                                <button class="btn btn-primary" onclick="saveProduct()">保存产品</button>
                                <button class="btn btn-secondary" id="cancel-product-edit-btn"
                                    onclick="cancelProductEdit()" style="display:none;">取消编辑</button>
                            </div>
                        </div>

                        <!-- Products List -->
                        <div class="card">
                            <h3 class="card-title">已添加的产品 (<span id="products-count">0</span>)</h3>
                            <div id="products-list">
                                <div style="text-align:center;color:#64748b;padding:20px;">加载中...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tutorials Section -->
                <div class="section" id="section-tutorials">
                    <h1 class="page-title">教程/案例管理</h1>

                    <!-- Alert container -->
                    <div id="tutorials-alert"></div>

                    <!-- Add Tutorial Form -->
                    <div class="card">
                        <h3 class="card-title" id="tutorial-form-title">添加新教程/案例</h3>
                        <input type="hidden" id="edit-tutorial-id" value="">
                        <div class="form-group">
                            <label class="form-label">标题 <span style="color:#ef4444;">*</span></label>
                            <input type="text" class="form-input" id="tutorial-title"
                                placeholder="如: Prompt Engineering Guide">
                        </div>
                        <div class="form-group">
                            <label class="form-label">介绍</label>
                            <textarea class="form-textarea" id="tutorial-desc" placeholder="教程简介..."
                                rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">链接 <span style="color:#ef4444;">*</span></label>
                            <input type="url" class="form-input" id="tutorial-url" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">分类</label>
                            <select class="form-input" id="tutorial-category">
                                <option value="">选择分类...</option>
                                <option value="总榜教程">总榜教程</option>
                                <option value="AI聊天教程">AI聊天教程</option>
                                <option value="AI搜索教程">AI搜索教程</option>
                                <option value="AI音乐教程">AI音乐教程</option>
                                <option value="AI语音教程">AI语音教程</option>
                                <option value="AI智能体教程">AI智能体教程</option>
                                <option value="AI数字人教程">AI数字人教程</option>
                                <option value="AI办公教程">AI办公教程</option>
                                <option value="AI设计教程">AI设计教程</option>
                                <option value="AI翻译教程">AI翻译教程</option>
                                <option value="AI数据分析教程">AI数据分析教程</option>
                                <option value="AI 3D教程">AI 3D教程</option>
                                <option value="AI编程教程">AI编程教程</option>
                                <option value="AI生图教程">AI生图教程</option>
                                <option value="AI视频教程">AI视频教程</option>
                                <option value="AI写作教程">AI写作教程</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">标签</label>
                            <input type="text" class="form-input" id="tutorial-tags" placeholder="用逗号分隔，如: 提示词, 教程">
                        </div>
                        <div style="display:flex;gap:12px;">
                            <button class="btn btn-primary" onclick="saveTutorial()">保存</button>
                            <button class="btn btn-secondary" id="cancel-tutorial-edit-btn"
                                onclick="cancelTutorialEdit()" style="display:none;">取消编辑</button>
                        </div>
                    </div>

                    <!-- Tutorials List with Filter -->
                    <div class="card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                            <h3 class="card-title" style="margin:0;">已添加的教程/案例 (<span id="tutorials-count">0</span>)
                            </h3>
                            <select class="form-input" id="tutorial-filter" onchange="filterTutorials()"
                                style="width:200px;">
                                <option value="">全部分类</option>
                                <option value="总榜教程">总榜教程</option>
                                <option value="AI聊天教程">AI聊天教程</option>
                                <option value="AI搜索教程">AI搜索教程</option>
                                <option value="AI音乐教程">AI音乐教程</option>
                                <option value="AI语音教程">AI语音教程</option>
                                <option value="AI智能体教程">AI智能体教程</option>
                                <option value="AI数字人教程">AI数字人教程</option>
                                <option value="AI办公教程">AI办公教程</option>
                                <option value="AI设计教程">AI设计教程</option>
                                <option value="AI翻译教程">AI翻译教程</option>
                                <option value="AI数据分析教程">AI数据分析教程</option>
                                <option value="AI 3D教程">AI 3D教程</option>
                                <option value="AI编程教程">AI编程教程</option>
                                <option value="AI生图教程">AI生图教程</option>
                                <option value="AI视频教程">AI视频教程</option>
                                <option value="AI写作教程">AI写作教程</option>
                            </select>
                        </div>
                        <div id="tutorials-list">
                            <div style="text-align:center;color:#64748b;padding:20px;">加载中...</div>
                        </div>
                    </div>
                </div>

                <!-- Workshop Section (AI 开发工坊管理) -->
                <div class="section" id="section-workshop">
                    <h1 class="page-title">AI 开发工坊管理</h1>

                    <!-- Alert container -->
                    <div id="workshop-alert"></div>

                    <!-- Add Workshop Item Form -->
                    <div class="card">
                        <h3 class="card-title" id="workshop-form-title">添加新工坊卡片</h3>
                        <input type="hidden" id="edit-workshop-id" value="">
                        <div class="form-group">
                            <label class="form-label">标题 <span style="color:#ef4444;">*</span></label>
                            <input type="text" class="form-input" id="workshop-title" placeholder="如: 日报工作流">
                        </div>
                        <div class="form-group">
                            <label class="form-label">介绍</label>
                            <textarea class="form-textarea" id="workshop-desc" placeholder="卡片简介..."
                                rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">分类 <span style="color:#ef4444;">*</span></label>
                            <select class="form-select" id="workshop-category">
                                <option value="">选择分类...</option>
                                <option value="n8n">n8n 工作流</option>
                                <option value="dify">Dify 应用</option>
                                <option value="coze">Coze 智能体</option>
                                <option value="skill">Skill 组件库</option>
                                <option value="prompt">提示词工坊</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">文件名 (可选)</label>
                            <input type="text" class="form-input" id="workshop-filename" placeholder="如: 日报工作流.json">
                            <div style="font-size:12px;color:#64748b;margin-top:4px;">工作流/应用文件名，留空则使用URL</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">链接URL (可选)</label>
                            <input type="text" class="form-input" id="workshop-url" placeholder="https://...">
                            <div style="font-size:12px;color:#64748b;margin-top:4px;">外部链接，如果没有本地文件则使用此链接</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">标签</label>
                            <input type="text" class="form-input" id="workshop-tags"
                                placeholder="用逗号分隔，如: AI Agent, Notion, 微信">
                        </div>
                        <div style="display:flex;gap:12px;">
                            <button class="btn btn-primary" onclick="saveWorkshopItem()">保存</button>
                            <button class="btn btn-secondary" id="cancel-workshop-edit-btn"
                                onclick="cancelWorkshopEdit()" style="display:none;">取消编辑</button>
                        </div>
                    </div>

                    <!-- Workshop Items List with Filter -->
                    <div class="card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                            <h3 class="card-title" style="margin:0;">已添加的工坊卡片 (<span id="workshop-count">0</span>)</h3>
                            <select class="form-select" id="workshop-filter" onchange="filterWorkshopItems()"
                                style="width:200px;">
                                <option value="">全部分类</option>
                                <option value="n8n">n8n 工作流</option>
                                <option value="dify">Dify 应用</option>
                                <option value="coze">Coze 智能体</option>
                                <option value="skill">Skill 组件库</option>
                                <option value="prompt">提示词工坊</option>
                            </select>
                        </div>
                        <div id="workshop-list">
                            <div style="text-align:center;color:#64748b;padding:20px;">加载中...</div>
                        </div>
                    </div>
                </div>

                <!-- APIs Section -->
                <div class="section" id="section-apis">
                    <h1 class="page-title">API集合管理</h1>

                    <!-- Alert container -->
                    <div id="apis-alert"></div>

                    <!-- Add API Form -->
                    <div class="card">
                        <h3 class="card-title" id="api-form-title">添加新API</h3>
                        <input type="hidden" id="edit-api-id" value="">
                        <div class="form-group">
                            <label class="form-label">标题 <span style="color:#ef4444;">*</span></label>
                            <input type="text" class="form-input" id="api-title" placeholder="如: OpenAI API">
                        </div>
                        <div class="form-group">
                            <label class="form-label">介绍</label>
                            <textarea class="form-textarea" id="api-desc" placeholder="API简介..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">链接 <span style="color:#ef4444;">*</span></label>
                            <input type="url" class="form-input" id="api-url" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">主分类</label>
                            <select class="form-input" id="api-category">
                                <option value="">选择主分类...</option>
                                <option value="官方API">官方API</option>
                                <option value="API聚合平台">API聚合平台</option>
                                <option value="国内平台">国内平台</option>
                                <option value="开源项目">开源项目</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">子分类</label>
                            <input type="text" class="form-input" id="api-subcategory" placeholder="如: 大语言模型, 图像生成">
                        </div>
                        <div class="form-group">
                            <label class="form-label">定价模式</label>
                            <select class="form-input" id="api-pricing">
                                <option value="free">免费 (Free)</option>
                                <option value="freemium">免费增值 (Freemium)</option>
                                <option value="paid">付费 (Paid)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">标签</label>
                            <input type="text" class="form-input" id="api-tags" placeholder="用逗号分隔，如: GPT, 官方">
                        </div>
                        <div style="display:flex;gap:12px;">
                            <button class="btn btn-primary" onclick="saveApi()">保存</button>
                            <button class="btn btn-secondary" id="cancel-api-edit-btn" onclick="cancelApiEdit()"
                                style="display:none;">取消编辑</button>
                        </div>
                    </div>

                    <!-- APIs List with Filter -->
                    <div class="card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                            <h3 class="card-title" style="margin:0;">已添加的API (<span id="apis-count">0</span>)</h3>
                            <select class="form-input" id="api-filter" onchange="filterApis()" style="width:200px;">
                                <option value="">全部分类</option>
                                <option value="官方API">官方API</option>
                                <option value="API聚合平台">API聚合平台</option>
                                <option value="国内平台">国内平台</option>
                                <option value="开源项目">开源项目</option>
                            </select>
                        </div>
                        <div id="apis-list">
                            <div style="text-align:center;color:#64748b;padding:20px;">加载中...</div>
                        </div>
                    </div>
                </div>

                <!-- Trends Section -->
                <div class="section" id="section-trends">
                    <h1 class="page-title">热点趋势管理</h1>

                    <!-- Alert container -->
                    <div id="trends-alert"></div>

                    <!-- Add Trend Form -->
                    <div class="card">
                        <h3 class="card-title" id="trend-form-title">添加新热点</h3>
                        <input type="hidden" id="edit-trend-id" value="">
                        <div class="form-group">
                            <label class="form-label">标题 <span style="color:#ef4444;">*</span></label>
                            <input type="text" class="form-input" id="trend-title" placeholder="如: Product Hunt">
                        </div>
                        <div class="form-group">
                            <label class="form-label">介绍</label>
                            <textarea class="form-textarea" id="trend-desc" placeholder="热点简介..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">链接 <span style="color:#ef4444;">*</span></label>
                            <input type="url" class="form-input" id="trend-url" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">标签</label>
                            <input type="text" class="form-input" id="trend-tags" placeholder="用逗号分隔，如: 产品, 发现">
                        </div>
                        <div style="display:flex;gap:12px;">
                            <button class="btn btn-primary" onclick="saveTrend()">保存</button>
                            <button class="btn btn-secondary" id="cancel-trend-edit-btn" onclick="cancelTrendEdit()"
                                style="display:none;">取消编辑</button>
                        </div>
                    </div>

                    <!-- Trends List -->
                    <div class="card">
                        <h3 class="card-title">已添加的热点 (<span id="trends-count">0</span>)</h3>
                        <div id="trends-list">
                            <div style="text-align:center;color:#64748b;padding:20px;">加载中...</div>
                        </div>
                    </div>
                </div>

                <!-- Thoughts Section -->
                <div class="section" id="section-thoughts">
                    <h1 class="page-title">匿名思想墙管理</h1>
                    <div class="card">
                        <h3 class="card-title">所有帖子</h3>
                        <!-- 筛选按钮 -->
                        <div style="display:flex;gap:8px;margin-bottom:16px;">
                            <button class="btn btn-secondary thoughts-admin-filter active" data-filter="all"
                                onclick="filterAdminThoughts('all')">全部</button>
                            <button class="btn btn-secondary thoughts-admin-filter" data-filter="emotion"
                                onclick="filterAdminThoughts('emotion')">情绪分享</button>
                            <button class="btn btn-secondary thoughts-admin-filter" data-filter="advice"
                                onclick="filterAdminThoughts('advice')">给作者建议</button>
                        </div>
                        <div id="thoughts-list"></div>
                    </div>
                </div>

                <!-- Solo Section -->
                <div class="section" id="section-solo">
                    <h1 class="page-title">一人公司</h1>
                    <div class="card">
                        <h3 class="card-title">编辑内容</h3>
                        <div class="form-group">
                            <label class="form-label">简介内容</label>
                            <textarea class="form-textarea" id="solo-content" rows="3"
                                placeholder="输入一人公司介绍内容..."></textarea>
                        </div>
                    </div>

                    <!-- Workflow List -->
                    <div class="card" style="margin-top: 16px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 class="card-title" style="margin: 0;">工作流列表 (<span id="workflows-count">0</span>)</h3>
                            <button class="btn btn-primary btn-sm" onclick="createNewWorkflow()">+ 创建新工作流</button>
                        </div>
                        <div id="workflows-list"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                            <!-- Workflow cards will be rendered here -->
                        </div>
                    </div>

                    <!-- Workflow Editor (Hidden by default) -->
                    <div class="card" id="workflow-editor-card" style="margin-top: 16px; display: none;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 class="card-title" style="margin: 0;">编辑工作流: <span
                                    id="current-workflow-title">未命名</span></h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span id="workflow-save-status" style="font-size: 12px; color: #64748b;"></span>
                                <button class="btn btn-secondary btn-sm" onclick="closeWorkflowEditor()">返回列表</button>
                                <button class="btn btn-primary btn-sm" onclick="saveCurrentWorkflow()">保存工作流</button>
                            </div>
                        </div>

                        <!-- Workflow Metadata -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">工作流标题</label>
                                <input type="text" class="form-input" id="workflow-edit-title" placeholder="输入标题...">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">工作流介绍</label>
                                <input type="text" class="form-input" id="workflow-edit-description"
                                    placeholder="输入介绍...">
                            </div>
                        </div>

                        <div
                            style="font-size: 12px; color: #64748b; margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: space-between; align-items: center;">
                            <span>💡 提示：右键画布添加节点 | 右键节点编辑 | 拖拽连接点创建连线 | Ctrl+Z撤销</span>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button onclick="addWorkflowNode()"
                                    style="padding: 6px 10px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">添加节点</button>
                                <button onclick="autoArrangeNodes()"
                                    style="padding: 6px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">自动整理</button>
                                <button onclick="centerWorkflowView()"
                                    style="padding: 6px 10px; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">居中视图</button>
                                <button onclick="resetWorkflowView()"
                                    style="padding: 6px 10px; background: #475569; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">重置视图</button>
                                <button onclick="saveCurrentWorkflow()"
                                    style="padding: 6px 10px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">保存工作流</button>
                            </div>
                        </div>

                        <!-- Workflow Canvas -->
                        <div id="workflow-canvas-container"
                            style="position: relative; width: 100%; min-height: 800px; height: auto; background: #0f172a; border: 1px solid #334155; border-radius: 8px; overflow: hidden;">
                            <div id="workflow-canvas"
                                style="position: relative; width: 100%; min-height: 800px; background-image: radial-gradient(circle, #1e293b 1px, transparent 1px); background-size: 20px 20px; cursor: grab; will-change: transform; z-index: 1;">
                                <!-- Nodes will be rendered here -->
                            </div>
                            <svg id="workflow-connections"
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3;"></svg>
                        </div>

                        <!-- Context Menu -->
                        <div id="workflow-context-menu" class="workflow-context-menu">
                            <!-- Menu items will be dynamically generated -->
                        </div>
                    </div>

                    <!-- Node Editor Modal -->
                    <div id="node-editor-modal"
                        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center;">
                        <div
                            style="background: #1e293b; border-radius: 12px; padding: 24px; width: 90%; max-width: 600px; border: 1px solid #334155;">
                            <h3 style="color: #e2e8f0; margin: 0 0 20px 0;">编辑节点</h3>
                            <div class="form-group">
                                <label class="form-label">标题</label>
                                <input type="text" class="form-input" id="node-edit-title" placeholder="工具名称">
                            </div>
                            <div class="form-group">
                                <label class="form-label">简短描述</label>
                                <input type="text" class="form-input" id="node-edit-description" placeholder="一句话描述">
                            </div>
                            <div class="form-group">
                                <label class="form-label">详细内容</label>
                                <textarea class="form-textarea" id="node-edit-content" rows="3"
                                    placeholder="详细介绍"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">链接</label>
                                <input type="url" class="form-input" id="node-edit-link" placeholder="https://...">
                            </div>
                            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                                <button class="btn btn-danger" onclick="deleteCurrentNode()">删除节点</button>
                                <button class="btn btn-secondary" onclick="closeNodeEditor()">取消</button>
                                <button class="btn btn-primary" onclick="saveNodeEdit()">保存</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Rankings Section -->
                <div class="section" id="section-ai-rankings">
                    <h1 class="page-title">AI排行榜管理</h1>

                    <!-- Alert container -->
                    <div id="ai-rankings-alert"></div>

                    <!-- Search Rankings -->
                    <div class="card" style="margin-bottom:20px;">
                        <h3 class="card-title">搜索排行榜</h3>
                        <div class="form-group" style="margin-bottom:0;">
                            <input type="text" class="form-input" id="rankings-search-input" placeholder="输入榜单名称搜索..."
                                oninput="searchRankings(this.value)">
                        </div>
                        <div id="rankings-search-results" style="margin-top:12px;display:none;">
                            <!-- Search results will be displayed here -->
                        </div>
                    </div>

                    <!-- Add New Board Form -->
                    <div class="card">
                        <h3 class="card-title">添加新榜</h3>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                            <div class="form-group">
                                <label class="form-label">榜单名称</label>
                                <input type="text" class="form-input" id="new-board-name" placeholder="如: 编程助手榜">
                            </div>
                            <div class="form-group">
                                <label class="form-label">榜单描述（可选）</label>
                                <input type="text" class="form-input" id="new-board-desc" placeholder="榜单简介...">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addNewBoard()">创建新榜</button>
                    </div>

                    <!-- Add Item to Board Form -->
                    <div class="card">
                        <h3 class="card-title">添加AI项目</h3>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                            <div class="form-group">
                                <label class="form-label">选择榜单</label>
                                <select class="form-select" id="ranking-board-select" onchange="onBoardSelectChange()">
                                    <option value="">选择榜单...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">选择层级</label>
                                <select class="form-select" id="ranking-tier-select">
                                    <option value="">选择层级...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">AI名称</label>
                                <input type="text" class="form-input" id="ranking-item-name" placeholder="如: ChatGPT">
                            </div>
                            <div class="form-group">
                                <label class="form-label">访问链接</label>
                                <input type="text" class="form-input" id="ranking-item-link" placeholder="https://...">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">图片（可选）</label>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <input type="file" id="ranking-item-image-file" accept="image/*" style="display:none;"
                                    onchange="uploadRankingImage(this)">
                                <button class="btn btn-secondary"
                                    onclick="document.getElementById('ranking-item-image-file').click()">选择图片</button>
                                <input type="text" class="form-input" id="ranking-item-image"
                                    placeholder="图片URL（上传后自动填充）" style="flex:1;">
                                <img id="ranking-image-preview" src="" alt=""
                                    style="width:40px;height:40px;border-radius:6px;object-fit:cover;display:none;">
                            </div>
                            <div style="font-size:12px;color:#94a3b8;margin-top:6px;">
                                💡 提示：不上传图片时，系统会自动从访问链接抓取网站logo
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">描述</label>
                            <textarea class="form-textarea" id="ranking-item-desc" rows="3"
                                placeholder="AI工具描述..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="addRankingItem()">添加项目</button>
                    </div>

                    <!-- Boards Display -->
                    <div id="admin-boards-container"></div>
                </div>

                <!-- Users Section -->
                <div class="section" id="section-users">
                    <h1 class="page-title">用户管理</h1>

                    <!-- Alert container -->
                    <div id="users-alert"></div>

                    <!-- Tab Navigation -->
                    <div class="tab-nav" style="display:flex;gap:0;margin-bottom:20px;border-bottom:1px solid #334155;">
                        <button class="tab-btn active" id="tab-users-list" onclick="switchUsersTab('users-list')"
                            style="padding:12px 24px;background:transparent;border:none;color:#fff;font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid #3b82f6;">注册用户</button>
                        <button class="tab-btn" id="tab-blacklist" onclick="switchUsersTab('blacklist')"
                            style="padding:12px 24px;background:transparent;border:none;color:#94a3b8;font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;">黑名单</button>
                    </div>

                    <!-- Users List Tab -->
                    <div id="users-list-tab-content">
                        <div class="card">
                            <h3 class="card-title">注册用户列表</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>昵称</th>
                                            <th>邮箱</th>
                                            <th>注册时间</th>
                                            <th>最后登录</th>
                                            <th>登录次数</th>
                                            <th>角色</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Blacklist Tab -->
                    <div id="blacklist-tab-content" style="display:none;">
                        <div class="card">
                            <h3 class="card-title">黑名单列表 (<span id="blacklist-count">0</span>)</h3>
                            <p style="font-size:13px;color:#64748b;margin-bottom:16px;">这些用户已被删除并禁止登录。点击"恢复"可允许其重新注册。
                            </p>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>昵称</th>
                                            <th>邮箱</th>
                                            <th>UID</th>
                                            <th>注销时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="blacklist-table"></tbody>
                                </table>
                            </div>
                            <div id="blacklist-empty"
                                style="display:none;text-align:center;color:#64748b;padding:40px;">
                                暂无黑名单用户
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="section" id="section-settings">
                    <h1 class="page-title">站点设置</h1>

                    <!-- Alert container -->
                    <div id="settings-alert"></div>

                    <!-- Settings Tab Navigation -->
                    <div class="settings-tabs"
                        style="display:flex;gap:0;margin-bottom:20px;background:#1e293b;border-radius:8px;overflow:hidden;border:1px solid #334155;">
                        <button class="settings-tab-btn active" data-tab="basic" onclick="switchSettingsTab('basic')"
                            style="flex:1;padding:12px 16px;background:transparent;border:none;color:#94a3b8;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;border-right:1px solid #334155;">
                            <span id="tab-label-basic">基本信息</span>
                        </button>
                        <button class="settings-tab-btn" data-tab="portfolio" onclick="switchSettingsTab('portfolio')"
                            style="flex:1;padding:12px 16px;background:transparent;border:none;color:#94a3b8;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;border-right:1px solid #334155;">
                            <span id="tab-label-portfolio">精选作品</span>
                        </button>
                        <button class="settings-tab-btn" data-tab="services" onclick="switchSettingsTab('services')"
                            style="flex:1;padding:12px 16px;background:transparent;border:none;color:#94a3b8;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;border-right:1px solid #334155;">
                            <span id="tab-label-services">专业服务</span>
                        </button>
                        <button class="settings-tab-btn" data-tab="about" onclick="switchSettingsTab('about')"
                            style="flex:1;padding:12px 16px;background:transparent;border:none;color:#94a3b8;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;border-right:1px solid #334155;">
                            <span id="tab-label-about">关于我们</span>
                        </button>
                        <button class="settings-tab-btn" data-tab="ai-assistant"
                            onclick="switchSettingsTab('ai-assistant')"
                            style="flex:1;padding:12px 16px;background:transparent;border:none;color:#94a3b8;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;">
                            <span id="tab-label-ai-assistant">AI 助手</span>
                        </button>
                    </div>

                    <!-- 基本信息 Tab -->
                    <div class="settings-tab-content active" id="settings-tab-basic">
                        <div class="card">
                            <h3 class="card-title">基本信息</h3>
                            <div class="form-group">
                                <label class="form-label">站点名称</label>
                                <input type="text" class="form-input" id="site-name" value="Aethrix | 以太夜">
                            </div>
                            <div class="form-group">
                                <label class="form-label">浏览器网页名称</label>
                                <input type="text" class="form-input" id="site-browser-title" value="Aethrix | 以太夜"
                                    placeholder="显示在浏览器标签页上的标题">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Slogan</label>
                                <input type="text" class="form-input" id="site-slogan" value="一人打造的 AI 工具导航与自建生态">
                            </div>
                            <div class="form-group">
                                <label class="form-label">SEO 描述</label>
                                <textarea class="form-textarea" id="site-seo"
                                    rows="3">Aethrix | 以太夜 - AI 工具导航平台，聚合最新AI工具、大语言模型、工作流平台等资源</textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">公告 (留空则不显示)</label>
                                <textarea class="form-textarea" id="site-notice" rows="2"
                                    placeholder="输入站点公告..."></textarea>
                            </div>
                        </div>

                        <!-- 页脚设置 -->
                        <div class="card">
                            <h3 class="card-title">页脚设置</h3>
                            <div class="form-group">
                                <label class="form-label">版权信息 (首页)</label>
                                <input type="text" class="form-input" id="footer-copyright"
                                    value="© 2025 Aethrix | 以太夜. 保留所有权利.">
                            </div>
                            <div class="form-group">
                                <label class="form-label">AI工具页页脚</label>
                                <input type="text" class="form-input" id="footer-tools"
                                    value="© 2024 Aethrix | 以太夜. 以太夜漫漫，粒子生生不息">
                            </div>
                            <div class="form-group">
                                <label class="form-label">联系邮箱</label>
                                <input type="email" class="form-input" id="footer-email" value="hello@studio.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">联系电话</label>
                                <input type="text" class="form-input" id="footer-phone" value="" placeholder="请输入联系电话">
                            </div>
                            <div class="form-group">
                                <label class="form-label">地址</label>
                                <input type="text" class="form-input" id="footer-address" value="北京市朝阳区">
                            </div>
                        </div>
                    </div>

                    <!-- 精选作品 Tab -->
                    <div class="settings-tab-content" id="settings-tab-portfolio" style="display:none;">
                        <div class="card">
                            <h3 class="card-title">精选作品</h3>
                            <div class="form-group">
                                <label class="form-label">主标题</label>
                                <input type="text" class="form-input" id="portfolio-title" value="精选作品"
                                    oninput="updateSettingsTabLabel('portfolio', this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">副标题</label>
                                <input type="text" class="form-input" id="portfolio-subtitle" value="展示最新的创意项目和技术实现">
                            </div>
                            <div class="form-group">
                                <label class="form-label">分类管理</label>
                                <div class="category-manager">
                                    <div id="portfolio-categories-list" class="category-tags-list"></div>
                                    <div class="category-add-row">
                                        <input type="text" class="form-input category-add-input" id="new-category-input"
                                            placeholder="输入新分类名称">
                                        <button type="button" class="btn btn-secondary btn-sm"
                                            onclick="addPortfolioCategory()">添加分类</button>
                                    </div>
                                </div>
                                <input type="hidden" id="portfolio-filters" value="全部, AI 工具, 网页设计, 品牌设计">
                            </div>
                            <div class="form-group">
                                <label class="form-label">作品列表</label>
                                <div id="portfolio-items-list" class="dynamic-items-list collapsible-list"></div>
                                <button type="button" class="btn btn-secondary" onclick="addPortfolioItem()"
                                    style="margin-top:8px;">+ 添加作品</button>
                            </div>
                        </div>
                    </div>

                    <!-- 专业服务 Tab -->
                    <div class="settings-tab-content" id="settings-tab-services" style="display:none;">
                        <div class="card">
                            <h3 class="card-title">专业服务</h3>
                            <div class="form-group">
                                <label class="form-label">主标题</label>
                                <input type="text" class="form-input" id="services-title" value="专业服务"
                                    oninput="updateSettingsTabLabel('services', this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">副标题</label>
                                <input type="text" class="form-input" id="services-subtitle" value="提供全方位的数字化解决方案">
                            </div>
                            <div class="form-group">
                                <label class="form-label">服务列表</label>
                                <div id="services-items-list" class="dynamic-items-list collapsible-list"></div>
                                <button type="button" class="btn btn-secondary" onclick="addServiceItem()"
                                    style="margin-top:8px;">+ 添加服务</button>
                            </div>
                        </div>
                    </div>

                    <!-- 关于我们 Tab -->
                    <div class="settings-tab-content" id="settings-tab-about" style="display:none;">
                        <div class="card">
                            <h3 class="card-title">关于我们</h3>
                            <div class="form-group">
                                <label class="form-label">主标题</label>
                                <input type="text" class="form-input" id="about-title" value="关于我们"
                                    oninput="updateSettingsTabLabel('about', this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">副标题</label>
                                <input type="text" class="form-input" id="about-subtitle" value="专注创新与品质的设计团队">
                            </div>
                            <div class="form-group">
                                <label class="form-label">正文内容</label>
                                <textarea class="form-textarea" id="about-content" rows="5"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">团队图片 <span
                                        style="color:#64748b;font-weight:normal;font-size:11px;">（推荐比例 5:4，如 1000×800 或
                                        1200×960）</span></label>
                                <div style="display:flex;gap:8px;align-items:flex-start;">
                                    <input type="text" class="form-input" id="about-image"
                                        placeholder="图片URL (留空则显示默认占位图)" style="flex:1;">
                                    <input type="file" id="about-image-upload" accept="image/*" style="display:none;"
                                        onchange="handleAboutImageUpload(this)">
                                    <button type="button" class="btn btn-secondary"
                                        onclick="document.getElementById('about-image-upload').click()"
                                        style="white-space:nowrap;">上传图片</button>
                                </div>
                                <div id="about-image-preview" style="margin-top:8px;"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">统计数据</label>
                                <div id="about-stats-list" class="dynamic-items-list"></div>
                                <button type="button" class="btn btn-secondary" onclick="addStatItem()"
                                    style="margin-top:8px;">+ 添加统计</button>
                            </div>
                        </div>
                    </div>

                    <!-- AI 助手配置 Tab -->
                    <div class="settings-tab-content" id="settings-tab-ai-assistant" style="display:none;">
                        <div class="card">
                            <h3 class="card-title">AI 助手配置</h3>
                            <p style="color:#94a3b8;font-size:13px;margin-bottom:20px;">配置 Aethrix 助手的 AI
                                模型连接参数。助手将使用这些设置与 AI 模型进行对话。</p>

                            <div class="form-group">
                                <label class="form-label">启用 AI 助手</label>
                                <label class="toggle-switch" style="display:flex;align-items:center;gap:12px;">
                                    <input type="checkbox" id="ai-enabled" checked>
                                    <span class="toggle-slider"></span>
                                    <span style="color:#94a3b8;font-size:13px;">开启后，用户可以在首页和工具页使用 AI 助手</span>
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-label">API 端点</label>
                                <input type="text" class="form-input" id="ai-api-endpoint"
                                    placeholder="https://api.openai.com/v1/chat/completions">
                                <span style="color:#64748b;font-size:11px;margin-top:4px;display:block;">支持 OpenAI 兼容的
                                    API 端点</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">模型名称</label>
                                <div style="display:flex;gap:8px;">
                                    <input type="text" class="form-input" id="ai-model-name" placeholder="输入模型名称"
                                        style="flex:1;">
                                    <button type="button" class="btn btn-secondary" onclick="addModelToList()"
                                        style="white-space:nowrap;">
                                        添加模型
                                    </button>
                                </div>
                                <div id="saved-models-list"
                                    style="margin-top:10px;display:flex;flex-wrap:wrap;gap:6px;"></div>
                                <span
                                    style="color:#64748b;font-size:11px;margin-top:6px;display:block;">输入模型名称后点击"添加模型"保存，点击模型可快速选择，点击
                                    × 可删除</span>
                            </div>

                            <div class="form-group">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="ai-auto-switch">
                                    <span class="toggle-slider"></span>
                                    <span
                                        style="color:#94a3b8;font-size:13px;margin-left:8px;">自动切换模型（每个模型使用5次后自动切换到下一个）</span>
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-label">API Key</label>
                                <div style="display:flex;gap:8px;">
                                    <input type="password" class="form-input" id="ai-api-key" placeholder="sk-..."
                                        style="flex:1;">
                                    <button type="button" class="btn btn-secondary" onclick="toggleApiKeyVisibility()"
                                        style="white-space:nowrap;">
                                        <span id="api-key-toggle-text">显示</span>
                                    </button>
                                </div>
                                <span style="color:#64748b;font-size:11px;margin-top:4px;display:block;">API
                                    密钥将安全存储在服务器端</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">系统提示词 (可选)</label>
                                <textarea class="form-textarea" id="ai-system-prompt" rows="4"
                                    placeholder="你是 Aethrix 助手，一个友好的 AI 助手..."></textarea>
                                <span style="color:#64748b;font-size:11px;margin-top:4px;display:block;">自定义 AI
                                    助手的角色和行为。留空则使用默认提示词。</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">最大 Token 数</label>
                                <input type="number" class="form-input" id="ai-max-tokens" value="2048" min="100"
                                    max="8192">
                                <span style="color:#64748b;font-size:11px;margin-top:4px;display:block;">AI
                                    回复的最大长度限制</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">温度 (Temperature)</label>
                                <input type="number" class="form-input" id="ai-temperature" value="0.7" min="0" max="2"
                                    step="0.1">
                                <span style="color:#64748b;font-size:11px;margin-top:4px;display:block;">控制回复的随机性，0
                                    为确定性，2 为最随机</span>
                            </div>

                            <div style="display:flex;gap:12px;margin-top:20px;">
                                <button type="button" class="btn btn-secondary" onclick="testAIConnection()">
                                    <span id="test-ai-btn-text">测试连接</span>
                                </button>
                                <div id="ai-test-result"
                                    style="display:flex;align-items:center;color:#94a3b8;font-size:13px;"></div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="saveSettings()" style="margin-bottom:20px;">保存所有设置</button>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Check login status
        async function checkLogin() {
            try {
                // First check backend session
                const res = await fetch('/api/admin/status', { credentials: 'include' });
                const data = await res.json();
                if (data.isAdmin) {
                    // 已登录,确保显示管理面板
                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('admin-panel').classList.remove('hidden');
                    loadDashboard();
                    return;
                }

                // If no backend session, check Firebase auth
                if (window.AuthStateManager) {
                    const user = await window.AuthStateManager.waitForAuthReady(3000);
                    if (user && window.RoleManager.checkAdminStatus(user.email)) {
                        console.log('Firebase 用户已登录，同步后端 session...');

                        // Sync with backend
                        try {
                            const syncRes = await fetch('/api/auth/firebase-sync', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({
                                    email: user.email,
                                    uid: user.uid
                                })
                            });

                            if (syncRes.ok) {
                                console.log('后端 session 同步成功');
                                document.getElementById('login-overlay').classList.add('hidden');
                                document.getElementById('admin-panel').classList.remove('hidden');
                                loadDashboard();
                                return;
                            }
                        } catch (syncError) {
                            console.warn('后端 session 同步异常:', syncError);
                        }
                    }
                }

                // 未登录,显示登录界面
                console.log('未检测到管理员登录,显示登录界面');
                document.getElementById('login-overlay').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
            } catch (e) {
                console.error('检查登录状态失败:', e);
                // 出错时显示登录界面
                document.getElementById('login-overlay').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
            }
        }

        // Login
        async function performLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            console.log('尝试登录:', { email, password: '***' });

            if (!email || !password) {
                showLoginAlert('请输入邮箱和密码', 'error');
                return;
            }

            try {
                console.log('使用 Firebase 登录...');

                // Login with Firebase
                const user = await window.EmailAuth.loginWithEmail(email, password);
                console.log('Firebase 登录成功:', user.email);

                // Check if user is admin
                const isAdmin = window.RoleManager.checkAdminStatus(user.email);

                if (isAdmin) {
                    console.log('用户是管理员，同步后端 session...');

                    // Sync with backend to create admin session
                    try {
                        const syncRes = await fetch('/api/admin/firebase-sync', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({
                                email: user.email,
                                uid: user.uid
                            })
                        });

                        if (syncRes.ok) {
                            console.log('后端 session 同步成功');
                        } else {
                            console.warn('后端 session 同步失败，但继续显示管理面板');
                        }
                    } catch (syncError) {
                        console.warn('后端 session 同步异常:', syncError);
                    }

                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('admin-panel').classList.remove('hidden');
                    loadDashboard();
                } else {
                    console.log('用户不是管理员');
                    showLoginAlert('该账号不是管理员，请使用管理员账号登录', 'error');
                    // Logout non-admin user
                    await window.EmailAuth.logout();
                }
            } catch (error) {
                console.error('登录异常:', error);
                const errorMessage = window.ErrorHandler ?
                    window.ErrorHandler.handleAuthError(error) :
                    error.message || '登录失败';
                showLoginAlert(errorMessage, 'error');
            }
        }

        function showLoginAlert(msg, type) {
            const alert = document.getElementById('login-alert');
            alert.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
        }

        // Logout
        async function logout() {
            try {
                // Logout from Firebase
                const auth = window.FirebaseConfig.getAuth();
                await auth.signOut();

                // Clear auth state
                window.AuthStateManager.clearAuthState();

                // Redirect to home
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
                // Force redirect anyway
                window.location.href = '/';
            }
        }

        // Switch account
        async function switchAccount() {
            try {
                // Logout from Firebase
                const auth = window.FirebaseConfig.getAuth();
                await auth.signOut();

                // Clear auth state
                window.AuthStateManager.clearAuthState();

                // Redirect to login page with switch parameter
                window.location.href = '/auth.html?switch=true';
            } catch (error) {
                console.error('Switch account error:', error);
                // Force redirect anyway
                window.location.href = '/auth.html?switch=true';
            }
        }

        // Show section
        function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('section-' + name).classList.add('active');
            document.querySelector(`[data-section="${name}"]`).classList.add('active');

            // Load section data
            if (name === 'dashboard') loadDashboard();
            if (name === 'users') loadUsers();
            if (name === 'thoughts') loadThoughts();
            if (name === 'solo') loadSoloContent();
            if (name === 'settings') loadSettings();
            if (name === 'tools') {
                loadCategories();
                loadTools();
                allToolsCache = []; // Clear cache to refresh search
            }
            if (name === 'categories') {
                loadCategoriesWithTools();
            }
            if (name === 'apps') {
                loadApps();
            }
            if (name === 'tutorials') {
                loadTutorials();
            }
            if (name === 'apis') {
                loadApis();
            }
            if (name === 'trends') {
                loadTrends();
            }
            if (name === 'ai-rankings') {
                loadAiRankings();
            }
            if (name === 'workshop') {
                loadWorkshopData();
            }
        }

        // Load dashboard
        async function loadDashboard() {
            // Update last refresh time
            const lastRefreshEl = document.getElementById('last-refresh-time');
            if (lastRefreshEl) {
                lastRefreshEl.textContent = '刷新中...';
            }

            // Load metrics
            try {
                const res = await fetch('/api/admin/metrics', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('stat-clicks').textContent = data.metrics?.clicks?.ai_tools || 0;
                    document.getElementById('stat-views').textContent = data.metrics?.views?.trends || 0;
                }
            } catch (e) { }

            // Load users count
            try {
                const res = await fetch('/api/admin/users', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('stat-users').textContent = data.total || 0;

                    // Recent users
                    const recent = data.users
                        .filter(u => u.lastLogin)
                        .sort((a, b) => b.lastLogin - a.lastLogin)
                        .slice(0, 5);

                    document.getElementById('recent-users').innerHTML = recent.map(u => `
                        <tr>
                            <td>${escapeHtml(u.nickname)}</td>
                            <td>${new Date(u.lastLogin).toLocaleString('zh-CN')}</td>
                            <td>${u.loginCount || 0}</td>
                        </tr>
                    `).join('') || '<tr><td colspan="3" style="text-align:center;color:#64748b;">暂无数据</td></tr>';
                }
            } catch (e) { }

            // Load thoughts count
            try {
                const res = await fetch('/api/anonymous-thoughts');
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('stat-thoughts').textContent = data.posts?.length || 0;
                }
            } catch (e) { }

            // Load real-time stats (online users and likes)
            try {
                const res = await fetch('/api/admin/dashboard-stats', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('stat-online').textContent = data.onlineUsers || 0;
                    document.getElementById('stat-bookmarks').textContent = data.bookmarks || 0;
                }
            } catch (e) { }

            // Update last refresh time
            if (lastRefreshEl) {
                lastRefreshEl.textContent = '最后更新: ' + new Date().toLocaleTimeString('zh-CN');
            }
        }

        // Auto-refresh dashboard every 5 seconds when on dashboard section
        let dashboardRefreshInterval = null;
        function startDashboardAutoRefresh() {
            if (dashboardRefreshInterval) clearInterval(dashboardRefreshInterval);
            dashboardRefreshInterval = setInterval(() => {
                const dashboardSection = document.getElementById('section-dashboard');
                if (dashboardSection && dashboardSection.classList.contains('active')) {
                    loadDashboard();
                }
            }, 5000); // Refresh every 5 seconds
        }

        // Start auto-refresh when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Firebase
            try {
                window.FirebaseConfig.initializeFirebase();
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Failed to initialize Firebase:', error);
            }

            // 先检查后端 session,不依赖 Firebase Auth
            console.log('检查管理员登录状态...');
            await checkLogin();

            startDashboardAutoRefresh();
            // Load site name for admin header
            loadAdminSiteName();
        });

        // Load site name for admin header on page load
        async function loadAdminSiteName() {
            try {
                const res = await fetch('/api/settings');
                if (res.ok) {
                    const data = await res.json();
                    const siteName = data.siteName || 'Aethrix | 以太夜';
                    // Update admin header title
                    const adminSiteName = document.getElementById('admin-site-name');
                    if (adminSiteName) {
                        adminSiteName.textContent = siteName;
                    }
                    // Update page title
                    document.title = siteName + ' - 管理后台';
                }
            } catch (error) {
                console.error('Failed to load site name:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('users-table').innerHTML = data.users.map(u => `
                        <tr>
                            <td>${escapeHtml(u.nickname)}</td>
                            <td>${escapeHtml(u.email || '-')}</td>
                            <td>${u.createdAt ? new Date(u.createdAt).toLocaleString('zh-CN') : '-'}</td>
                            <td>${u.lastLogin ? new Date(u.lastLogin).toLocaleString('zh-CN') : '从未'}</td>
                            <td>${u.loginCount || 0}</td>
                            <td><span class="badge ${u.isAdmin ? 'badge-admin' : 'badge-user'}">${u.isAdmin ? '管理员' : '用户'}</span></td>
                            <td style="display:flex;gap:6px;">
                                <button class="btn ${u.isAdmin ? 'btn-secondary' : 'btn-primary'}" style="padding:4px 8px;font-size:12px;" onclick="toggleUserRole('${u.id}', ${!u.isAdmin})">${u.isAdmin ? '设为用户' : '设为管理员'}</button>
                                <button class="btn btn-danger" style="padding:4px 8px;font-size:12px;" onclick="deleteUser('${u.id}', '${escapeHtml(u.nickname)}')">封禁</button>
                            </td>
                        </tr>
                    `).join('') || '<tr><td colspan="7" style="text-align:center;color:#64748b;">暂无用户</td></tr>';
                }
            } catch (e) {
                console.error('Failed to load users:', e);
            }
        }

        // Toggle user role (admin/user)
        async function toggleUserRole(userId, makeAdmin) {
            const action = makeAdmin ? '设为管理员' : '设为普通用户';
            if (!confirm(`确定要将此用户${action}吗？`)) return;

            try {
                const res = await fetch(`/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ isAdmin: makeAdmin })
                });

                const data = await res.json();
                if (res.ok) {
                    showUsersAlert(data.message, 'success');
                    loadUsers(); // Reload user list
                } else {
                    showUsersAlert(data.error || '操作失败', 'error');
                }
            } catch (e) {
                showUsersAlert('网络错误，请重试', 'error');
            }
        }

        // Delete user
        async function deleteUser(userId, nickname) {
            if (!confirm(`确定要封禁用户 "${nickname}" 吗？\n此操作将强制用户下线，禁止其再次登录，并加入黑名单！`)) return;

            try {
                const res = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await res.json();
                if (res.ok) {
                    showUsersAlert(data.message, 'success');
                    loadUsers(); // Reload user list
                } else {
                    showUsersAlert(data.error || '删除失败', 'error');
                }
            } catch (e) {
                showUsersAlert('网络错误，请重试', 'error');
            }
        }

        // Show users alert
        function showUsersAlert(message, type) {
            const alertContainer = document.getElementById('users-alert');
            if (!alertContainer) return;
            alertContainer.innerHTML = `<div class="alert alert-${type}">${escapeHtml(message)}</div>`;
            setTimeout(() => { alertContainer.innerHTML = ''; }, 3000);
        }

        // Current filter for thoughts
        let currentThoughtsFilter = 'all';

        // Filter admin thoughts
        function filterAdminThoughts(filter) {
            currentThoughtsFilter = filter;
            // Update button styles
            document.querySelectorAll('.thoughts-admin-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
                if (btn.dataset.filter === filter) {
                    btn.style.background = '#3b82f6';
                    btn.style.color = '#fff';
                } else {
                    btn.style.background = '#334155';
                    btn.style.color = '#e2e8f0';
                }
            });
            loadThoughts();
        }

        // Load thoughts
        async function loadThoughts() {
            try {
                const res = await fetch('/api/anonymous-thoughts');
                if (res.ok) {
                    const data = await res.json();
                    // Filter posts based on current filter
                    let posts = data.posts || [];
                    if (currentThoughtsFilter !== 'all') {
                        posts = posts.filter(p => p.category === currentThoughtsFilter);
                    }
                    document.getElementById('thoughts-list').innerHTML = posts.map(p => `
                        <div class="thought-item" data-id="${p.id}" data-category="${p.category}">
                            <div class="thought-header">
                                <div>
                                    <span class="thought-meta">${p.date || ''}</span>
                                    <span class="thought-category ${p.category}">${p.category === 'advice' ? '给作者建议' : '情绪分享'}</span>
                                </div>
                                <div>
                                    <button class="btn btn-secondary" style="padding:4px 8px;font-size:12px;" onclick="showReplyForm('${p.id}')">回复</button>
                                    <button class="btn btn-danger" style="padding:4px 8px;font-size:12px;" onclick="deleteThought('${p.id}')">删除</button>
                                </div>
                            </div>
                            <div class="thought-content">${escapeHtml(p.content)}</div>
                            <div class="reply-form" id="reply-form-${p.id}" style="display:none;margin-top:12px;padding:12px;background:#1e293b;border-radius:8px;">
                                <textarea class="form-textarea" id="reply-content-${p.id}" rows="2" placeholder="输入回复内容..." style="margin-bottom:8px;"></textarea>
                                <div style="display:flex;gap:8px;">
                                    <button class="btn btn-primary btn-sm" onclick="submitReply('${p.id}')">发送回复</button>
                                    <button class="btn btn-secondary btn-sm" onclick="hideReplyForm('${p.id}')">取消</button>
                                </div>
                            </div>
                            ${p.comments && p.comments.length > 0 ? `
                                <div style="margin-top:12px;padding-top:12px;border-top:1px solid #334155;">
                                    <div style="font-size:12px;color:#64748b;margin-bottom:8px;">管理员评论 (${p.comments.length})</div>
                                    ${p.comments.map((c, idx) => `
                                        <div style="background:#1e293b;padding:10px 12px;border-radius:6px;margin-bottom:6px;font-size:13px;display:flex;justify-content:space-between;align-items:flex-start;">
                                            <div style="flex:1;">
                                                <div style="color:#94a3b8;font-size:11px;margin-bottom:4px;">${c.date || '管理员回复'}</div>
                                                <div style="color:#e2e8f0;">${escapeHtml(c.content)}</div>
                                            </div>
                                            <button class="btn btn-danger" style="padding:2px 6px;font-size:10px;margin-left:8px;" onclick="deleteComment('${p.id}', ${idx})">删除</button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('') || '<div style="text-align:center;color:#64748b;padding:20px;">暂无内容</div>';
                }
            } catch (e) { }
        }

        // Show reply form
        function showReplyForm(id) {
            document.getElementById(`reply-form-${id}`).style.display = 'block';
            document.getElementById(`reply-content-${id}`).focus();
        }

        // Hide reply form
        function hideReplyForm(id) {
            document.getElementById(`reply-form-${id}`).style.display = 'none';
            document.getElementById(`reply-content-${id}`).value = '';
        }

        // Submit reply
        async function submitReply(id) {
            const content = document.getElementById(`reply-content-${id}`).value.trim();
            if (!content) {
                alert('请输入回复内容');
                return;
            }

            try {
                const res = await fetch(`/api/anonymous-thoughts/${id}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ content })
                });
                if (res.ok) {
                    hideReplyForm(id);
                    loadThoughts();
                } else {
                    const data = await res.json();
                    alert(data.error || '回复失败');
                }
            } catch (e) {
                alert('网络错误，请重试');
            }
        }

        // Delete thought
        async function deleteThought(id) {
            if (!confirm('确定删除？')) return;
            try {
                const res = await fetch(`/api/admin/anonymous-thoughts/${id}`, { method: 'DELETE', credentials: 'include' });
                if (res.ok) {
                    loadThoughts();
                    loadDashboard();
                }
            } catch (e) { }
        }

        // Delete comment
        async function deleteComment(thoughtId, commentIndex) {
            if (!confirm('确定删除此评论？')) return;
            try {
                const res = await fetch(`/api/admin/anonymous-thoughts/${thoughtId}/comments/${commentIndex}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (res.ok) {
                    loadThoughts();
                } else {
                    alert('删除失败');
                }
            } catch (e) {
                alert('网络错误');
            }
        }

        // Load solo content
        let soloBlocks = [];

        // ========== Workflow Editor ==========

        // Multi-workflow support
        let workflowsData = [];
        let currentWorkflowId = null;

        let workflowData = { nodes: [], connections: [] };
        let currentEditingNodeId = null;
        let connectionStart = null;
        let canvasPan = { x: 0, y: 0 };
        let isPanning = false;
        let panStart = { x: 0, y: 0 };
        const GRID_SIZE = 16; // snap spacing for nodes/lines alignment

        // Undo/Redo system
        let historyStack = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;

        // Context menu
        let contextMenuPosition = { x: 0, y: 0 };
        let contextMenuNodeId = null;

        // Selected connection for keyboard delete
        let selectedConnectionIndex = null;
        let selectedNodeId = null;

        // Auto-save timer
        let autoSaveTimer = null;

        // Performance optimization
        let isDraggingNode = false;
        let draggedNodeId = null;
        let canvasInteractionsSetup = false; // 防止重复初始化

        async function loadSoloContent() {
            try {
                const res = await fetch('/api/content');
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('solo-content').value = data.solo || '';

                    // Load workflows data (support both old and new format)
                    if (data.workflows && Array.isArray(data.workflows)) {
                        // New format: multiple workflows
                        workflowsData = data.workflows;
                    } else if (data.workflow && data.workflow.nodes) {
                        // Old format: single workflow - migrate to new format
                        workflowsData = [{
                            id: 'workflow-' + Date.now(),
                            title: '工作流程图',
                            description: '从创意到盈利的完整工具链',
                            visible: true,
                            order: 1,
                            nodes: data.workflow.nodes,
                            connections: data.workflow.connections
                        }];
                    } else {
                        workflowsData = [];
                    }

                    renderWorkflowsList();
                }
            } catch (e) {
                console.error('Failed to load solo content:', e);
            }
        }

        // Render workflows list
        function renderWorkflowsList() {
            const listEl = document.getElementById('workflows-list');
            const countEl = document.getElementById('workflows-count');

            if (!listEl || !countEl) return;

            countEl.textContent = workflowsData.length;

            if (workflowsData.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-workflows">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="9" y1="9" x2="15" y2="9"/>
                            <line x1="9" y1="15" x2="15" y2="15"/>
                        </svg>
                        <p>还没有工作流，点击上方按钮创建第一个</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = workflowsData.map(workflow => `
                <div class="workflow-card" ondblclick="editWorkflow('${workflow.id}')">
                    <div class="workflow-card-header">
                        <div>
                            <h4 class="workflow-card-title">${escapeHtml(workflow.title || '未命名')}</h4>
                            <p class="workflow-card-desc">${escapeHtml(workflow.description || '')}</p>
                        </div>
                    </div>
                    <div class="workflow-card-preview">
                        <div class="workflow-card-preview-canvas" style="width: 2000px; height: 1200px;">
                            ${renderWorkflowPreview(workflow)}
                        </div>
                    </div>
                    <div class="workflow-card-stats">
                        <span>📦 ${workflow.nodes ? workflow.nodes.length : 0} 个节点</span>
                        <span>🔗 ${workflow.connections ? workflow.connections.length : 0} 个连接</span>
                    </div>
                    <div class="workflow-card-actions">
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); editWorkflow('${workflow.id}')">编辑</button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteWorkflow('${workflow.id}')">删除</button>
                    </div>
                </div>
            `).join('');
        }

        // Render workflow preview (miniature)
        function renderWorkflowPreview(workflow) {
            if (!workflow.nodes || workflow.nodes.length === 0) {
                return '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#64748b;font-size:12px;">空画布</div>';
            }

            const nodesHTML = workflow.nodes.map(node => `
                <div style="position:absolute;left:${node.position.x}px;top:${node.position.y}px;width:200px;background:#1e293b;border:2px solid #3b82f6;border-radius:8px;padding:16px;">
                    <div style="color:#e2e8f0;font-size:14px;font-weight:600;margin-bottom:8px;">${escapeHtml(node.title || '未命名')}</div>
                    <div style="color:#94a3b8;font-size:12px;">${escapeHtml(node.description || '')}</div>
                </div>
            `).join('');

            return nodesHTML;
        }

        // Create new workflow
        function createNewWorkflow() {
            const newWorkflow = {
                id: 'workflow-' + Date.now(),
                title: '新工作流',
                description: '右键编辑介绍',
                visible: true,
                order: workflowsData.length + 1,
                nodes: [],
                connections: []
            };

            workflowsData.push(newWorkflow);
            renderWorkflowsList();
            editWorkflow(newWorkflow.id);
        }

        // Edit workflow
        function editWorkflow(workflowId) {
            const workflow = workflowsData.find(w => w.id === workflowId);
            if (!workflow) return;

            currentWorkflowId = workflowId;
            workflowData = {
                nodes: workflow.nodes || [],
                connections: workflow.connections || []
            };

            // Update UI
            document.getElementById('workflow-edit-title').value = workflow.title || '';
            document.getElementById('workflow-edit-description').value = workflow.description || '';
            document.getElementById('current-workflow-title').textContent = workflow.title || '未命名';

            // Show editor, hide list
            document.getElementById('workflow-editor-card').style.display = 'block';
            document.querySelector('#workflows-list').parentElement.style.display = 'none';

            // Initialize history
            historyStack = [];
            historyIndex = -1;
            saveToHistory();

            // Render workflow
            renderWorkflow();
            setupCanvasInteractions();

            // Update canvas size to fit all nodes
            updateCanvasSize();
        }

        // Close workflow editor
        function closeWorkflowEditor() {
            // Save current workflow before closing
            if (currentWorkflowId) {
                const workflow = workflowsData.find(w => w.id === currentWorkflowId);
                if (workflow) {
                    workflow.title = document.getElementById('workflow-edit-title').value;
                    workflow.description = document.getElementById('workflow-edit-description').value;
                    workflow.nodes = workflowData.nodes;
                    workflow.connections = workflowData.connections;
                }
            }

            // Hide editor, show list
            document.getElementById('workflow-editor-card').style.display = 'none';
            document.querySelector('#workflows-list').parentElement.style.display = 'block';

            // Reset state
            currentWorkflowId = null;
            workflowData = { nodes: [], connections: [] };
            canvasPan = { x: 0, y: 0 };

            // Refresh list
            renderWorkflowsList();
        }

        // Save current workflow
        async function saveCurrentWorkflow() {
            if (!currentWorkflowId) return;

            // Update current workflow data
            const workflow = workflowsData.find(w => w.id === currentWorkflowId);
            if (workflow) {
                workflow.title = document.getElementById('workflow-edit-title').value;
                workflow.description = document.getElementById('workflow-edit-description').value;
                workflow.nodes = workflowData.nodes;
                workflow.connections = workflowData.connections;
            }

            // Save all workflows
            await saveAllWorkflows();
        }

        // Save all workflows to server
        async function saveAllWorkflows(silent = false) {
            const solo = document.getElementById('solo-content').value;
            const statusEl = document.getElementById('workflow-save-status');

            // Show saving status
            if (statusEl) {
                statusEl.textContent = '保存中...';
                statusEl.style.color = '#3b82f6';
            }

            try {
                const res = await fetch('/api/content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        solo,
                        services: '',
                        workflows: workflowsData,
                        blocks: [] // Keep empty for backward compatibility
                    })
                });

                if (res.ok) {
                    if (statusEl) {
                        statusEl.textContent = '✓ 已保存';
                        statusEl.style.color = '#22c55e';
                        setTimeout(() => {
                            statusEl.textContent = '';
                        }, 2000);
                    }
                    // 不显示alert提示框
                } else if (res.status === 401) {
                    if (statusEl) {
                        statusEl.textContent = '✗ 未授权';
                        statusEl.style.color = '#ef4444';
                    }
                } else {
                    if (statusEl) {
                        statusEl.textContent = '✗ 保存失败';
                        statusEl.style.color = '#ef4444';
                    }
                }
            } catch (e) {
                if (statusEl) {
                    statusEl.textContent = '✗ 网络错误';
                    statusEl.style.color = '#ef4444';
                }
            }
        }

        // Delete workflow
        function deleteWorkflow(workflowId) {
            if (!confirm('确定要删除这个工作流吗？此操作不可恢复。')) return;

            workflowsData = workflowsData.filter(w => w.id !== workflowId);
            renderWorkflowsList();

            // Auto-save after delete
            saveAllWorkflows(true);
        }

        // History management
        function saveToHistory() {
            // Remove any history after current index
            historyStack = historyStack.slice(0, historyIndex + 1);

            // Add current state
            historyStack.push(JSON.parse(JSON.stringify(workflowData)));

            // Limit history size
            if (historyStack.length > MAX_HISTORY) {
                historyStack.shift();
            } else {
                historyIndex++;
            }

            updateHistoryButtons();
        }

        function undoWorkflow() {
            if (historyIndex > 0) {
                historyIndex--;
                workflowData = JSON.parse(JSON.stringify(historyStack[historyIndex]));
                renderWorkflow();
                updateCanvasSize();
                updateHistoryButtons();
                triggerAutoSave();
            }
        }

        function redoWorkflow() {
            if (historyIndex < historyStack.length - 1) {
                historyIndex++;
                workflowData = JSON.parse(JSON.stringify(historyStack[historyIndex]));
                renderWorkflow();
                updateCanvasSize();
                updateHistoryButtons();
                triggerAutoSave();
            }
        }

        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            if (undoBtn) undoBtn.disabled = historyIndex <= 0;
            if (redoBtn) redoBtn.disabled = historyIndex >= historyStack.length - 1;
        }

        // Auto-save
        function triggerAutoSave() {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                saveCurrentWorkflow(); // Auto-save current workflow
            }, 3000);
        }

        function renderWorkflow() {
            const canvas = document.getElementById('workflow-canvas');
            const container = document.getElementById('workflow-canvas-container');
            if (!canvas) return;

            // 计算画布需要的最小高度
            let maxY = 0;
            let maxX = 0;
            const nodeHeight = 80; // 估计节点高度
            const nodeWidth = 200; // 节点宽度
            const padding = 80; // 底部和右侧留白

            workflowData.nodes.forEach(node => {
                maxY = Math.max(maxY, node.position.y + nodeHeight);
                maxX = Math.max(maxX, node.position.x + nodeWidth);
            });

            // 设置画布最小高度（至少600px，根据内容自动增加）
            const requiredHeight = Math.max(600, maxY + padding);
            if (container) {
                container.style.minHeight = requiredHeight + 'px';
            }
            if (canvas) {
                canvas.style.minHeight = requiredHeight + 'px';
            }

            // Render nodes with optimized styles
            canvas.innerHTML = workflowData.nodes.map(node => {
                const isSelected = selectedNodeId === node.id;
                const borderColor = isSelected ? '#60a5fa' : '#3b82f6';
                const boxShadow = isSelected ? '0 0 0 3px rgba(96, 165, 250, 0.3)' : 'none';

                return `
                <div class="workflow-node" 
                     data-node-id="${node.id}" 
                     style="position: absolute; left: ${node.position.x}px; top: ${node.position.y}px; width: 200px; background: #1e293b; border: 2px solid ${borderColor}; border-radius: 8px; padding: 12px; cursor: grab; z-index: 2; transition: all 0.2s ease; box-shadow: ${boxShadow}; pointer-events: auto;">
                    <div class="node-connector node-connector-left" data-node-id="${node.id}" data-side="left" 
                         style="position: absolute; left: -8px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; background: #3b82f6; border: 2px solid #0f172a; border-radius: 50%; cursor: crosshair; z-index: 10; pointer-events: auto;"></div>
                    <div class="node-connector node-connector-right" data-node-id="${node.id}" data-side="right" 
                         style="position: absolute; right: -8px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; background: #3b82f6; border: 2px solid #0f172a; border-radius: 50%; cursor: crosshair; z-index: 10; pointer-events: auto;"></div>
                    <h4 style="color: #e2e8f0; font-size: 13px; font-weight: 600; margin: 0 0 6px 0; pointer-events: none;">${escapeHtml(node.title || '未命名')}</h4>
                    <p style="color: #94a3b8; font-size: 11px; margin: 0; line-height: 1.4; pointer-events: none;">${escapeHtml(node.description || '')}</p>
                </div>
            `;
            }).join('');

            // Setup drag for nodes
            setupNodeDrag();

            // Setup connectors
            setupConnectors();

            // Render connections
            renderConnections();
        }

        function setupNodeDrag() {
            const nodes = document.querySelectorAll('.workflow-node');

            nodes.forEach(node => {
                node.addEventListener('mousedown', function (e) {
                    // Don't drag if clicking on connector
                    if (e.target.classList.contains('node-connector')) return;

                    isDraggingNode = true;
                    draggedNodeId = this.dataset.nodeId;

                    const startX = e.clientX;
                    const startY = e.clientY;
                    const initialLeft = parseInt(this.style.left);
                    const initialTop = parseInt(this.style.top);
                    let hasMoved = false;
                    let dragTimeout = null;

                    this.style.cursor = 'grabbing';
                    this.style.zIndex = '100';

                    // Clear any existing timeout
                    if (dragTimeout) clearTimeout(dragTimeout);

                    // Set a small delay before allowing drag to prevent interfering with double-click
                    dragTimeout = setTimeout(() => {
                        const onMouseMove = (moveEvent) => {
                            const dx = moveEvent.clientX - startX;
                            const dy = moveEvent.clientY - startY;

                            // Only mark as moved if dragged more than 5px
                            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                                hasMoved = true;

                                // Use transform for better performance during drag
                                this.style.transform = `translate(${dx}px, ${dy}px)`;

                                // Update connections in real-time with throttling
                                requestAnimationFrame(() => renderConnections());
                            }
                        };

                        const onMouseUp = () => {
                            if (hasMoved) {
                                // Apply final position
                                const transform = this.style.transform;
                                const match = transform.match(/translate\((.+)px,\s*(.+)px\)/);
                                if (match) {
                                    const dx = parseFloat(match[1]);
                                    const dy = parseFloat(match[2]);
                                    const newLeft = initialLeft + dx;
                                    const newTop = initialTop + dy;
                                    const snappedLeft = Math.round(newLeft / GRID_SIZE) * GRID_SIZE;
                                    const snappedTop = Math.round(newTop / GRID_SIZE) * GRID_SIZE;

                                    this.style.left = snappedLeft + 'px';
                                    this.style.top = snappedTop + 'px';
                                    this.style.transform = '';

                                    // Update node position in data
                                    const nodeData = workflowData.nodes.find(n => n.id === draggedNodeId);
                                    if (nodeData) {
                                        nodeData.position.x = snappedLeft;
                                        nodeData.position.y = snappedTop;
                                    }

                                    // 更新画布高度以适应新位置
                                    updateCanvasSize();

                                    // Save to history and trigger auto-save
                                    saveToHistory();
                                    triggerAutoSave();
                                }

                                renderConnections();
                            } else {
                                // Single click - select node
                                selectedNodeId = draggedNodeId;
                                selectedConnectionIndex = null;
                                renderWorkflow();
                            }

                            this.style.cursor = 'grab';
                            this.style.zIndex = '10';

                            isDraggingNode = false;
                            draggedNodeId = null;

                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                        };

                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                    }, 100); // 100ms delay to allow double-click

                    e.preventDefault();
                    e.stopPropagation();
                });

                // Double-click to edit
                node.addEventListener('dblclick', function (e) {
                    e.stopPropagation(); // Prevent canvas double-click
                    if (!e.target.classList.contains('node-connector')) {
                        editNode(this.dataset.nodeId);
                    }
                });

                // Right-click context menu
                node.addEventListener('contextmenu', function (e) {
                    e.preventDefault();
                    showContextMenu(e.clientX, e.clientY, this.dataset.nodeId);
                });
            });
        }

        function setupConnectors() {
            const connectors = document.querySelectorAll('.node-connector');
            let tempLine = null;
            let tempLineStart = null;
            let nearestConnector = null;
            const SNAP_DISTANCE = 50; // 吸附距离（像素）

            connectors.forEach(connector => {
                // 鼠标按下开始拖拽连接
                connector.addEventListener('mousedown', function (e) {
                    e.stopPropagation();
                    e.preventDefault();

                    const nodeId = this.dataset.nodeId;
                    const side = this.dataset.side;

                    // 支持从左右两侧连接点开始拖拽
                    const rect = this.getBoundingClientRect();
                    const svg = document.getElementById('workflow-connections');
                    const svgRect = svg.getBoundingClientRect();

                    tempLineStart = {
                        nodeId: nodeId,
                        side: side,
                        x: rect.left + rect.width / 2 - svgRect.left,
                        y: rect.top + rect.height / 2 - svgRect.top
                    };

                    // 创建临时连接线
                    tempLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    tempLine.setAttribute('stroke', '#22c55e');
                    tempLine.setAttribute('stroke-width', '2');
                    tempLine.setAttribute('stroke-dasharray', '5,5');
                    tempLine.setAttribute('x1', tempLineStart.x);
                    tempLine.setAttribute('y1', tempLineStart.y);
                    tempLine.setAttribute('x2', tempLineStart.x);
                    tempLine.setAttribute('y2', tempLineStart.y);
                    svg.appendChild(tempLine);

                    // 高亮起始连接点
                    this.style.background = '#22c55e';
                    this.style.transform = 'translateY(-50%) scale(1.3)';
                });

                // 鼠标悬停在连接点上
                connector.addEventListener('mouseenter', function (e) {
                    if (tempLine && this.dataset.nodeId !== tempLineStart.nodeId) {
                        // 高亮目标连接点（任意侧都可以）
                        this.style.background = '#22c55e';
                        this.style.transform = 'translateY(-50%) scale(1.3)';
                    }
                });

                connector.addEventListener('mouseleave', function (e) {
                    if (tempLine && this.dataset.nodeId !== tempLineStart.nodeId) {
                        // 恢复目标连接点
                        this.style.background = '#3b82f6';
                        this.style.transform = 'translateY(-50%)';
                    }
                });
            });

            // 全局鼠标移动 - 更新临时连接线并检测吸附
            document.addEventListener('mousemove', function (e) {
                if (tempLine && tempLineStart) {
                    const svg = document.getElementById('workflow-connections');
                    const svgRect = svg.getBoundingClientRect();
                    let x = e.clientX - svgRect.left;
                    let y = e.clientY - svgRect.top;

                    // 检测最近的连接点并吸附
                    nearestConnector = null;
                    let minDistance = SNAP_DISTANCE;

                    document.querySelectorAll('.node-connector').forEach(connector => {
                        // 跳过起始节点的连接点
                        if (connector.dataset.nodeId === tempLineStart.nodeId) return;

                        const rect = connector.getBoundingClientRect();
                        const connectorX = rect.left + rect.width / 2 - svgRect.left;
                        const connectorY = rect.top + rect.height / 2 - svgRect.top;

                        const distance = Math.sqrt(
                            Math.pow(x - connectorX, 2) +
                            Math.pow(y - connectorY, 2)
                        );

                        if (distance < minDistance) {
                            minDistance = distance;
                            nearestConnector = {
                                element: connector,
                                x: connectorX,
                                y: connectorY
                            };
                        }
                    });

                    // 如果找到最近的连接点，吸附到它
                    if (nearestConnector) {
                        x = nearestConnector.x;
                        y = nearestConnector.y;

                        // 高亮吸附目标
                        nearestConnector.element.style.background = '#22c55e';
                        nearestConnector.element.style.transform = 'translateY(-50%) scale(1.5)';

                        // 恢复其他连接点
                        document.querySelectorAll('.node-connector').forEach(c => {
                            if (c !== nearestConnector.element && c.dataset.nodeId !== tempLineStart.nodeId) {
                                c.style.background = '#3b82f6';
                                c.style.transform = 'translateY(-50%)';
                            }
                        });
                    } else {
                        // 恢复所有非起始连接点
                        document.querySelectorAll('.node-connector').forEach(c => {
                            if (c.dataset.nodeId !== tempLineStart.nodeId) {
                                c.style.background = '#3b82f6';
                                c.style.transform = 'translateY(-50%)';
                            }
                        });
                    }

                    tempLine.setAttribute('x2', x);
                    tempLine.setAttribute('y2', y);
                }
            });

            // 全局鼠标释放 - 完成连接
            document.addEventListener('mouseup', function (e) {
                if (tempLine && tempLineStart) {
                    let targetConnector = null;

                    // 优先使用吸附的连接点
                    if (nearestConnector) {
                        targetConnector = nearestConnector.element;
                    } else {
                        // 否则检查鼠标位置下的元素
                        targetConnector = document.elementFromPoint(e.clientX, e.clientY);
                    }

                    if (targetConnector && targetConnector.classList.contains('node-connector') &&
                        targetConnector.dataset.nodeId !== tempLineStart.nodeId) {

                        const toNodeId = targetConnector.dataset.nodeId;
                        const toSide = targetConnector.dataset.side;

                        // 检查连接是否已存在
                        const exists = workflowData.connections.find(c =>
                            c.from === tempLineStart.nodeId && c.to === toNodeId
                        );

                        if (!exists) {
                            // 创建新连接，记录连接的侧面
                            workflowData.connections.push({
                                from: tempLineStart.nodeId,
                                to: toNodeId,
                                fromSide: tempLineStart.side,
                                toSide: toSide
                            });

                            saveToHistory();
                            triggerAutoSave();
                        }
                    }

                    // 清理临时连接线
                    tempLine.remove();
                    tempLine = null;
                    tempLineStart = null;
                    nearestConnector = null;

                    // 恢复所有连接点样式
                    document.querySelectorAll('.node-connector').forEach(c => {
                        c.style.background = '#3b82f6';
                        c.style.transform = 'translateY(-50%)';
                    });

                    renderConnections();
                }
            });
        }

        function setupCanvasInteractions() {
            if (canvasInteractionsSetup) return;
            canvasInteractionsSetup = true;

            const canvas = document.getElementById('workflow-canvas');
            const container = document.getElementById('workflow-canvas-container');
            const contextMenu = document.getElementById('workflow-context-menu');

            if (!canvas || !container || !contextMenu) return;

            // ========== 画布拖动功能 ==========
            container.style.cursor = 'grab';

            container.addEventListener('mousedown', function (e) {
                // 如果点击的是节点、连接器或其他交互元素，不启动画布拖动
                if (e.target.closest('.workflow-node') ||
                    e.target.closest('.node-connector') ||
                    e.target.closest('.connection-group') ||
                    e.target !== container && e.target !== canvas) {
                    return;
                }

                isPanning = true;
                panStart.x = e.clientX - canvasPan.x;
                panStart.y = e.clientY - canvasPan.y;
                container.style.cursor = 'grabbing';
                e.preventDefault();
            });

            container.addEventListener('mousemove', function (e) {
                if (!isPanning) return;

                canvasPan.x = e.clientX - panStart.x;
                canvasPan.y = e.clientY - panStart.y;

                applyCanvasTransform();
            });

            container.addEventListener('mouseup', function (e) {
                if (isPanning) {
                    isPanning = false;
                    container.style.cursor = 'grab';
                }
            });

            container.addEventListener('mouseleave', function (e) {
                if (isPanning) {
                    isPanning = false;
                    container.style.cursor = 'grab';
                }
            });
            // ========== 画布拖动功能结束 ==========

            // Context menu click handler (event delegation)
            contextMenu.addEventListener('click', function (e) {
                const item = e.target.closest('.workflow-context-menu-item');
                if (!item || item.classList.contains('disabled')) return;

                const action = item.dataset.action;
                const nodeId = item.dataset.nodeId;

                switch (action) {
                    case 'add':
                        addNodeAtPosition();
                        break;
                    case 'edit':
                        editNode(nodeId);
                        break;
                    case 'duplicate':
                        duplicateNode(nodeId);
                        break;
                    case 'delete':
                        if (nodeId) {
                            deleteNodeById(nodeId);
                        } else if (contextMenuNodeId) {
                            deleteNodeById(contextMenuNodeId);
                        } else {
                            deleteNodeAtPosition();
                        }
                        break;
                    case 'reset':
                        resetWorkflowView();
                        break;
                    case 'center':
                        centerWorkflowView();
                        break;
                    case 'undo':
                        undoWorkflow();
                        break;
                    case 'redo':
                        redoWorkflow();
                        break;
                }

                hideContextMenu();
            });

            // Double-click on canvas disabled (use right-click menu to add nodes)
            // canvas.addEventListener('dblclick', function(e) {
            //     if (e.target === canvas) {
            //         e.preventDefault();
            //         const rect = canvas.getBoundingClientRect();
            //         contextMenuPosition = {
            //             x: e.clientX - rect.left,
            //             y: e.clientY - rect.top
            //         };
            //         addNodeAtPosition();
            //     }
            // });

            // Right-click on canvas to show context menu
            canvas.addEventListener('contextmenu', function (e) {
                // Show menu if clicking on canvas or its background (not on nodes)
                if (e.target === canvas || e.target.id === 'workflow-canvas') {
                    e.preventDefault();
                    const rect = canvas.getBoundingClientRect();
                    contextMenuPosition = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                    contextMenuNodeId = null;
                    showContextMenu(e.clientX, e.clientY, null);
                }
            });

            // Click outside to close context menu and deselect connection
            document.addEventListener('click', function (e) {
                if (!e.target.closest('#workflow-context-menu') && !e.target.closest('.workflow-node')) {
                    hideContextMenu();
                }
                // Deselect connection when clicking on canvas background
                if (e.target === canvas || e.target.closest('#workflow-canvas')) {
                    if (selectedConnectionIndex !== null && !e.target.closest('.connection-group')) {
                        selectedConnectionIndex = null;
                        renderConnections();
                    }
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                // Ctrl+Z for undo
                if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undoWorkflow();
                }
                // Ctrl+Y or Ctrl+Shift+Z for redo
                if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
                    e.preventDefault();
                    redoWorkflow();
                }
                // Delete key to delete selected connection or node
                if (e.key === 'Delete') {
                    e.preventDefault();
                    if (selectedConnectionIndex !== null) {
                        deleteConnection(selectedConnectionIndex);
                        selectedConnectionIndex = null;
                    } else if (selectedNodeId) {
                        deleteNodeById(selectedNodeId);
                    }
                }
                // Escape key to deselect connection and close menu
                if (e.key === 'Escape') {
                    e.preventDefault();
                    selectedConnectionIndex = null;
                    selectedNodeId = null;
                    hideContextMenu();
                    renderConnections();
                }
                // Ctrl+S to save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveCurrentWorkflow();
                }
            });
        }

        // Keep workflow lines synced on viewport/layout changes
        window.addEventListener('resize', () => requestAnimationFrame(renderConnections));
        if ('ResizeObserver' in window) {
            const workflowContainer = document.getElementById('workflow-canvas-container');
            if (workflowContainer) {
                const ro = new ResizeObserver(() => requestAnimationFrame(renderConnections));
                ro.observe(workflowContainer);
            }
        }

        function showContextMenu(x, y, nodeId) {
            const menu = document.getElementById('workflow-context-menu');
            if (!menu) return;

            contextMenuNodeId = nodeId;

            // Update menu content based on context
            if (nodeId) {
                // Right-clicked on a node
                const node = workflowData.nodes.find(n => n.id === nodeId);
                menu.innerHTML = `
                    <div class="workflow-context-menu-item" data-action="edit" data-node-id="${nodeId}">
                        编辑节点
                    </div>
                    <div class="workflow-context-menu-item" data-action="duplicate" data-node-id="${nodeId}">
                        复制节点
                    </div>
                    <div class="workflow-context-menu-divider"></div>
                    <div class="workflow-context-menu-item" data-action="delete" style="color: #ef4444;">
                        删除节点
                    </div>
                `;
            } else {
                // Right-clicked on canvas
                const canUndo = historyIndex > 0;
                const canRedo = historyIndex < historyStack.length - 1;

                menu.innerHTML = `
                    <div class="workflow-context-menu-item" data-action="add">
                        添加节点
                    </div>
                    <div class="workflow-context-menu-divider"></div>
                    <div class="workflow-context-menu-item" data-action="reset">
                        重置视图
                    </div>
                    <div class="workflow-context-menu-item" data-action="center">
                        居中显示
                    </div>
                    <div class="workflow-context-menu-divider"></div>
                    <div class="workflow-context-menu-item ${!canUndo ? 'disabled' : ''}" data-action="undo">
                        撤销
                    </div>
                    <div class="workflow-context-menu-item ${!canRedo ? 'disabled' : ''}" data-action="redo">
                        重做
                    </div>
                `;
            }

            // Position menu
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'block';
        }

        function hideContextMenu() {
            const menu = document.getElementById('workflow-context-menu');
            if (menu) {
                menu.style.display = 'none';
            }
            contextMenuNodeId = null;
        }

        function addNodeAtPosition() {
            hideContextMenu();

            const newId = 'node-' + Date.now();
            const newNode = {
                id: newId,
                title: '新节点',
                description: '右键编辑',
                content: '',
                link: '',
                position: {
                    x: contextMenuPosition.x,
                    y: contextMenuPosition.y
                }
            };

            workflowData.nodes.push(newNode);
            saveToHistory();
            triggerAutoSave();
            renderWorkflow();
            updateCanvasSize();
        }

        function duplicateNode(nodeId) {
            hideContextMenu();

            const node = workflowData.nodes.find(n => n.id === nodeId);
            if (!node) return;

            const newId = 'node-' + Date.now();
            const newNode = {
                ...node,
                id: newId,
                position: {
                    x: node.position.x + 30,
                    y: node.position.y + 30
                }
            };

            workflowData.nodes.push(newNode);
            saveToHistory();
            triggerAutoSave();
            renderWorkflow();
            updateCanvasSize();
        }

        function applyCanvasTransform() {
            const translate = `translate(${canvasPan.x}px, ${canvasPan.y}px)`;
            const canvas = document.getElementById('workflow-canvas');
            const svg = document.getElementById('workflow-connections');
            if (canvas) canvas.style.transform = translate;
            if (svg) svg.style.transform = translate;
        }

        function centerWorkflowView() {
            hideContextMenu();

            if (workflowData.nodes.length === 0) return;

            // Calculate bounding box of all nodes
            let minX = Infinity, minY = Infinity;
            let maxX = -Infinity, maxY = -Infinity;

            workflowData.nodes.forEach(node => {
                minX = Math.min(minX, node.position.x);
                minY = Math.min(minY, node.position.y);
                maxX = Math.max(maxX, node.position.x + 200); // 200 is node width
                maxY = Math.max(maxY, node.position.y + 100); // approximate node height
            });

            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;

            const canvas = document.getElementById('workflow-canvas');
            const container = document.getElementById('workflow-canvas-container');
            if (!canvas || !container) return;

            const containerRect = container.getBoundingClientRect();
            canvasPan.x = containerRect.width / 2 - centerX;
            canvasPan.y = containerRect.height / 2 - centerY;

            applyCanvasTransform();
        }

        function deleteNodeAtPosition() {
            hideContextMenu();

            if (!contextMenuNodeId) return;

            deleteNodeById(contextMenuNodeId);
        }

        function deleteNodeById(nodeId) {
            if (!nodeId) return;

            console.log('删除节点:', nodeId);

            // Remove node
            workflowData.nodes = workflowData.nodes.filter(n => n.id !== nodeId);

            // Remove related connections
            workflowData.connections = workflowData.connections.filter(c =>
                c.from !== nodeId && c.to !== nodeId
            );

            // Clear selection if deleted node was selected
            if (selectedNodeId === nodeId) {
                selectedNodeId = null;
            }

            // Hide context menu
            hideContextMenu();

            saveToHistory();
            triggerAutoSave();
            renderWorkflow();
            updateCanvasSize();
        }

        // 更新画布大小以适应所有节点
        function updateCanvasSize() {
            const canvas = document.getElementById('workflow-canvas');
            const container = document.getElementById('workflow-canvas-container');
            if (!canvas || !container) return;

            if (workflowData.nodes.length === 0) {
                // 如果没有节点，使用默认尺寸
                const defaultHeight = 2000;
                const defaultWidth = 3000;
                container.style.minHeight = defaultHeight + 'px';
                canvas.style.minHeight = defaultHeight + 'px';
                canvas.style.width = defaultWidth + 'px';

                const svg = document.getElementById('workflow-connections');
                if (svg) {
                    svg.setAttribute('width', defaultWidth);
                    svg.setAttribute('height', defaultHeight);
                    svg.style.width = defaultWidth + 'px';
                    svg.style.height = defaultHeight + 'px';
                }
                return;
            }

            let maxY = 0;
            let maxX = 0;
            let minX = Infinity;
            let minY = Infinity;
            const nodeHeight = 150; // 增加节点高度估算，确保足够空间
            const nodeWidth = 250;  // 增加节点宽度估算
            const padding = 500;    // 大幅增加边距，确保有足够的扩展空间

            // 计算所有节点的边界
            workflowData.nodes.forEach(node => {
                minX = Math.min(minX, node.position.x);
                minY = Math.min(minY, node.position.y);
                maxY = Math.max(maxY, node.position.y + nodeHeight);
                maxX = Math.max(maxX, node.position.x + nodeWidth);
            });

            // 无限画布：根据内容自动扩展，没有最大限制
            // 确保画布足够大，包含所有节点和足够的边距
            const requiredHeight = Math.max(2000, maxY + padding);
            const requiredWidth = Math.max(3000, maxX + padding);

            // 设置容器和画布的尺寸（无限扩展）
            container.style.minHeight = requiredHeight + 'px';
            container.style.height = requiredHeight + 'px';
            canvas.style.minHeight = requiredHeight + 'px';
            canvas.style.height = requiredHeight + 'px';
            canvas.style.width = requiredWidth + 'px';

            // 同时更新 SVG 的尺寸
            const svg = document.getElementById('workflow-connections');
            if (svg) {
                svg.setAttribute('width', requiredWidth);
                svg.setAttribute('height', requiredHeight);
                svg.style.width = requiredWidth + 'px';
                svg.style.height = requiredHeight + 'px';
            }

            console.log('Canvas size updated (infinite):', {
                width: requiredWidth,
                height: requiredHeight,
                nodes: workflowData.nodes.length,
                bounds: { minX, minY, maxX, maxY }
            });
        }

        function renderConnections() {
            const svg = document.getElementById('workflow-connections');
            const canvas = document.getElementById('workflow-canvas');
            if (!svg || !canvas) return;

            // Keep pointer-events: none on SVG, only enable on specific elements
            svg.style.pointerEvents = 'none';
            // Mirror canvas pan so lines stay glued to nodes
            svg.style.transform = canvas.style.transform || 'translate(0, 0)';

            // Define arrow markers (normal and selected)
            const defs = `
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#3b82f6" />
                    </marker>
                    <marker id="arrowhead-selected" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#f59e0b" />
                    </marker>
                </defs>
            `;

            const paths = workflowData.connections.map((conn, index) => {
                const fromNode = document.querySelector(`[data-node-id="${conn.from}"]`);
                const toNode = document.querySelector(`[data-node-id="${conn.to}"]`);

                if (!fromNode || !toNode) return '';

                const fromRect = fromNode.getBoundingClientRect();
                const toRect = toNode.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();

                // 根据连接侧面计算起点和终点
                const fromSide = conn.fromSide || 'right';
                const toSide = conn.toSide || 'left';

                let x1, y1, x2, y2;

                // 计算起点位置
                if (fromSide === 'right') {
                    x1 = fromRect.right - canvasRect.left;
                } else {
                    x1 = fromRect.left - canvasRect.left;
                }
                y1 = fromRect.top + fromRect.height / 2 - canvasRect.top;

                // 计算终点位置
                if (toSide === 'left') {
                    x2 = toRect.left - canvasRect.left;
                } else {
                    x2 = toRect.right - canvasRect.left;
                }
                y2 = toRect.top + toRect.height / 2 - canvasRect.top;

                const midX = (x1 + x2) / 2;
                const midY = (y1 + y2) / 2;

                // Check if this connection is selected
                const isSelected = selectedConnectionIndex === index;
                const strokeColor = isSelected ? '#f59e0b' : '#3b82f6';
                const strokeWidth = isSelected ? '3' : '2';
                const markerEnd = isSelected ? 'url(#arrowhead-selected)' : 'url(#arrowhead)';

                return `
                    <g class="connection-group" data-connection-index="${index}">
                        <!-- Invisible thick path for easier hover detection -->
                        <path d="M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}" 
                              stroke="transparent" 
                              stroke-width="20" 
                              fill="none"
                              class="connection-hover-area"
                              style="cursor: pointer; pointer-events: auto;">
                        </path>
                        
                        <!-- Visible connection line -->
                        <path d="M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}" 
                              stroke="${strokeColor}" 
                              stroke-width="${strokeWidth}" 
                              fill="none"
                              marker-end="${markerEnd}"
                              class="connection-path"
                              style="pointer-events: auto; cursor: pointer;">
                        </path>
                        
                        <!-- Connection action buttons (square style like n8n) -->
                        <g class="connection-actions" style="opacity: 0; transition: opacity 0.2s;">
                            <!-- Add node button (square with rounded corners) -->
                            <rect x="${midX - 50}" y="${midY - 15}" width="30" height="30" rx="4" fill="#1e293b" stroke="#3b82f6" stroke-width="2" style="cursor: pointer; pointer-events: auto;" class="add-node-btn" data-from="${conn.from}" data-to="${conn.to}" data-index="${index}"/>
                            <line x1="${midX - 50 + 8}" y1="${midY}" x2="${midX - 50 + 22}" y2="${midY}" stroke="#3b82f6" stroke-width="2" style="pointer-events: none;"/>
                            <line x1="${midX - 50 + 15}" y1="${midY - 7}" x2="${midX - 50 + 15}" y2="${midY + 7}" stroke="#3b82f6" stroke-width="2" style="pointer-events: none;"/>
                            
                            <!-- Delete connection button (square with rounded corners) -->
                            <rect x="${midX + 20}" y="${midY - 15}" width="30" height="30" rx="4" fill="#1e293b" stroke="#ef4444" stroke-width="2" style="cursor: pointer; pointer-events: auto;" class="delete-conn-btn" data-index="${index}"/>
                            <path d="M ${midX + 20 + 9} ${midY - 6} L ${midX + 20 + 21} ${midY + 6} M ${midX + 20 + 9} ${midY + 6} L ${midX + 20 + 21} ${midY - 6}" stroke="#ef4444" stroke-width="2" stroke-linecap="round" style="pointer-events: none;"/>
                        </g>
                    </g>
                `;
            }).join('');

            svg.innerHTML = defs + paths;

            // Add hover effect and click handlers to show/hide action buttons
            document.querySelectorAll('.connection-group').forEach((group, index) => {
                const actions = group.querySelector('.connection-actions');
                const hoverArea = group.querySelector('.connection-hover-area');
                const visiblePath = group.querySelector('.connection-path');
                const addBtn = group.querySelector('.add-node-btn');
                const deleteBtn = group.querySelector('.delete-conn-btn');

                // Hover effect
                hoverArea.addEventListener('mouseenter', () => {
                    actions.style.opacity = '1';
                });

                group.addEventListener('mouseleave', () => {
                    actions.style.opacity = '0';
                });

                // Click to select connection
                hoverArea.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectConnection(parseInt(group.dataset.connectionIndex));
                });

                visiblePath.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectConnection(parseInt(group.dataset.connectionIndex));
                });

                // Add node button
                if (addBtn) {
                    addBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const fromId = addBtn.dataset.from;
                        const toId = addBtn.dataset.to;
                        const connIndex = parseInt(addBtn.dataset.index);
                        addNodeBetween(fromId, toId, connIndex);
                    });
                }

                // Delete connection button
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const connIndex = parseInt(deleteBtn.dataset.index);
                        deleteConnection(connIndex);
                    });
                }
            });
        }

        function addNodeBetween(fromId, toId, connectionIndex) {
            // Get positions of from and to nodes
            const fromNode = workflowData.nodes.find(n => n.id === fromId);
            const toNode = workflowData.nodes.find(n => n.id === toId);

            if (!fromNode || !toNode) return;

            // Calculate middle position
            const midX = (fromNode.position.x + toNode.position.x) / 2;
            const midY = (fromNode.position.y + toNode.position.y) / 2;

            // Create new node
            const newId = 'node-' + Date.now();
            const newNode = {
                id: newId,
                title: '新节点',
                description: '右键编辑',
                content: '',
                link: '',
                position: { x: midX, y: midY }
            };

            workflowData.nodes.push(newNode);

            // Remove old connection
            workflowData.connections.splice(connectionIndex, 1);

            // Add two new connections
            workflowData.connections.push({ from: fromId, to: newId });
            workflowData.connections.push({ from: newId, to: toId });

            saveToHistory();
            triggerAutoSave();
            renderWorkflow();
            updateCanvasSize();
        }

        function deleteConnection(index) {
            workflowData.connections.splice(index, 1);
            selectedConnectionIndex = null; // Clear selection after delete
            saveToHistory();
            triggerAutoSave();
            renderConnections();
        }

        function selectConnection(index) {
            selectedConnectionIndex = index;
            renderConnections();
        }

        function addWorkflowNode() {
            const newId = 'node-' + (workflowData.nodes.length + 1);
            workflowData.nodes.push({
                id: newId,
                title: '新节点',
                description: '右键编辑',
                content: '',
                link: '',
                position: { x: 100 + workflowData.nodes.length * 30, y: 100 + workflowData.nodes.length * 30 }
            });
            saveToHistory();
            triggerAutoSave();
            renderWorkflow();
            updateCanvasSize();
        }

        function editNode(nodeId) {
            const node = workflowData.nodes.find(n => n.id === nodeId);
            if (!node) return;

            currentEditingNodeId = nodeId;
            document.getElementById('node-edit-title').value = node.title || '';
            document.getElementById('node-edit-description').value = node.description || '';
            document.getElementById('node-edit-content').value = node.content || '';
            document.getElementById('node-edit-link').value = node.link || '';

            const modal = document.getElementById('node-editor-modal');
            modal.style.display = 'flex';
        }

        function closeNodeEditor() {
            document.getElementById('node-editor-modal').style.display = 'none';
            currentEditingNodeId = null;
        }

        function saveNodeEdit() {
            if (!currentEditingNodeId) return;

            const node = workflowData.nodes.find(n => n.id === currentEditingNodeId);
            if (node) {
                node.title = document.getElementById('node-edit-title').value;
                node.description = document.getElementById('node-edit-description').value;
                node.content = document.getElementById('node-edit-content').value;
                node.link = document.getElementById('node-edit-link').value;
                saveToHistory();
                triggerAutoSave();
                renderWorkflow();
                updateCanvasSize();
            }

            closeNodeEditor();
        }

        function deleteCurrentNode() {
            if (!currentEditingNodeId) return;

            const nodeId = currentEditingNodeId;
            closeNodeEditor();
            deleteNodeById(nodeId);
        }

        function resetWorkflowView() {
            canvasPan = { x: 0, y: 0 };
            const canvas = document.getElementById('workflow-canvas');
            if (canvas) {
                applyCanvasTransform();
            }
        }

        // Auto-arrange nodes horizontally based on connections (topological sort)
        function autoArrangeNodes() {
            if (!workflowData.nodes || workflowData.nodes.length === 0) {
                alert('没有节点可以整理');
                return;
            }

            // Build adjacency list and in-degree map
            const adjacency = new Map();
            const inDegree = new Map();

            workflowData.nodes.forEach(node => {
                adjacency.set(node.id, []);
                inDegree.set(node.id, 0);
            });

            workflowData.connections.forEach(conn => {
                if (adjacency.has(conn.from) && inDegree.has(conn.to)) {
                    adjacency.get(conn.from).push(conn.to);
                    inDegree.set(conn.to, inDegree.get(conn.to) + 1);
                }
            });

            // Topological sort using Kahn's algorithm
            const queue = [];
            const levels = new Map();

            // Find all nodes with no incoming edges (start nodes)
            inDegree.forEach((degree, nodeId) => {
                if (degree === 0) {
                    queue.push(nodeId);
                    levels.set(nodeId, 0);
                }
            });

            // If no start nodes found, use first node
            if (queue.length === 0 && workflowData.nodes.length > 0) {
                queue.push(workflowData.nodes[0].id);
                levels.set(workflowData.nodes[0].id, 0);
            }

            // Process nodes level by level
            while (queue.length > 0) {
                const nodeId = queue.shift();
                const currentLevel = levels.get(nodeId);

                adjacency.get(nodeId).forEach(targetId => {
                    const newDegree = inDegree.get(targetId) - 1;
                    inDegree.set(targetId, newDegree);

                    if (!levels.has(targetId)) {
                        levels.set(targetId, currentLevel + 1);
                    } else {
                        // Update to max level if already set
                        levels.set(targetId, Math.max(levels.get(targetId), currentLevel + 1));
                    }

                    if (newDegree === 0) {
                        queue.push(targetId);
                    }
                });
            }

            // Handle disconnected nodes
            workflowData.nodes.forEach(node => {
                if (!levels.has(node.id)) {
                    levels.set(node.id, 0);
                }
            });

            // Group nodes by level
            const levelGroups = new Map();
            levels.forEach((level, nodeId) => {
                if (!levelGroups.has(level)) {
                    levelGroups.set(level, []);
                }
                levelGroups.get(level).push(nodeId);
            });

            // Arrange nodes
            const nodeWidth = 220;
            const nodeHeight = 100;
            const horizontalGap = 100;
            const verticalGap = 40;
            const startX = 50;
            const startY = 50;

            levelGroups.forEach((nodeIds, level) => {
                const x = startX + level * (nodeWidth + horizontalGap);

                nodeIds.forEach((nodeId, index) => {
                    const node = workflowData.nodes.find(n => n.id === nodeId);
                    if (node) {
                        node.position.x = x;
                        node.position.y = startY + index * (nodeHeight + verticalGap);
                    }
                });
            });

            // Save and re-render
            saveToHistory();
            triggerAutoSave();
            renderWorkflow();
            updateCanvasSize();

            // Reset view to show arranged nodes
            resetWorkflowView();
        }


        // ========== AI Rankings Management ==========

        let aiRankingsData = { boards: [] };

        // Load AI Rankings
        async function loadAiRankings() {
            try {
                const res = await fetch('/api/ai-rankings');
                if (res.ok) {
                    aiRankingsData = await res.json();
                    populateBoardSelect();
                    renderAdminBoards();
                }
            } catch (e) {
                console.error('Failed to load AI rankings:', e);
            }
        }

        // Populate board select dropdown
        function populateBoardSelect() {
            const select = document.getElementById('ranking-board-select');
            if (!select || !aiRankingsData.boards) return;

            select.innerHTML = '<option value="">选择榜单...</option>' +
                aiRankingsData.boards.map(board =>
                    `<option value="${board.id}">${board.name}</option>`
                ).join('');
        }

        // When board selection changes, populate tier select
        function onBoardSelectChange() {
            const boardId = document.getElementById('ranking-board-select').value;
            const tierSelect = document.getElementById('ranking-tier-select');

            if (!boardId || !tierSelect) {
                tierSelect.innerHTML = '<option value="">选择层级...</option>';
                return;
            }

            const board = aiRankingsData.boards.find(b => b.id === boardId);
            if (!board) return;

            tierSelect.innerHTML = '<option value="">选择层级...</option>' +
                board.tiers.map(tier =>
                    `<option value="${tier.id}">${tier.name}</option>`
                ).join('');
        }

        // Track collapsed boards in admin
        let adminCollapsedBoards = new Set();

        // Toggle board collapse in admin
        function toggleAdminBoardCollapse(boardId) {
            if (adminCollapsedBoards.has(boardId)) {
                adminCollapsedBoards.delete(boardId);
            } else {
                adminCollapsedBoards.add(boardId);
            }
            renderAdminBoards();
        }

        // Search rankings function
        function searchRankings(query) {
            const resultsContainer = document.getElementById('rankings-search-results');
            const searchInput = document.getElementById('rankings-search-input');

            if (!query || query.trim() === '') {
                resultsContainer.style.display = 'none';
                resultsContainer.innerHTML = '';
                return;
            }

            const searchTerm = query.toLowerCase().trim();
            const results = [];

            // Search through all boards
            if (aiRankingsData && aiRankingsData.boards) {
                aiRankingsData.boards.forEach(board => {
                    // Check if board name matches
                    if (board.name.toLowerCase().includes(searchTerm) ||
                        (board.description && board.description.toLowerCase().includes(searchTerm))) {
                        results.push({
                            type: 'board',
                            board: board,
                            matchType: 'name'
                        });
                    }

                    // Search through items in this board
                    if (board.tiers) {
                        board.tiers.forEach(tier => {
                            if (tier.items) {
                                tier.items.forEach(item => {
                                    if (item.name.toLowerCase().includes(searchTerm) ||
                                        (item.description && item.description.toLowerCase().includes(searchTerm))) {
                                        results.push({
                                            type: 'item',
                                            board: board,
                                            tier: tier,
                                            item: item
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
            }

            // Display results
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="padding:16px;text-align:center;color:#64748b;font-size:14px;">
                        未找到匹配的排行榜或工具
                    </div>
                `;
                resultsContainer.style.display = 'block';
                return;
            }

            resultsContainer.innerHTML = `
                <div style="font-size:13px;color:#94a3b8;margin-bottom:12px;">
                    找到 ${results.length} 个结果
                </div>
                ${results.map(result => {
                if (result.type === 'board') {
                    return `
                            <div style="padding:12px;background:#0f172a;border:1px solid #334155;border-radius:6px;margin-bottom:8px;cursor:pointer;transition:border-color 0.2s;" 
                                 onclick="scrollToBoardInAdmin('${result.board.id}')"
                                 onmouseover="this.style.borderColor='#3b82f6'"
                                 onmouseout="this.style.borderColor='#334155'">
                                <div style="font-weight:600;color:#fff;margin-bottom:4px;">
                                    📊 ${result.board.name}
                                </div>
                                <div style="font-size:12px;color:#94a3b8;">
                                    ${result.board.description || '排行榜'}
                                </div>
                            </div>
                        `;
                } else {
                    return `
                            <div style="padding:12px;background:#0f172a;border:1px solid #334155;border-radius:6px;margin-bottom:8px;cursor:pointer;transition:border-color 0.2s;" 
                                 onclick="scrollToBoardInAdmin('${result.board.id}')"
                                 onmouseover="this.style.borderColor='#3b82f6'"
                                 onmouseout="this.style.borderColor='#334155'">
                                <div style="font-weight:600;color:#fff;margin-bottom:4px;">
                                    🔧 ${result.item.name}
                                </div>
                                <div style="font-size:12px;color:#94a3b8;margin-bottom:4px;">
                                    ${result.item.description || ''}
                                </div>
                                <div style="font-size:11px;color:#64748b;">
                                    在 "${result.board.name}" → "${result.tier.name}"
                                </div>
                            </div>
                        `;
                }
            }).join('')}
            `;
            resultsContainer.style.display = 'block';
        }

        // Scroll to board in admin panel
        function scrollToBoardInAdmin(boardId) {
            // Clear search
            document.getElementById('rankings-search-input').value = '';
            document.getElementById('rankings-search-results').style.display = 'none';

            // Expand the board if collapsed
            if (adminCollapsedBoards.has(boardId)) {
                adminCollapsedBoards.delete(boardId);
                renderAdminBoards();
            }

            // Scroll to board
            setTimeout(() => {
                const boardElement = document.querySelector(`[data-board-id="${boardId}"]`);
                if (boardElement) {
                    boardElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Highlight effect
                    boardElement.style.transition = 'background-color 0.3s';
                    boardElement.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                    setTimeout(() => {
                        boardElement.style.backgroundColor = '';
                    }, 2000);
                }
            }, 100);
        }

        // Render all boards in admin panel
        function renderAdminBoards() {
            const container = document.getElementById('admin-boards-container');
            if (!container || !aiRankingsData.boards) return;

            if (aiRankingsData.boards.length === 0) {
                container.innerHTML = '<div class="card"><p style="color:#64748b;text-align:center;">暂无排行榜</p></div>';
                return;
            }

            container.innerHTML = aiRankingsData.boards.map(board => {
                const isCollapsed = adminCollapsedBoards.has(board.id);
                const itemCount = board.tiers.reduce((sum, tier) => sum + (tier.items ? tier.items.length : 0), 0);

                return `
                <div class="card admin-board-section" data-board-id="${board.id}" style="margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:${isCollapsed ? '0' : '16px'};cursor:pointer;" onclick="toggleAdminBoardCollapse('${board.id}')">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span style="color:#64748b;font-size:14px;transition:transform 0.2s;transform:rotate(${isCollapsed ? '-90deg' : '0deg'});">▼</span>
                            <h3 class="card-title" style="margin:0;">${escapeHtml(board.name)}</h3>
                            <span style="font-size:11px;color:#64748b;background:#334155;padding:2px 8px;border-radius:10px;">${itemCount} 项</span>
                        </div>
                        <div style="display:flex;gap:8px;" onclick="event.stopPropagation();">
                            <button class="btn btn-secondary" onclick="editBoard('${board.id}')" style="padding:6px 12px;font-size:12px;">编辑</button>
                            <button class="btn" onclick="deleteBoard('${board.id}')" style="padding:6px 12px;font-size:12px;background:#ef4444;color:white;">删除</button>
                        </div>
                    </div>
                    <div style="display:${isCollapsed ? 'none' : 'block'};">
                        ${board.description ? `<p style="color:#94a3b8;font-size:13px;margin-bottom:12px;">${escapeHtml(board.description)}</p>` : ''}
                        <div class="admin-board-tiers" data-board-id="${board.id}">
                            ${board.tiers.map(tier => `
                                <div class="admin-tier-row" style="display:flex;margin-bottom:8px;border-radius:8px;overflow:hidden;border:1px solid #334155;">
                                    <div class="tier-label" style="width:80px;padding:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;background:${tier.color};color:${tier.textColor};">
                                        ${escapeHtml(tier.name)}
                                    </div>
                                    <div class="tier-items" data-board-id="${board.id}" data-tier-id="${tier.id}" style="flex:1;padding:12px;background:#374151;display:flex;flex-wrap:wrap;gap:8px;min-height:50px;align-items:center;">
                                        ${tier.items && tier.items.length > 0 ? tier.items.map((item, index) => `
                                            <div class="tier-item-card" draggable="true" data-item-id="${item.id}" data-item-index="${index}" style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#1e293b;border-radius:6px;border:1px solid #334155;cursor:grab;user-select:none;">
                                                <span class="drag-handle" style="color:#64748b;font-size:14px;cursor:grab;">⋮⋮</span>
                                                ${item.image ? `<img src="${escapeHtml(item.image)}" alt="${escapeHtml(item.name)}" style="width:28px;height:28px;border-radius:4px;object-fit:cover;pointer-events:none;">` : `<div style="width:28px;height:28px;border-radius:4px;background:linear-gradient(135deg, #1e293b 0%, #475569 100%);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#94a3b8;pointer-events:none;">${escapeHtml(item.name).charAt(0).toUpperCase()}</div>`}
                                                <span style="font-size:12px;color:#e2e8f0;pointer-events:none;">${escapeHtml(item.name)}</span>
                                                <button onclick="event.stopPropagation();editRankingItem('${board.id}', '${tier.id}', '${item.id}')" style="background:transparent;border:none;color:#3b82f6;cursor:pointer;padding:2px 6px;font-size:11px;" title="编辑">编辑</button>
                                                <button onclick="event.stopPropagation();deleteRankingItem('${item.id}')" style="background:transparent;border:none;color:#ef4444;cursor:pointer;padding:2px 6px;font-size:11px;" title="删除">删除</button>
                                            </div>
                                        `).join('') : '<span style="color:#64748b;font-size:12px;">暂无项目</span>'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `}).join('');

            // Initialize drag-and-drop after rendering
            initializeDragAndDrop();
        }

        // Initialize drag-and-drop functionality for ranking items (支持跨层级拖拽)
        function initializeDragAndDrop() {
            console.log('🎯 Initializing drag and drop with cross-tier support...');
            const tierItems = document.querySelectorAll('.tier-item-card');
            const tierContainers = document.querySelectorAll('.tier-items');
            console.log('Found tier items:', tierItems.length);
            console.log('Found tier containers:', tierContainers.length);

            let dragSrcEl = null;
            let dragSrcData = null;

            function handleDragStart(e) {
                console.log('🚀 Drag start');
                dragSrcEl = this;

                // Store source data
                const srcContainer = this.closest('.tier-items');
                const srcBoardContainer = this.closest('.admin-board-section');
                dragSrcData = {
                    boardId: srcContainer.dataset.boardId,
                    tierId: srcContainer.dataset.tierId,
                    itemId: this.dataset.itemId,
                    boardElement: srcBoardContainer
                };

                console.log('Source data:', dragSrcData);

                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
                this.style.opacity = '0.4';
            }

            function handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            }

            function handleDragEnter(e) {
                if (this !== dragSrcEl && dragSrcData) {
                    const targetContainer = this.closest('.tier-items');
                    const targetBoardContainer = this.closest('.admin-board-section');
                    const srcBoardContainer = dragSrcData.boardElement;

                    // Check if same board (allow cross-tier within same board)
                    if (srcBoardContainer === targetBoardContainer) {
                        this.style.borderColor = '#22c55e';
                        this.style.borderWidth = '2px';
                        console.log('✅ Valid drop target (same board)');
                    } else {
                        this.style.borderColor = '#ef4444';
                        this.style.borderWidth = '2px';
                        console.log('❌ Invalid drop target (different board)');
                    }
                }
            }

            function handleDragLeave(e) {
                this.style.borderColor = '#334155';
                this.style.borderWidth = '1px';
            }

            function handleDrop(e) {
                console.log('📍 Drop event');
                if (e.stopPropagation) {
                    e.stopPropagation();
                }

                if (dragSrcEl !== this && dragSrcData) {
                    const srcContainer = dragSrcEl.closest('.tier-items');
                    const targetContainer = this.closest('.tier-items');
                    const targetBoardContainer = this.closest('.admin-board-section');
                    const srcBoardContainer = dragSrcData.boardElement;

                    // Only allow within same board
                    if (srcBoardContainer !== targetBoardContainer) {
                        console.log('❌ Cannot drop across different boards');
                        this.style.borderColor = '#334155';
                        this.style.borderWidth = '1px';
                        return false;
                    }

                    const targetBoardId = targetContainer.dataset.boardId;
                    const targetTierId = targetContainer.dataset.tierId;

                    console.log('Target:', { boardId: targetBoardId, tierId: targetTierId });

                    // Same tier - reorder
                    if (srcContainer === targetContainer) {
                        console.log('📊 Same tier - reordering...');
                        const allItems = Array.from(srcContainer.querySelectorAll('.tier-item-card'));
                        const srcIndex = allItems.indexOf(dragSrcEl);
                        const targetIndex = allItems.indexOf(this);

                        console.log('Indices:', { src: srcIndex, target: targetIndex });

                        if (srcIndex !== targetIndex) {
                            const board = aiRankingsData.boards.find(b => b.id === dragSrcData.boardId);
                            if (board) {
                                const tier = board.tiers.find(t => t.id === dragSrcData.tierId);
                                if (tier && tier.items) {
                                    const items = [...tier.items];
                                    const [movedItem] = items.splice(srcIndex, 1);
                                    items.splice(targetIndex, 0, movedItem);

                                    console.log('Calling reorder API...');
                                    reorderRankingItems(dragSrcData.boardId, dragSrcData.tierId, items);
                                }
                            }
                        }
                    }
                    // Different tier - move
                    else {
                        console.log('🔄 Cross-tier - moving...');
                        const targetItems = Array.from(targetContainer.querySelectorAll('.tier-item-card'));
                        const targetIndex = targetItems.indexOf(this);

                        console.log('Moving to index:', targetIndex);
                        console.log('Calling move-tier API...');

                        moveItemToTier(
                            dragSrcData.boardId,
                            dragSrcData.itemId,
                            dragSrcData.tierId,
                            targetTierId,
                            targetIndex
                        );
                    }
                }

                this.style.borderColor = '#334155';
                this.style.borderWidth = '1px';
                return false;
            }

            // Handle drop on empty tier containers
            function handleContainerDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            }

            function handleContainerDragEnter(e) {
                if (dragSrcData) {
                    const targetBoardContainer = this.closest('.admin-board-section');
                    const srcBoardContainer = dragSrcData.boardElement;

                    if (srcBoardContainer === targetBoardContainer) {
                        this.style.backgroundColor = 'rgba(34, 197, 94, 0.1)';
                        console.log('✅ Valid drop container (same board)');
                    } else {
                        this.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
                        console.log('❌ Invalid drop container (different board)');
                    }
                }
            }

            function handleContainerDragLeave(e) {
                this.style.backgroundColor = '';
            }

            function handleContainerDrop(e) {
                console.log('📍 Drop on empty container');
                if (e.stopPropagation) {
                    e.stopPropagation();
                }

                if (dragSrcData) {
                    const targetBoardContainer = this.closest('.admin-board-section');
                    const srcBoardContainer = dragSrcData.boardElement;

                    if (srcBoardContainer !== targetBoardContainer) {
                        console.log('❌ Cannot drop across different boards');
                        this.style.backgroundColor = '';
                        return false;
                    }

                    const targetBoardId = this.dataset.boardId;
                    const targetTierId = this.dataset.tierId;

                    console.log('Dropping to empty tier:', { boardId: targetBoardId, tierId: targetTierId });
                    console.log('Calling move-tier API...');

                    moveItemToTier(
                        dragSrcData.boardId,
                        dragSrcData.itemId,
                        dragSrcData.tierId,
                        targetTierId,
                        0 // First position in empty tier
                    );
                }

                this.style.backgroundColor = '';
                return false;
            }

            function handleDragEnd(e) {
                console.log('🏁 Drag end');
                this.style.opacity = '1';

                tierItems.forEach(item => {
                    item.style.borderColor = '#334155';
                    item.style.borderWidth = '1px';
                });

                tierContainers.forEach(container => {
                    container.style.backgroundColor = '';
                });

                dragSrcData = null;
            }

            // Add event listeners to tier items
            tierItems.forEach(item => {
                // Make sure buttons don't interfere
                const buttons = item.querySelectorAll('button');
                buttons.forEach(btn => {
                    btn.setAttribute('draggable', 'false');
                    btn.addEventListener('mousedown', (e) => e.stopPropagation());
                    btn.addEventListener('click', (e) => e.stopPropagation());
                });

                item.addEventListener('dragstart', handleDragStart, false);
                item.addEventListener('dragenter', handleDragEnter, false);
                item.addEventListener('dragover', handleDragOver, false);
                item.addEventListener('dragleave', handleDragLeave, false);
                item.addEventListener('drop', handleDrop, false);
                item.addEventListener('dragend', handleDragEnd, false);
            });

            // Add event listeners to tier containers (for empty tiers)
            tierContainers.forEach(container => {
                container.addEventListener('dragover', handleContainerDragOver, false);
                container.addEventListener('dragenter', handleContainerDragEnter, false);
                container.addEventListener('dragleave', handleContainerDragLeave, false);
                container.addEventListener('drop', handleContainerDrop, false);
            });

            console.log('✅ Drag and drop initialized with FULL cross-tier support');
        }

        // Move item to different tier
        async function moveItemToTier(boardId, itemId, fromTierId, toTierId, targetIndex) {
            try {
                console.log('🚀 API call: moveItemToTier');
                console.log('Parameters:', { boardId, itemId, fromTierId, toTierId, targetIndex });

                const res = await fetch('/api/admin/ai-rankings/move-tier', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ boardId, itemId, fromTierId, toTierId, targetIndex })
                });

                if (res.ok) {
                    console.log('✅ Move successful');
                    showRankingsAlert('移动成功！', 'success');
                    loadAiRankings();
                } else {
                    const data = await res.json();
                    console.error('❌ Move failed:', data.error);
                    showRankingsAlert(data.error || '移动失败', 'error');
                    loadAiRankings();
                }
            } catch (e) {
                console.error('❌ Network error:', e);
                showRankingsAlert('网络错误，移动失败', 'error');
                loadAiRankings();
            }
        }

        // Save reordered items to backend
        async function reorderRankingItems(boardId, tierId, items) {
            try {
                const res = await fetch('/api/admin/ai-rankings/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ boardId, tierId, items })
                });

                if (res.ok) {
                    showRankingsAlert('排序已更新！', 'success');
                    loadAiRankings();
                } else {
                    showRankingsAlert('排序更新失败', 'error');
                    loadAiRankings(); // Reload to restore original order
                }
            } catch (e) {
                showRankingsAlert('网络错误，排序更新失败', 'error');
                loadAiRankings(); // Reload to restore original order
            }
        }

        // Add new board
        async function addNewBoard() {
            const name = document.getElementById('new-board-name').value.trim();
            const description = document.getElementById('new-board-desc').value.trim();

            if (!name) {
                showRankingsAlert('请输入榜单名称', 'error');
                return;
            }

            try {
                const res = await fetch('/api/admin/ai-rankings/board', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ name, description })
                });

                if (res.ok) {
                    showRankingsAlert('创建成功！', 'success');
                    document.getElementById('new-board-name').value = '';
                    document.getElementById('new-board-desc').value = '';
                    loadAiRankings();
                } else if (res.status === 401) {
                    showRankingsAlert('未授权，请重新登录', 'error');
                } else {
                    const data = await res.json();
                    showRankingsAlert(data.error || '创建失败', 'error');
                }
            } catch (e) {
                showRankingsAlert('网络错误，创建失败', 'error');
            }
        }

        // Edit board
        async function editBoard(boardId) {
            const board = aiRankingsData.boards.find(b => b.id === boardId);
            if (!board) return;

            const newName = prompt('榜单名称:', board.name);
            if (newName === null) return;

            const newDesc = prompt('榜单描述:', board.description || '');
            if (newDesc === null) return;

            try {
                const res = await fetch(`/api/admin/ai-rankings/board/${boardId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ name: newName.trim() || board.name, description: newDesc.trim() })
                });

                if (res.ok) {
                    showRankingsAlert('更新成功！', 'success');
                    loadAiRankings();
                } else {
                    showRankingsAlert('更新失败', 'error');
                }
            } catch (e) {
                showRankingsAlert('网络错误，更新失败', 'error');
            }
        }

        // Delete board
        async function deleteBoard(boardId) {
            if (!confirm('确定要删除这个排行榜吗？所有项目都会被删除！')) return;

            try {
                const res = await fetch(`/api/admin/ai-rankings/board/${boardId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    showRankingsAlert('删除成功！', 'success');
                    loadAiRankings();
                } else {
                    const data = await res.json();
                    showRankingsAlert(data.error || '删除失败', 'error');
                }
            } catch (e) {
                showRankingsAlert('网络错误，删除失败', 'error');
            }
        }

        // Upload ranking image
        async function uploadRankingImage(input) {
            if (!input.files || !input.files[0]) return;

            const formData = new FormData();
            formData.append('image', input.files[0]);

            try {
                const res = await fetch('/api/admin/ai-rankings/upload', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('ranking-item-image').value = data.url;
                    const preview = document.getElementById('ranking-image-preview');
                    preview.src = data.url;
                    preview.style.display = 'block';
                    showRankingsAlert('图片上传成功！', 'success');
                } else {
                    showRankingsAlert('图片上传失败', 'error');
                }
            } catch (e) {
                showRankingsAlert('网络错误，上传失败', 'error');
            }
        }

        // Add new ranking item
        async function addRankingItem() {
            const boardId = document.getElementById('ranking-board-select').value;
            const tierId = document.getElementById('ranking-tier-select').value;
            const name = document.getElementById('ranking-item-name').value.trim();
            const image = document.getElementById('ranking-item-image').value.trim();
            const link = document.getElementById('ranking-item-link').value.trim();
            const description = document.getElementById('ranking-item-desc').value.trim();

            if (!boardId) {
                showRankingsAlert('请选择榜单', 'error');
                return;
            }
            if (!tierId) {
                showRankingsAlert('请选择层级', 'error');
                return;
            }
            if (!name) {
                showRankingsAlert('请输入AI名称', 'error');
                return;
            }

            try {
                const res = await fetch('/api/admin/ai-rankings/item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ boardId, tierId, name, image, link, description })
                });

                if (res.ok) {
                    showRankingsAlert('添加成功！', 'success');
                    // Clear form
                    document.getElementById('ranking-item-name').value = '';
                    document.getElementById('ranking-item-image').value = '';
                    document.getElementById('ranking-item-link').value = '';
                    document.getElementById('ranking-item-desc').value = '';
                    document.getElementById('ranking-image-preview').style.display = 'none';
                    // Reload rankings
                    loadAiRankings();
                } else if (res.status === 401) {
                    showRankingsAlert('未授权，请重新登录', 'error');
                } else {
                    const data = await res.json();
                    showRankingsAlert(data.error || '添加失败', 'error');
                }
            } catch (e) {
                showRankingsAlert('网络错误，添加失败', 'error');
            }
        }

        // Delete ranking item
        async function deleteRankingItem(itemId) {
            if (!confirm('确定要删除这个项目吗？')) return;

            try {
                const res = await fetch(`/api/admin/ai-rankings/item/${itemId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    showRankingsAlert('删除成功！', 'success');
                    loadAiRankings();
                } else if (res.status === 401) {
                    showRankingsAlert('未授权，请重新登录', 'error');
                } else {
                    showRankingsAlert('删除失败', 'error');
                }
            } catch (e) {
                showRankingsAlert('网络错误，删除失败', 'error');
            }
        }

        // Edit ranking item
        async function editRankingItem(boardId, tierId, itemId) {
            // Find the item
            const board = aiRankingsData.boards.find(b => b.id === boardId);
            if (!board) return;
            const tier = board.tiers.find(t => t.id === tierId);
            if (!tier) return;
            const item = tier.items.find(i => i.id === itemId);
            if (!item) return;

            const newName = prompt('AI名称:', item.name);
            if (newName === null) return;

            const newImage = prompt('图片URL:', item.image || '');
            if (newImage === null) return;

            const newLink = prompt('访问链接:', item.link || '');
            if (newLink === null) return;

            const newDesc = prompt('描述:', item.description || '');
            if (newDesc === null) return;

            try {
                const res = await fetch(`/api/admin/ai-rankings/item/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        boardId,
                        tierId,
                        name: newName.trim() || item.name,
                        image: newImage.trim(),
                        link: newLink.trim(),
                        description: newDesc.trim()
                    })
                });

                if (res.ok) {
                    showRankingsAlert('更新成功！', 'success');
                    loadAiRankings();
                } else if (res.status === 401) {
                    showRankingsAlert('未授权，请重新登录', 'error');
                } else {
                    showRankingsAlert('更新失败', 'error');
                }
            } catch (e) {
                showRankingsAlert('网络错误，更新失败', 'error');
            }
        }

        // Show rankings alert
        function showRankingsAlert(message, type) {
            const alertContainer = document.getElementById('ai-rankings-alert');
            if (!alertContainer) return;

            alertContainer.innerHTML = `<div class="alert alert-${type}">${escapeHtml(message)}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 3000);
        }

        // ========== Site Settings ==========

        // Load site settings
        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                if (res.ok) {
                    const data = await res.json();
                    // 基本信息
                    document.getElementById('site-name').value = data.siteName || 'Aethrix | 以太夜';
                    document.getElementById('site-browser-title').value = data.browserTitle || data.siteName || 'Aethrix | 以太夜';
                    document.getElementById('site-slogan').value = data.slogan || '';
                    document.getElementById('site-seo').value = data.seoDescription || '';
                    document.getElementById('site-notice').value = data.notice || '';

                    // 更新后台标题中的站点名称
                    const adminSiteName = document.getElementById('admin-site-name');
                    if (adminSiteName) {
                        adminSiteName.textContent = data.siteName || 'Aethrix | 以太夜';
                    }
                    // 更新页面标题
                    document.title = (data.siteName || 'Aethrix | 以太夜') + ' - 管理后台';

                    // 精选作品
                    if (data.portfolio) {
                        document.getElementById('portfolio-title').value = data.portfolio.title || '精选作品';
                        document.getElementById('portfolio-subtitle').value = data.portfolio.subtitle || '';
                        document.getElementById('portfolio-filters').value = (data.portfolio.filters || []).join(', ');
                        renderPortfolioCategories();
                        renderPortfolioItems(data.portfolio.items || []);
                    } else {
                        renderPortfolioCategories();
                        renderPortfolioItems([]);
                    }

                    // 专业服务
                    if (data.services) {
                        document.getElementById('services-title').value = data.services.title || '专业服务';
                        document.getElementById('services-subtitle').value = data.services.subtitle || '';
                        renderServiceItems(data.services.items || []);
                    } else {
                        renderServiceItems([]);
                    }

                    // 关于我们
                    if (data.about) {
                        document.getElementById('about-title').value = data.about.title || '关于我们';
                        document.getElementById('about-subtitle').value = data.about.subtitle || '';
                        document.getElementById('about-content').value = data.about.content || '';
                        document.getElementById('about-image').value = data.about.image || '';
                        updateAboutImagePreview(data.about.image);
                        renderStatItems(data.about.stats || []);
                    } else {
                        renderStatItems([]);
                    }

                    // 页脚
                    if (data.footer) {
                        document.getElementById('footer-copyright').value = data.footer.copyright || '';
                        document.getElementById('footer-tools').value = data.footer.toolsFooter || '© 2024 Aethrix | 以太夜. 以太夜漫漫，粒子生生不息';
                        document.getElementById('footer-email').value = data.footer.email || '';
                        document.getElementById('footer-phone').value = data.footer.phone || '';
                        document.getElementById('footer-address').value = data.footer.address || '';
                    }

                    // AI 助手配置
                    if (data.aiAssistant) {
                        document.getElementById('ai-enabled').checked = data.aiAssistant.enabled !== false;
                        document.getElementById('ai-api-endpoint').value = data.aiAssistant.apiEndpoint || '';
                        document.getElementById('ai-model-name').value = data.aiAssistant.modelName || '';
                        document.getElementById('ai-api-key').value = data.aiAssistant.apiKey || '';
                        document.getElementById('ai-system-prompt').value = data.aiAssistant.systemPrompt || '';
                        document.getElementById('ai-max-tokens').value = data.aiAssistant.maxTokens || 2048;
                        document.getElementById('ai-temperature').value = data.aiAssistant.temperature || 0.7;
                        document.getElementById('ai-auto-switch').checked = data.aiAssistant.autoSwitch === true;
                        // Load saved models list
                        savedModels = data.aiAssistant.savedModels || [];
                        renderSavedModels();
                    }

                    // 更新Tab标签显示
                    updateSettingsTabLabel('portfolio', data.portfolio?.title || '精选作品');
                    updateSettingsTabLabel('services', data.services?.title || '专业服务');
                    updateSettingsTabLabel('about', data.about?.title || '关于我们');
                }
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        // ========== Settings Tab Functions ==========

        // Switch settings tab
        function switchSettingsTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.settings-tab-btn[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            const activeContent = document.getElementById(`settings-tab-${tabName}`);
            activeContent.classList.add('active');
            activeContent.style.display = 'block';
        }

        // Update settings tab label (real-time sync with title input)
        function updateSettingsTabLabel(tabName, value) {
            const labelEl = document.getElementById(`tab-label-${tabName}`);
            if (!labelEl) return;

            const icons = {
                'portfolio': '',
                'services': '',
                'about': ''
            };

            const icon = icons[tabName] || '';
            const displayValue = value.trim() || getDefaultTabLabel(tabName);
            labelEl.textContent = displayValue;
        }

        // Get default tab label
        function getDefaultTabLabel(tabName) {
            const defaults = {
                'basic': '基本信息',
                'portfolio': '精选作品',
                'services': '专业服务',
                'about': '关于我们',
                'ai-assistant': 'AI 助手'
            };
            return defaults[tabName] || tabName;
        }

        // ========== Dynamic Items Rendering ==========

        // Show settings alert
        function showSettingsAlert(msg, type) {
            const alert = document.getElementById('settings-alert');
            if (!alert) return;
            alert.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => { alert.innerHTML = ''; }, 3000);
        }

        // ========== Category Management Functions ==========

        // Render portfolio categories as tags
        function renderPortfolioCategories() {
            const container = document.getElementById('portfolio-categories-list');
            const filtersInput = document.getElementById('portfolio-filters');
            const filters = filtersInput.value.split(',').map(s => s.trim()).filter(s => s);

            container.innerHTML = filters.map((filter, index) => {
                const isFixed = filter === '全部';
                return `
                    <span class="category-tag ${isFixed ? 'fixed' : ''}">
                        ${escapeHtml(filter)}
                        ${!isFixed ? `<button type="button" class="category-tag-remove" onclick="removePortfolioCategory(${index})">✕</button>` : ''}
                    </span>
                `;
            }).join('');
        }

        // Add a new portfolio category
        function addPortfolioCategory() {
            const input = document.getElementById('new-category-input');
            const newCategory = input.value.trim();

            if (!newCategory) {
                showSettingsAlert('请输入分类名称', 'error');
                return;
            }

            const filtersInput = document.getElementById('portfolio-filters');
            const filters = filtersInput.value.split(',').map(s => s.trim()).filter(s => s);

            // Check if category already exists
            if (filters.some(f => f.toLowerCase() === newCategory.toLowerCase())) {
                showSettingsAlert('该分类已存在', 'error');
                return;
            }

            // Add new category
            filters.push(newCategory);
            filtersInput.value = filters.join(', ');

            // Clear input and re-render
            input.value = '';
            renderPortfolioCategories();

            // Re-render portfolio items to update category dropdowns
            const items = collectPortfolioItems();
            renderPortfolioItems(items);

            showSettingsAlert('分类已添加', 'success');
        }

        // Remove a portfolio category
        function removePortfolioCategory(index) {
            const filtersInput = document.getElementById('portfolio-filters');
            const filters = filtersInput.value.split(',').map(s => s.trim()).filter(s => s);

            // Don't allow removing "全部"
            if (filters[index] === '全部') {
                showSettingsAlert('不能删除"全部"分类', 'error');
                return;
            }

            // Remove category
            filters.splice(index, 1);
            filtersInput.value = filters.join(', ');

            // Re-render
            renderPortfolioCategories();

            // Re-render portfolio items to update category dropdowns
            const items = collectPortfolioItems();
            renderPortfolioItems(items);

            showSettingsAlert('分类已删除', 'success');
        }

        // Get categories from filters input
        function getPortfolioCategories() {
            const filtersInput = document.getElementById('portfolio-filters').value;
            const filters = filtersInput.split(',').map(s => s.trim()).filter(s => s && s !== '全部');
            // Map display names to category values
            const categoryMap = {
                'AI 工具': 'ai-tools',
                '网页设计': 'web-design',
                '品牌设计': 'branding',
                '应用': 'app'
            };
            return filters.map(f => {
                // Check if it's a known category
                for (const [name, value] of Object.entries(categoryMap)) {
                    if (f.includes(name)) return { name: f, value: value };
                }
                // For custom categories, create a slug
                return { name: f, value: f.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]/g, '-') };
            });
        }

        // Render portfolio items
        function renderPortfolioItems(items) {
            const container = document.getElementById('portfolio-items-list');
            const categories = getPortfolioCategories();

            if (items.length === 0) {
                container.innerHTML = '<div class="empty-list-hint">暂无作品，点击下方按钮添加</div>';
                return;
            }

            container.innerHTML = items.map((item, index) => `
                <div class="dynamic-item collapsed" data-index="${index}">
                    <div class="dynamic-item-header" onclick="togglePortfolioItem(this)">
                        <div style="display:flex;align-items:center;">
                            <span class="dynamic-item-toggle">▼</span>
                            <span class="dynamic-item-title">作品 ${index + 1}</span>
                            <span class="dynamic-item-preview">${escapeHtml(item.title || '未命名')}</span>
                        </div>
                        <button type="button" class="dynamic-item-delete" onclick="event.stopPropagation();removePortfolioItem(${index})">✕</button>
                    </div>
                    <div class="dynamic-item-body">
                        <div class="form-group">
                            <label class="form-label">标题</label>
                            <input type="text" class="form-input portfolio-item-title" value="${escapeHtml(item.title || '')}" placeholder="作品标题" oninput="updatePortfolioPreview(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">描述</label>
                            <textarea class="form-textarea portfolio-item-desc" rows="2" placeholder="作品描述">${escapeHtml(item.description || '')}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">封面图片 <span style="color:#64748b;font-weight:normal;font-size:11px;">（推荐比例 4:3，如 800×600 或 1200×900）</span></label>
                            <div style="display:flex;gap:8px;align-items:flex-start;">
                                <input type="text" class="form-input portfolio-item-image" value="${escapeHtml(item.image || '')}" placeholder="图片URL (留空则显示默认占位图)" style="flex:1;">
                                <input type="file" id="portfolio-image-upload-${index}" accept="image/*" style="display:none;" onchange="handlePortfolioImageUpload(this, ${index})">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('portfolio-image-upload-${index}').click()" style="white-space:nowrap;">上传图片</button>
                            </div>
                            ${item.image ? `<div style="margin-top:8px;"><img src="${escapeHtml(item.image)}" style="max-width:200px;max-height:120px;border-radius:8px;border:1px solid #334155;"></div>` : ''}
                        </div>
                        <div class="form-group">
                            <label class="form-label">链接 (点击跳转，AI工具填 tools 会跳转到AI工具页)</label>
                            <input type="text" class="form-input portfolio-item-link" value="${escapeHtml(item.link || '')}" placeholder="https://... 或 tools">
                        </div>
                        <div class="dynamic-item-row">
                            <div class="form-group">
                                <label class="form-label">分类</label>
                                <select class="form-select portfolio-item-category">
                                    ${categories.map(cat =>
                `<option value="${escapeHtml(cat.value)}" ${item.category === cat.value ? 'selected' : ''}>${escapeHtml(cat.name)}</option>`
            ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">标签 (逗号分隔)</label>
                                <input type="text" class="form-input portfolio-item-tags" value="${(item.tags || []).join(', ')}" placeholder="标签1, 标签2">
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Handle portfolio image upload
        async function handlePortfolioImageUpload(input, index) {
            const file = input.files[0];
            if (!file) return;

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showSettingsAlert('图片大小不能超过 5MB', 'error');
                return;
            }

            // Check file type
            if (!file.type.startsWith('image/')) {
                showSettingsAlert('请选择图片文件', 'error');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    // Update the image input field
                    const container = document.getElementById('portfolio-items-list');
                    const itemEl = container.querySelectorAll('.dynamic-item')[index];
                    if (itemEl) {
                        const imageInput = itemEl.querySelector('.portfolio-item-image');
                        if (imageInput) {
                            imageInput.value = data.url;
                            // Re-render to show preview
                            const items = collectPortfolioItems();
                            renderPortfolioItems(items);
                        }
                    }
                    showSettingsAlert('图片上传成功', 'success');
                } else {
                    const error = await response.json();
                    showSettingsAlert(error.error || '上传失败', 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showSettingsAlert('上传失败: ' + error.message, 'error');
            }
        }

        // Handle about image upload
        async function handleAboutImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showSettingsAlert('图片大小不能超过 5MB', 'error');
                return;
            }

            // Check file type
            if (!file.type.startsWith('image/')) {
                showSettingsAlert('请选择图片文件', 'error');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('about-image').value = data.url;
                    updateAboutImagePreview(data.url);
                    showSettingsAlert('图片上传成功', 'success');
                } else {
                    const error = await response.json();
                    showSettingsAlert(error.error || '上传失败', 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showSettingsAlert('上传失败: ' + error.message, 'error');
            }
        }

        // Update about image preview
        function updateAboutImagePreview(imageUrl) {
            const previewContainer = document.getElementById('about-image-preview');
            if (imageUrl && imageUrl.trim()) {
                previewContainer.innerHTML = `<img src="${escapeHtml(imageUrl)}" style="max-width:300px;max-height:200px;border-radius:8px;border:1px solid #334155;">`;
            } else {
                previewContainer.innerHTML = '';
            }
        }

        // Toggle portfolio item collapse state
        function togglePortfolioItem(header) {
            const item = header.closest('.dynamic-item');
            item.classList.toggle('collapsed');
        }

        // Update portfolio item preview text
        function updatePortfolioPreview(input) {
            const item = input.closest('.dynamic-item');
            const preview = item.querySelector('.dynamic-item-preview');
            if (preview) {
                preview.textContent = input.value || '未命名';
            }
        }

        // Add portfolio item
        function addPortfolioItem() {
            const items = collectPortfolioItems();
            const categories = getPortfolioCategories();
            const defaultCategory = categories.length > 0 ? categories[0].value : 'ai-tools';
            items.push({ title: '', description: '', category: defaultCategory, tags: [], link: '' });
            renderPortfolioItems(items);
        }

        // Remove portfolio item
        function removePortfolioItem(index) {
            const items = collectPortfolioItems();
            items.splice(index, 1);
            renderPortfolioItems(items);
        }

        // Collect portfolio items from DOM
        function collectPortfolioItems() {
            const container = document.getElementById('portfolio-items-list');
            const itemEls = container.querySelectorAll('.dynamic-item');
            const items = [];
            itemEls.forEach(el => {
                const title = el.querySelector('.portfolio-item-title').value.trim();
                // Only include items with a title
                if (title) {
                    items.push({
                        title: title,
                        description: el.querySelector('.portfolio-item-desc').value.trim(),
                        category: el.querySelector('.portfolio-item-category').value,
                        tags: el.querySelector('.portfolio-item-tags').value.split(',').map(s => s.trim()).filter(s => s),
                        link: el.querySelector('.portfolio-item-link')?.value.trim() || '',
                        image: el.querySelector('.portfolio-item-image')?.value.trim() || ''
                    });
                }
            });
            return items;
        }

        // Initialize portfolio categories on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Categories are now managed via tag UI, no need for input listeners
        });

        // Render service items
        function renderServiceItems(items) {
            const container = document.getElementById('services-items-list');
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-list-hint">暂无服务，点击下方按钮添加</div>';
                return;
            }
            container.innerHTML = items.map((item, index) => `
                <div class="dynamic-item collapsed" data-index="${index}">
                    <div class="dynamic-item-header" onclick="toggleServiceItem(this)">
                        <div style="display:flex;align-items:center;">
                            <span class="dynamic-item-toggle">▼</span>
                            <span class="dynamic-item-title">服务 ${index + 1}</span>
                            <span class="dynamic-item-preview">${escapeHtml(item.title || '未命名')}</span>
                        </div>
                        <button type="button" class="dynamic-item-delete" onclick="event.stopPropagation();removeServiceItem(${index})">✕</button>
                    </div>
                    <div class="dynamic-item-body">
                        <div class="form-group">
                            <label class="form-label">标题</label>
                            <input type="text" class="form-input service-item-title" value="${escapeHtml(item.title || '')}" placeholder="服务标题" oninput="updateServicePreview(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">描述</label>
                            <textarea class="form-textarea service-item-desc" rows="2" placeholder="服务描述">${escapeHtml(item.description || '')}</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">图标</label>
                            <select class="form-select service-item-icon">
                                <option value="lightning" ${item.icon === 'lightning' ? 'selected' : ''}>闪电 - AI/快速</option>
                                <option value="monitor" ${item.icon === 'monitor' ? 'selected' : ''}>显示器 - 网站</option>
                                <option value="settings" ${item.icon === 'settings' ? 'selected' : ''}>齿轮 - 系统</option>
                                <option value="star" ${item.icon === 'star' ? 'selected' : ''}>星星 - 品牌</option>
                                <option value="code" ${item.icon === 'code' ? 'selected' : ''}>代码 - 开发</option>
                                <option value="database" ${item.icon === 'database' ? 'selected' : ''}>数据库 - 数据</option>
                                <option value="cloud" ${item.icon === 'cloud' ? 'selected' : ''}>云朵 - 云服务</option>
                                <option value="shield" ${item.icon === 'shield' ? 'selected' : ''}>盾牌 - 安全</option>
                                <option value="smartphone" ${item.icon === 'smartphone' ? 'selected' : ''}>手机 - 移动端</option>
                                <option value="palette" ${item.icon === 'palette' ? 'selected' : ''}>调色板 - 设计</option>
                                <option value="chart" ${item.icon === 'chart' ? 'selected' : ''}>图表 - 分析</option>
                                <option value="message" ${item.icon === 'message' ? 'selected' : ''}>消息 - 沟通</option>
                                <option value="globe" ${item.icon === 'globe' ? 'selected' : ''}>地球 - 全球化</option>
                                <option value="rocket" ${item.icon === 'rocket' ? 'selected' : ''}>火箭 - 启动</option>
                                <option value="heart" ${item.icon === 'heart' ? 'selected' : ''}>爱心 - 关怀</option>
                                <option value="lock" ${item.icon === 'lock' ? 'selected' : ''}>锁 - 隐私</option>
                            </select>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Toggle service item collapse state
        function toggleServiceItem(header) {
            const item = header.closest('.dynamic-item');
            item.classList.toggle('collapsed');
        }

        // Update service item preview text
        function updateServicePreview(input) {
            const item = input.closest('.dynamic-item');
            const preview = item.querySelector('.dynamic-item-preview');
            if (preview) {
                preview.textContent = input.value || '未命名';
            }
        }

        // Add service item
        function addServiceItem() {
            const items = collectServiceItems();
            items.push({ title: '', description: '', icon: 'star' });
            renderServiceItems(items);
        }

        // Remove service item
        function removeServiceItem(index) {
            const items = collectServiceItems();
            items.splice(index, 1);
            renderServiceItems(items);
        }

        // Collect service items from DOM
        function collectServiceItems() {
            const container = document.getElementById('services-items-list');
            const itemEls = container.querySelectorAll('.dynamic-item');
            const items = [];
            itemEls.forEach(el => {
                const title = el.querySelector('.service-item-title').value.trim();
                // Only include items with a title
                if (title) {
                    items.push({
                        title: title,
                        description: el.querySelector('.service-item-desc').value.trim(),
                        icon: el.querySelector('.service-item-icon').value
                    });
                }
            });
            return items;
        }

        // Render stat items
        function renderStatItems(items) {
            const container = document.getElementById('about-stats-list');
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-list-hint">暂无统计数据，点击下方按钮添加</div>';
                return;
            }
            container.innerHTML = items.map((item, index) => `
                <div class="dynamic-item" data-index="${index}">
                    <div class="dynamic-item-header">
                        <span class="dynamic-item-title">统计 ${index + 1}</span>
                        <button type="button" class="dynamic-item-delete" onclick="removeStatItem(${index})">✕</button>
                    </div>
                    <div class="dynamic-item-row">
                        <div class="form-group">
                            <label class="form-label">数值</label>
                            <input type="text" class="form-input stat-item-value" value="${escapeHtml(item.value || '')}" placeholder="如: 50+">
                        </div>
                        <div class="form-group">
                            <label class="form-label">标签</label>
                            <input type="text" class="form-input stat-item-label" value="${escapeHtml(item.label || '')}" placeholder="如: 完成项目">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Add stat item
        function addStatItem() {
            const items = collectStatItems();
            items.push({ value: '', label: '' });
            renderStatItems(items);
        }

        // Remove stat item
        function removeStatItem(index) {
            const items = collectStatItems();
            items.splice(index, 1);
            renderStatItems(items);
        }

        // Collect stat items from DOM
        function collectStatItems() {
            const container = document.getElementById('about-stats-list');
            const itemEls = container.querySelectorAll('.dynamic-item');
            const items = [];
            itemEls.forEach(el => {
                const value = el.querySelector('.stat-item-value').value.trim();
                // Only include items with a value
                if (value) {
                    items.push({
                        value: value,
                        label: el.querySelector('.stat-item-label').value.trim()
                    });
                }
            });
            return items;
        }

        // Save site settings
        async function saveSettings() {
            const portfolioItems = collectPortfolioItems();
            const serviceItems = collectServiceItems();
            const statItems = collectStatItems();

            console.log('Saving settings...');
            console.log('Portfolio items:', portfolioItems.length);
            console.log('Service items:', serviceItems.length);
            console.log('Stat items:', statItems.length);

            const settings = {
                siteName: document.getElementById('site-name').value.trim() || 'Aethrix | 以太夜',
                browserTitle: document.getElementById('site-browser-title').value.trim() || document.getElementById('site-name').value.trim() || 'Aethrix | 以太夜',
                slogan: document.getElementById('site-slogan').value.trim(),
                seoDescription: document.getElementById('site-seo').value.trim(),
                notice: document.getElementById('site-notice').value.trim(),
                portfolio: {
                    title: document.getElementById('portfolio-title').value.trim() || '精选作品',
                    subtitle: document.getElementById('portfolio-subtitle').value.trim(),
                    filters: document.getElementById('portfolio-filters').value.split(',').map(s => s.trim()).filter(s => s),
                    items: portfolioItems
                },
                services: {
                    title: document.getElementById('services-title').value.trim() || '专业服务',
                    subtitle: document.getElementById('services-subtitle').value.trim(),
                    items: serviceItems
                },
                about: {
                    title: document.getElementById('about-title').value.trim() || '关于我们',
                    subtitle: document.getElementById('about-subtitle').value.trim(),
                    content: document.getElementById('about-content').value.trim(),
                    image: document.getElementById('about-image').value.trim(),
                    stats: statItems
                },
                footer: {
                    copyright: document.getElementById('footer-copyright').value.trim(),
                    toolsFooter: document.getElementById('footer-tools').value.trim(),
                    email: document.getElementById('footer-email').value.trim(),
                    phone: document.getElementById('footer-phone').value.trim(),
                    address: document.getElementById('footer-address').value.trim()
                },
                aiAssistant: {
                    enabled: document.getElementById('ai-enabled').checked,
                    apiEndpoint: document.getElementById('ai-api-endpoint').value.trim(),
                    modelName: document.getElementById('ai-model-name').value.trim(),
                    apiKey: document.getElementById('ai-api-key').value.trim(),
                    systemPrompt: document.getElementById('ai-system-prompt').value.trim(),
                    maxTokens: parseInt(document.getElementById('ai-max-tokens').value) || 2048,
                    temperature: parseFloat(document.getElementById('ai-temperature').value) || 0.7,
                    autoSwitch: document.getElementById('ai-auto-switch').checked,
                    savedModels: savedModels
                }
            };

            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(settings)
                });
                if (res.ok) {
                    alert(`设置已保存！\n\n作品: ${portfolioItems.length} 项\n服务: ${serviceItems.length} 项\n统计: ${statItems.length} 项\n\n刷新首页查看效果`);
                } else if (res.status === 401) {
                    alert('未授权，请重新登录');
                } else {
                    alert('保存失败');
                }
            } catch (e) {
                console.error('Save error:', e);
                alert('网络错误，保存失败');
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        // ========== AI Assistant Config Functions ==========

        // Toggle API key visibility
        function toggleApiKeyVisibility() {
            const input = document.getElementById('ai-api-key');
            const toggleText = document.getElementById('api-key-toggle-text');
            if (input.type === 'password') {
                input.type = 'text';
                toggleText.textContent = '隐藏';
            } else {
                input.type = 'password';
                toggleText.textContent = '显示';
            }
        }

        // Model list management
        let savedModels = [];

        function renderSavedModels() {
            const container = document.getElementById('saved-models-list');
            if (!container) return;

            container.innerHTML = savedModels.map((model, index) => `
                <div class="model-tag" data-model="${model}">
                    <span onclick="selectModel('${model}')">${model}</span>
                    <button type="button" class="model-tag-delete" onclick="deleteModel(${index})">&times;</button>
                </div>
            `).join('');
        }

        function addModelToList() {
            const input = document.getElementById('ai-model-name');
            const modelName = input.value.trim();

            if (!modelName) {
                alert('请输入模型名称');
                return;
            }

            if (savedModels.includes(modelName)) {
                alert('该模型已存在');
                return;
            }

            savedModels.push(modelName);
            renderSavedModels();
            // Don't clear input - keep it as current selection
        }

        function deleteModel(index) {
            savedModels.splice(index, 1);
            renderSavedModels();
        }

        function selectModel(modelName) {
            document.getElementById('ai-model-name').value = modelName;
        }

        // Test AI connection
        async function testAIConnection() {
            const btnText = document.getElementById('test-ai-btn-text');
            const resultEl = document.getElementById('ai-test-result');

            const endpoint = document.getElementById('ai-api-endpoint').value.trim();
            const model = document.getElementById('ai-model-name').value.trim();
            const apiKey = document.getElementById('ai-api-key').value.trim();

            if (!endpoint || !model || !apiKey) {
                resultEl.innerHTML = '<span style="color:#ef4444;">请填写 API 端点、模型名称和 API Key</span>';
                return;
            }

            btnText.textContent = '测试中...';
            resultEl.innerHTML = '';

            try {
                const res = await fetch('/api/chat/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ endpoint, model, apiKey })
                });

                const data = await res.json();

                if (res.ok && data.success) {
                    resultEl.innerHTML = '<span style="color:#22c55e;">✓ 连接成功！</span>';
                } else {
                    resultEl.innerHTML = '<span style="color:#ef4444;">✗ ' + (data.error || '连接失败') + '</span>';
                }
            } catch (e) {
                console.error('Test AI connection error:', e);
                resultEl.innerHTML = '<span style="color:#ef4444;">✗ 网络错误</span>';
            } finally {
                btnText.textContent = '测试连接';
            }
        }

        // Enter key login
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-password').addEventListener('keypress', e => {
                if (e.key === 'Enter') performLogin();
            });
            checkLogin();
        });

        // ========== AI Tools Management ==========

        // Load categories for dropdown
        async function loadCategories() {
            try {
                const res = await fetch('/api/tools');
                if (res.ok) {
                    const data = await res.json();
                    const select = document.getElementById('tool-category');
                    select.innerHTML = data.categories.map(c =>
                        `<option value="${c.id}">${c.name}</option>`
                    ).join('');
                }
            } catch (e) {
                console.error('Failed to load categories:', e);
            }
        }

        // Load tools list
        async function loadTools() {
            try {
                const res = await fetch('/api/admin/tools', { credentials: 'include' });
                if (res.status === 401) {
                    showToolsAlert('请先登录管理员账号', 'error');
                    document.getElementById('tools-list').innerHTML =
                        '<div style="text-align:center;color:#ef4444;padding:20px;">未授权，请重新登录</div>';
                    return;
                }
                if (res.ok) {
                    const data = await res.json();
                    const tools = data.tools || [];
                    const categories = data.categories || [];

                    document.getElementById('tools-count').textContent = tools.length;

                    if (tools.length === 0) {
                        document.getElementById('tools-list').innerHTML =
                            '<div style="text-align:center;color:#64748b;padding:20px;">暂无工具，请添加第一个工具</div>';
                        return;
                    }

                    // Create category map for display
                    const categoryMap = {};
                    categories.forEach(c => categoryMap[c.id] = c.name);

                    document.getElementById('tools-list').innerHTML = tools.map(tool => `
                        <div class="tool-card" data-id="${tool.id}">
                            <div class="tool-card-header">
                                <div>
                                    <h4>${escapeHtml(tool.title)}<span class="tool-card-category">${escapeHtml(categoryMap[tool.category] || tool.category)}</span></h4>
                                </div>
                                <div class="tool-card-actions">
                                    <button class="btn btn-secondary btn-sm" onclick="editTool('${tool.id}')">编辑</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteTool('${tool.id}')">删除</button>
                                </div>
                            </div>
                            ${tool.description ? `<p class="tool-card-desc">${escapeHtml(tool.description)}</p>` : ''}
                            <a href="${escapeHtml(tool.url)}" class="tool-card-link" target="_blank">${escapeHtml(tool.url)}</a>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load tools:', e);
                document.getElementById('tools-list').innerHTML =
                    '<div style="text-align:center;color:#ef4444;padding:20px;">加载失败，请刷新重试</div>';
            }
        }

        // Save tool (create or update)
        async function saveTool() {
            const editId = document.getElementById('edit-tool-id').value;
            const title = document.getElementById('tool-title').value.trim();
            const description = document.getElementById('tool-desc').value.trim();
            const url = document.getElementById('tool-url').value.trim();
            const logo = document.getElementById('tool-logo').value.trim();
            const category = document.getElementById('tool-category').value;

            // Reset errors
            document.getElementById('tool-title-error').style.display = 'none';
            document.getElementById('tool-url-error').style.display = 'none';

            // Validate
            let hasError = false;
            if (!title) {
                document.getElementById('tool-title-error').textContent = '请输入工具标题';
                document.getElementById('tool-title-error').style.display = 'block';
                hasError = true;
            }
            if (!url) {
                document.getElementById('tool-url-error').textContent = '请输入工具链接';
                document.getElementById('tool-url-error').style.display = 'block';
                hasError = true;
            } else if (!isValidUrl(url)) {
                document.getElementById('tool-url-error').textContent = '请输入有效的URL地址';
                document.getElementById('tool-url-error').style.display = 'block';
                hasError = true;
            }

            if (hasError) return;

            const toolData = { title, description, url, category };
            if (logo) toolData.logo = logo; // Only include logo if provided

            try {
                let res;
                if (editId) {
                    // Update existing tool
                    res = await fetch(`/api/admin/tools/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(toolData)
                    });
                } else {
                    // Create new tool
                    res = await fetch('/api/admin/tools', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(toolData)
                    });
                }

                if (res.ok) {
                    showToolsAlert(editId ? '工具更新成功！' : '工具添加成功！', 'success');
                    clearToolForm();
                    loadTools();
                } else {
                    const data = await res.json();
                    showToolsAlert(data.error || '操作失败', 'error');
                }
            } catch (e) {
                showToolsAlert('网络错误，请重试', 'error');
            }
        }

        // Edit tool
        async function editTool(id) {
            try {
                const res = await fetch('/api/admin/tools', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    const tool = data.tools.find(t => t.id === id);
                    if (tool) {
                        document.getElementById('edit-tool-id').value = tool.id;
                        document.getElementById('tool-title').value = tool.title;
                        document.getElementById('tool-desc').value = tool.description || '';
                        document.getElementById('tool-url').value = tool.url;
                        document.getElementById('tool-logo').value = tool.logo || '';
                        document.getElementById('tool-category').value = tool.category;
                        document.getElementById('tool-form-title').textContent = '编辑工具';
                        document.getElementById('cancel-edit-btn').style.display = 'inline-block';

                        // Scroll to form
                        document.getElementById('section-tools').scrollIntoView({ behavior: 'smooth' });
                    }
                }
            } catch (e) {
                showToolsAlert('加载工具信息失败', 'error');
            }
        }

        // Delete tool
        async function deleteTool(id) {
            if (!confirm('确定要删除这个工具吗？')) return;

            try {
                const res = await fetch(`/api/admin/tools/${id}`, { method: 'DELETE', credentials: 'include' });
                if (res.ok) {
                    showToolsAlert('工具已删除', 'success');
                    loadTools();
                } else {
                    const data = await res.json();
                    showToolsAlert(data.error || '删除失败', 'error');
                }
            } catch (e) {
                showToolsAlert('网络错误，请重试', 'error');
            }
        }

        // Cancel edit
        function cancelEdit() {
            clearToolForm();
        }

        // Clear tool form
        function clearToolForm() {
            document.getElementById('edit-tool-id').value = '';
            document.getElementById('tool-title').value = '';
            document.getElementById('tool-desc').value = '';
            document.getElementById('tool-url').value = '';
            document.getElementById('tool-logo').value = '';
            document.getElementById('tool-category').selectedIndex = 0;
            document.getElementById('tool-form-title').textContent = '添加新工具';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('tool-title-error').style.display = 'none';
            document.getElementById('tool-url-error').style.display = 'none';
        }

        // Show tools alert
        function showToolsAlert(msg, type) {
            const alert = document.getElementById('tools-alert');
            alert.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => { alert.innerHTML = ''; }, 3000);
        }

        // Validate URL
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // ========== Category Management ==========

        // Store for category data
        let categoryData = { categories: [], tools: [] };
        let expandedCategories = new Set();

        // Load categories with tools
        async function loadCategoriesWithTools() {
            try {
                const res = await fetch('/api/admin/tools', { credentials: 'include' });
                if (res.status === 401) {
                    showCategoriesAlert('请先登录管理员账号', 'error');
                    document.getElementById('categories-list').innerHTML =
                        '<div style="text-align:center;color:#ef4444;padding:20px;">未授权，请重新登录</div>';
                    document.getElementById('categories-count').textContent = '0';
                    return;
                }
                if (res.ok) {
                    categoryData = await res.json();
                    renderCategories();
                }
            } catch (e) {
                console.error('Failed to load categories:', e);
                document.getElementById('categories-list').innerHTML =
                    '<div style="text-align:center;color:#ef4444;padding:20px;">加载失败，请刷新重试</div>';
            }
        }

        // Render categories list
        function renderCategories() {
            const { categories, tools } = categoryData;

            document.getElementById('categories-count').textContent = categories.length;

            if (categories.length === 0) {
                document.getElementById('categories-list').innerHTML =
                    '<div style="text-align:center;color:#64748b;padding:20px;">暂无分类</div>';
                return;
            }

            // Sort categories by order
            const sortedCategories = [...categories].sort((a, b) => a.order - b.order);

            document.getElementById('categories-list').innerHTML = sortedCategories.map(cat => {
                const categoryTools = tools
                    .filter(t => t.category === cat.id)
                    .sort((a, b) => (a.order || 0) - (b.order || 0));
                const isExpanded = expandedCategories.has(cat.id);

                return `
                    <div class="category-expandable" data-category-id="${cat.id}">
                        <div class="category-header ${isExpanded ? 'expanded' : ''}" onclick="toggleCategory('${cat.id}')">
                            <span class="category-name">${escapeHtml(cat.name)}</span>
                            <span class="category-count">${categoryTools.length} 个工具</span>
                            <span class="expand-icon">▼</span>
                        </div>
                        <div class="category-tools ${isExpanded ? 'expanded' : ''}" id="category-tools-${cat.id}">
                            <div class="category-tools-inner">
                                ${categoryTools.length === 0
                        ? '<div class="empty-category">该分类暂无工具</div>'
                        : categoryTools.map(tool => `
                                        <div class="category-tool-item" 
                                             data-tool-id="${tool.id}" 
                                             data-category-id="${cat.id}"
                                             draggable="true"
                                             ondragstart="handleDragStart(event)"
                                             ondragover="handleDragOver(event)"
                                             ondrop="handleDrop(event)"
                                             ondragend="handleDragEnd(event)">
                                            <span class="drag-handle">☰</span>
                                            <div class="tool-item-info">
                                                <div class="tool-item-title">${escapeHtml(tool.title)}</div>
                                                <div class="tool-item-url">${escapeHtml(tool.url)}</div>
                                            </div>
                                            <button class="tool-item-delete" onclick="deleteToolFromCategory(event, '${tool.id}')" title="删除工具">×</button>
                                        </div>
                                    `).join('')
                    }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle category expand/collapse
        function toggleCategory(categoryId) {
            if (expandedCategories.has(categoryId)) {
                expandedCategories.delete(categoryId);
            } else {
                expandedCategories.add(categoryId);
            }

            // Update UI
            const header = document.querySelector(`.category-expandable[data-category-id="${categoryId}"] .category-header`);
            const toolsContainer = document.getElementById(`category-tools-${categoryId}`);

            if (header && toolsContainer) {
                header.classList.toggle('expanded');
                toolsContainer.classList.toggle('expanded');
            }
        }

        // Delete tool from category
        async function deleteToolFromCategory(event, toolId) {
            event.stopPropagation();

            if (!confirm('确定要删除这个工具吗？')) return;

            try {
                const res = await fetch(`/api/admin/tools/${toolId}`, { method: 'DELETE', credentials: 'include' });
                if (res.ok) {
                    showCategoriesAlert('工具已删除', 'success');
                    // Update local data and re-render
                    categoryData.tools = categoryData.tools.filter(t => t.id !== toolId);
                    renderCategories();
                    // Also refresh tools list if on that section
                    loadTools();
                } else {
                    const data = await res.json();
                    showCategoriesAlert(data.error || '删除失败', 'error');
                }
            } catch (e) {
                showCategoriesAlert('网络错误，请重试', 'error');
            }
        }

        // Show categories alert
        function showCategoriesAlert(msg, type) {
            const alert = document.getElementById('categories-alert');
            alert.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => { alert.innerHTML = ''; }, 3000);
        }

        // ========== Drag and Drop for Tool Reordering ==========

        let draggedElement = null;
        let draggedToolId = null;
        let draggedCategoryId = null;

        function handleDragStart(event) {
            draggedElement = event.target.closest('.category-tool-item');
            if (!draggedElement) return;

            draggedToolId = draggedElement.dataset.toolId;
            draggedCategoryId = draggedElement.dataset.categoryId;

            draggedElement.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', draggedToolId);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';

            const targetItem = event.target.closest('.category-tool-item');
            if (!targetItem || targetItem === draggedElement) return;

            // Only allow reordering within same category
            if (targetItem.dataset.categoryId !== draggedCategoryId) return;

            // Remove drag-over class from all items
            document.querySelectorAll('.category-tool-item.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });

            targetItem.classList.add('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();

            const targetItem = event.target.closest('.category-tool-item');
            if (!targetItem || targetItem === draggedElement) return;

            // Only allow reordering within same category
            if (targetItem.dataset.categoryId !== draggedCategoryId) return;

            const container = targetItem.parentElement;
            const items = Array.from(container.querySelectorAll('.category-tool-item'));
            const draggedIndex = items.indexOf(draggedElement);
            const targetIndex = items.indexOf(targetItem);

            // Reorder in DOM
            if (draggedIndex < targetIndex) {
                targetItem.parentNode.insertBefore(draggedElement, targetItem.nextSibling);
            } else {
                targetItem.parentNode.insertBefore(draggedElement, targetItem);
            }

            // Save new order
            saveToolOrder(draggedCategoryId);
        }

        function handleDragEnd(event) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }

            // Remove drag-over class from all items
            document.querySelectorAll('.category-tool-item.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });

            draggedElement = null;
            draggedToolId = null;
            draggedCategoryId = null;
        }

        // Save tool order after drag and drop
        async function saveToolOrder(categoryId) {
            const container = document.querySelector(`#category-tools-${categoryId} .category-tools-inner`);
            if (!container) return;

            const toolItems = container.querySelectorAll('.category-tool-item');
            const toolIds = Array.from(toolItems).map(item => item.dataset.toolId);

            try {
                const res = await fetch('/api/admin/tools/reorder', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ categoryId, toolIds })
                });

                if (res.ok) {
                    showCategoriesAlert('顺序已保存', 'success');
                    // Update local data
                    toolIds.forEach((toolId, index) => {
                        const tool = categoryData.tools.find(t => t.id === toolId);
                        if (tool) {
                            tool.order = index + 1;
                        }
                    });
                } else {
                    const data = await res.json();
                    showCategoriesAlert(data.error || '保存顺序失败', 'error');
                    // Reload to restore original order
                    loadCategoriesWithTools();
                }
            } catch (e) {
                showCategoriesAlert('网络错误，请重试', 'error');
                loadCategoriesWithTools();
            }
        }

        // ========== Apps/Products Management ==========

        // Switch between Apps and Products tabs
        function switchAppsTab(tab) {
            const appsTab = document.getElementById('tab-apps');
            const productsTab = document.getElementById('tab-products');
            const appsContent = document.getElementById('apps-tab-content');
            const productsContent = document.getElementById('products-tab-content');

            if (tab === 'apps') {
                appsTab.classList.add('active');
                appsTab.style.color = '#fff';
                appsTab.style.borderBottomColor = '#3b82f6';
                productsTab.classList.remove('active');
                productsTab.style.color = '#94a3b8';
                productsTab.style.borderBottomColor = 'transparent';
                appsContent.style.display = 'block';
                productsContent.style.display = 'none';
                loadApps();
            } else {
                productsTab.classList.add('active');
                productsTab.style.color = '#fff';
                productsTab.style.borderBottomColor = '#3b82f6';
                appsTab.classList.remove('active');
                appsTab.style.color = '#94a3b8';
                appsTab.style.borderBottomColor = 'transparent';
                productsContent.style.display = 'block';
                appsContent.style.display = 'none';
                loadProducts();
            }
        }

        // Show apps alert
        function showAppsAlert(msg, type) {
            const alert = document.getElementById('apps-alert');
            alert.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => { alert.innerHTML = ''; }, 3000);
        }

        // Load Apps list
        async function loadApps() {
            try {
                const res = await fetch('/api/admin/apps', { credentials: 'include' });
                if (res.status === 401) {
                    showAppsAlert('请先登录管理员账号', 'error');
                    document.getElementById('apps-list').innerHTML =
                        '<div style="text-align:center;color:#ef4444;padding:20px;">未授权，请重新登录</div>';
                    return;
                }
                if (res.ok) {
                    const data = await res.json();
                    const apps = data.apps || [];

                    document.getElementById('apps-count').textContent = apps.length;

                    if (apps.length === 0) {
                        document.getElementById('apps-list').innerHTML =
                            '<div style="text-align:center;color:#64748b;padding:20px;">暂无App，请添加第一个App</div>';
                        return;
                    }

                    document.getElementById('apps-list').innerHTML = apps.map(app => `
                        <div class="tool-card" data-id="${app.id}">
                            <div class="tool-card-header">
                                <div>
                                    <h4>${escapeHtml(app.title)}</h4>
                                    ${(app.tags || []).length > 0 ? `<div style="margin-top:4px;">${app.tags.map(t => `<span style="display:inline-block;padding:2px 6px;background:#334155;border-radius:4px;font-size:11px;margin-right:4px;">${escapeHtml(t)}</span>`).join('')}</div>` : ''}
                                </div>
                                <div class="tool-card-actions">
                                    <button class="btn btn-secondary btn-sm" onclick="editApp('${app.id}')">编辑</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteApp('${app.id}')">删除</button>
                                </div>
                            </div>
                            ${app.description ? `<p class="tool-card-desc">${escapeHtml(app.description)}</p>` : ''}
                            <a href="${escapeHtml(app.port)}" class="tool-card-link" target="_blank">${escapeHtml(app.port)}</a>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load apps:', e);
                document.getElementById('apps-list').innerHTML =
                    '<div style="text-align:center;color:#ef4444;padding:20px;">加载失败，请刷新重试</div>';
            }
        }

        // Save App (create or update)
        async function saveApp() {
            const editId = document.getElementById('edit-app-id').value;
            const title = document.getElementById('app-title').value.trim();
            const description = document.getElementById('app-desc').value.trim();
            const port = document.getElementById('app-port').value.trim();
            const tagsInput = document.getElementById('app-tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            if (!title) {
                showAppsAlert('请输入App标题', 'error');
                return;
            }
            if (!port) {
                showAppsAlert('请输入端口链接', 'error');
                return;
            }

            const appData = { title, description, port, tags };

            try {
                let res;
                if (editId) {
                    res = await fetch(`/api/admin/apps/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(appData)
                    });
                } else {
                    res = await fetch('/api/admin/apps', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(appData)
                    });
                }

                if (res.ok) {
                    showAppsAlert(editId ? 'App已更新' : 'App已添加', 'success');
                    cancelAppEdit();
                    loadApps();
                } else {
                    const data = await res.json();
                    showAppsAlert(data.error || '保存失败', 'error');
                }
            } catch (e) {
                showAppsAlert('网络错误，请重试', 'error');
            }
        }

        // Edit App
        async function editApp(id) {
            try {
                const res = await fetch('/api/admin/apps', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    const app = (data.apps || []).find(a => a.id === id);
                    if (app) {
                        document.getElementById('edit-app-id').value = app.id;
                        document.getElementById('app-title').value = app.title || '';
                        document.getElementById('app-desc').value = app.description || '';
                        document.getElementById('app-port').value = app.port || '';
                        document.getElementById('app-tags').value = (app.tags || []).join(', ');
                        document.getElementById('app-form-title').textContent = '编辑App';
                        document.getElementById('cancel-app-edit-btn').style.display = 'inline-block';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }
            } catch (e) {
                showAppsAlert('加载App信息失败', 'error');
            }
        }

        // Cancel App edit
        function cancelAppEdit() {
            document.getElementById('edit-app-id').value = '';
            document.getElementById('app-title').value = '';
            document.getElementById('app-desc').value = '';
            document.getElementById('app-port').value = '';
            document.getElementById('app-tags').value = '';
            document.getElementById('app-form-title').textContent = '添加新App';
            document.getElementById('cancel-app-edit-btn').style.display = 'none';
        }

        // Delete App
        async function deleteApp(id) {
            if (!confirm('确定删除此App？')) return;

            try {
                const res = await fetch(`/api/admin/apps/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    showAppsAlert('App已删除', 'success');
                    loadApps();
                } else {
                    const data = await res.json();
                    showAppsAlert(data.error || '删除失败', 'error');
                }
            } catch (e) {
                showAppsAlert('网络错误，请重试', 'error');
            }
        }

        // Load Products list
        async function loadProducts() {
            try {
                const res = await fetch('/api/admin/products', { credentials: 'include' });
                if (res.status === 401) {
                    showAppsAlert('请先登录管理员账号', 'error');
                    document.getElementById('products-list').innerHTML =
                        '<div style="text-align:center;color:#ef4444;padding:20px;">未授权，请重新登录</div>';
                    return;
                }
                if (res.ok) {
                    const data = await res.json();
                    const products = data.products || [];

                    document.getElementById('products-count').textContent = products.length;

                    if (products.length === 0) {
                        document.getElementById('products-list').innerHTML =
                            '<div style="text-align:center;color:#64748b;padding:20px;">暂无产品，请添加第一个产品</div>';
                        return;
                    }

                    document.getElementById('products-list').innerHTML = products.map(product => `
                        <div class="tool-card" data-id="${product.id}">
                            <div class="tool-card-header">
                                <div>
                                    <h4>${escapeHtml(product.title)}</h4>
                                </div>
                                <div class="tool-card-actions">
                                    ${product.fileName ? `<a href="/api/products/${product.id}/download" class="btn btn-primary btn-sm" download>下载</a>` : ''}
                                    <button class="btn btn-secondary btn-sm" onclick="editProduct('${product.id}')">编辑</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}')">删除</button>
                                </div>
                            </div>
                            ${product.description ? `<p class="tool-card-desc">${escapeHtml(product.description)}</p>` : ''}
                            ${product.fileName ? `<p style="font-size:12px;color:#3b82f6;">📎 ${escapeHtml(product.fileName)}</p>` : '<p style="font-size:12px;color:#64748b;">无附件</p>'}
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load products:', e);
                document.getElementById('products-list').innerHTML =
                    '<div style="text-align:center;color:#ef4444;padding:20px;">加载失败，请刷新重试</div>';
            }
        }

        // Save Product (create or update)
        async function saveProduct() {
            const editId = document.getElementById('edit-product-id').value;
            const title = document.getElementById('product-title').value.trim();
            const description = document.getElementById('product-desc').value.trim();
            const fileInput = document.getElementById('product-file');

            if (!title) {
                showAppsAlert('请输入产品名称', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', description);
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
            }

            try {
                let res;
                if (editId) {
                    res = await fetch(`/api/admin/products/${editId}`, {
                        method: 'PUT',
                        credentials: 'include',
                        body: formData
                    });
                } else {
                    res = await fetch('/api/admin/products', {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                }

                if (res.ok) {
                    showAppsAlert(editId ? '产品已更新' : '产品已添加', 'success');
                    cancelProductEdit();
                    loadProducts();
                } else {
                    const data = await res.json();
                    showAppsAlert(data.error || '保存失败', 'error');
                }
            } catch (e) {
                showAppsAlert('网络错误，请重试', 'error');
            }
        }

        // Edit Product
        async function editProduct(id) {
            try {
                const res = await fetch('/api/admin/products', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    const product = (data.products || []).find(p => p.id === id);
                    if (product) {
                        document.getElementById('edit-product-id').value = product.id;
                        document.getElementById('product-title').value = product.title || '';
                        document.getElementById('product-desc').value = product.description || '';
                        document.getElementById('product-form-title').textContent = '编辑产品';
                        document.getElementById('cancel-product-edit-btn').style.display = 'inline-block';

                        // Show current file info if exists
                        if (product.fileName) {
                            document.getElementById('current-file-info').style.display = 'block';
                            document.getElementById('current-file-name').textContent = product.fileName;
                        } else {
                            document.getElementById('current-file-info').style.display = 'none';
                        }

                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }
            } catch (e) {
                showAppsAlert('加载产品信息失败', 'error');
            }
        }

        // Cancel Product edit
        function cancelProductEdit() {
            document.getElementById('edit-product-id').value = '';
            document.getElementById('product-title').value = '';
            document.getElementById('product-desc').value = '';
            document.getElementById('product-file').value = '';
            document.getElementById('product-form-title').textContent = '添加新产品';
            document.getElementById('cancel-product-edit-btn').style.display = 'none';
            document.getElementById('current-file-info').style.display = 'none';
        }

        // Remove product file (for editing)
        function removeProductFile() {
            document.getElementById('current-file-info').style.display = 'none';
            document.getElementById('current-file-name').textContent = '';
        }

        // Delete Product
        async function deleteProduct(id) {
            if (!confirm('确定删除此产品？')) return;

            try {
                const res = await fetch(`/api/admin/products/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    showAppsAlert('产品已删除', 'success');
                    loadProducts();
                } else {
                    const data = await res.json();
                    showAppsAlert(data.error || '删除失败', 'error');
                }
            } catch (e) {
                showAppsAlert('网络错误，请重试', 'error');
            }
        }

        // ========== Tool Search ==========
        let allToolsCache = [];

        async function searchTools(query) {
            const resultsDiv = document.getElementById('tool-search-results');

            if (!query.trim()) {
                resultsDiv.style.display = 'none';
                return;
            }

            // Load tools if not cached
            if (allToolsCache.length === 0) {
                try {
                    const res = await fetch('/api/admin/tools', { credentials: 'include' });
                    if (res.ok) {
                        const data = await res.json();
                        allToolsCache = data.tools || [];
                    }
                } catch (e) {
                    console.error('Failed to load tools for search:', e);
                    return;
                }
            }

            // Filter tools
            const searchLower = query.toLowerCase();
            const results = allToolsCache.filter(tool =>
                tool.title.toLowerCase().includes(searchLower) ||
                (tool.description && tool.description.toLowerCase().includes(searchLower))
            ).slice(0, 10);

            if (results.length === 0) {
                resultsDiv.innerHTML = '<div style="color:#64748b;padding:12px;">未找到匹配的工具</div>';
            } else {
                resultsDiv.innerHTML = results.map(tool => `
                    <div class="tool-card" style="margin-bottom:8px;padding:12px;cursor:pointer;" onclick="scrollToToolAndEdit('${tool.id}')">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <h4 style="font-size:14px;color:#fff;margin:0;">${escapeHtml(tool.title)}</h4>
                                <p style="font-size:12px;color:#64748b;margin:4px 0 0 0;">${escapeHtml(tool.category || '未分类')}</p>
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();editToolById('${tool.id}')">编辑</button>
                                <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteToolById('${tool.id}')">删除</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            resultsDiv.style.display = 'block';
        }

        function scrollToToolAndEdit(toolId) {
            editToolById(toolId);
        }

        async function editToolById(toolId) {
            const tool = allToolsCache.find(t => t.id === toolId);
            if (tool) {
                document.getElementById('edit-tool-id').value = tool.id;
                document.getElementById('tool-title').value = tool.title || '';
                document.getElementById('tool-desc').value = tool.description || '';
                document.getElementById('tool-url').value = tool.url || '';
                document.getElementById('tool-category').value = tool.category || '';
                document.getElementById('tool-form-title').textContent = '编辑工具';
                document.getElementById('cancel-edit-btn').style.display = 'inline-block';

                // Clear search
                document.getElementById('tool-search-input').value = '';
                document.getElementById('tool-search-results').style.display = 'none';

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        async function deleteToolById(toolId) {
            if (!confirm('确定删除此工具？')) return;

            try {
                const res = await fetch(`/api/admin/tools/${toolId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    showToolsAlert('工具已删除', 'success');
                    // Update cache
                    allToolsCache = allToolsCache.filter(t => t.id !== toolId);
                    // Refresh search results
                    const query = document.getElementById('tool-search-input').value;
                    if (query) searchTools(query);
                    // Refresh tools list
                    loadTools();
                } else {
                    const data = await res.json();
                    showToolsAlert(data.error || '删除失败', 'error');
                }
            } catch (e) {
                showToolsAlert('网络错误，请重试', 'error');
            }
        }

        // ========== Tutorials Management ==========

        function showTutorialsAlert(msg, type) {
            const alert = document.getElementById('tutorials-alert');
            alert.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => { alert.innerHTML = ''; }, 3000);
        }

        let allTutorialsCache = [];

        async function loadTutorials() {
            try {
                const res = await fetch('/api/admin/tutorials', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    allTutorialsCache = data.tutorials || [];
                    filterTutorials();
                }
            } catch (e) {
                console.error('Failed to load tutorials:', e);
                document.getElementById('tutorials-list').innerHTML =
                    '<div style="text-align:center;color:#ef4444;padding:20px;">加载失败</div>';
            }
        }

        function filterTutorials() {
            const filterValue = document.getElementById('tutorial-filter').value;
            const tutorials = filterValue ?
                allTutorialsCache.filter(t => t.category === filterValue) :
                allTutorialsCache;

            document.getElementById('tutorials-count').textContent = tutorials.length;

            if (tutorials.length === 0) {
                document.getElementById('tutorials-list').innerHTML =
                    '<div style="text-align:center;color:#64748b;padding:20px;">暂无教程/案例</div>';
                return;
            }

            document.getElementById('tutorials-list').innerHTML = tutorials.map(item => `
                <div class="tool-card" data-id="${item.id}">
                    <div class="tool-card-header">
                        <div>
                            <h4>${escapeHtml(item.title)}</h4>
                            ${item.category ? `<span style="display:inline-block;padding:2px 8px;background:#3b82f6;border-radius:4px;font-size:11px;margin-top:4px;margin-right:4px;">${escapeHtml(item.category)}</span>` : ''}
                            ${(item.tags || []).length > 0 ? item.tags.map(t => `<span style="display:inline-block;padding:2px 6px;background:#334155;border-radius:4px;font-size:11px;margin-top:4px;margin-right:4px;">${escapeHtml(t)}</span>`).join('') : ''}
                        </div>
                        <div class="tool-card-actions">
                            <button class="btn btn-secondary btn-sm" onclick="editTutorial('${item.id}')">编辑</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTutorial('${item.id}')">删除</button>
                        </div>
                    </div>
                    ${item.description ? `<p class="tool-card-desc">${escapeHtml(item.description)}</p>` : ''}
                    <a href="${escapeHtml(item.url)}" class="tool-card-link" target="_blank">${escapeHtml(item.url)}</a>
                </div>
            `).join('');
        }

        async function saveTutorial() {
            const editId = document.getElementById('edit-tutorial-id').value;
            const title = document.getElementById('tutorial-title').value.trim();
            const description = document.getElementById('tutorial-desc').value.trim();
            const url = document.getElementById('tutorial-url').value.trim();
            const category = document.getElementById('tutorial-category').value;
            const tagsInput = document.getElementById('tutorial-tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            if (!title || !url) {
                showTutorialsAlert('请填写标题和链接', 'error');
                return;
            }

            try {
                let res;
                if (editId) {
                    res = await fetch(`/api/admin/tutorials/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ title, description, url, category, tags })
                    });
                } else {
                    res = await fetch('/api/admin/tutorials', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ title, description, url, tags })
                    });
                }

                if (res.ok) {
                    showTutorialsAlert(editId ? '已更新' : '已添加', 'success');
                    cancelTutorialEdit();
                    loadTutorials();
                } else {
                    const data = await res.json();
                    showTutorialsAlert(data.error || '保存失败', 'error');
                }
            } catch (e) {
                showTutorialsAlert('网络错误', 'error');
            }
        }

        async function editTutorial(id) {
            const item = allTutorialsCache.find(t => t.id === id);
            if (item) {
                document.getElementById('edit-tutorial-id').value = item.id;
                document.getElementById('tutorial-title').value = item.title || '';
                document.getElementById('tutorial-desc').value = item.description || '';
                document.getElementById('tutorial-url').value = item.url || '';
                document.getElementById('tutorial-category').value = item.category || '';
                document.getElementById('tutorial-tags').value = (item.tags || []).join(', ');
                document.getElementById('tutorial-form-title').textContent = '编辑教程/案例';
                document.getElementById('cancel-tutorial-edit-btn').style.display = 'inline-block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function cancelTutorialEdit() {
            document.getElementById('edit-tutorial-id').value = '';
            document.getElementById('tutorial-title').value = '';
            document.getElementById('tutorial-desc').value = '';
            document.getElementById('tutorial-url').value = '';
            document.getElementById('tutorial-category').value = '';
            document.getElementById('tutorial-tags').value = '';
            document.getElementById('tutorial-form-title').textContent = '添加新教程/案例';
            document.getElementById('cancel-tutorial-edit-btn').style.display = 'none';
        }

        async function deleteTutorial(id) {
            if (!confirm('确定删除？')) return;

            try {
                const res = await fetch(`/api/admin/tutorials/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    showTutorialsAlert('已删除', 'success');
                    loadTutorials();
                } else {
                    showTutorialsAlert('删除失败', 'error');
                }
            } catch (e) {
                showTutorialsAlert('网络错误', 'error');
            }
        }

        // ========== APIs Management ==========

        function showApisAlert(msg, type) {
            const alert = document.getElementById('apis-alert');
            alert.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => { alert.innerHTML = ''; }, 3000);
        }

        let allApisCache = [];

        async function loadApis() {
            try {
                const res = await fetch('/api/admin/apis', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    allApisCache = data.apis || [];
                    filterApis();
                }
            } catch (e) {
                console.error('Failed to load apis:', e);
                document.getElementById('apis-list').innerHTML =
                    '<div style="text-align:center;color:#ef4444;padding:20px;">加载失败</div>';
            }
        }

        function filterApis() {
            const filterValue = document.getElementById('api-filter').value;
            const apis = filterValue ?
                allApisCache.filter(a => a.category === filterValue) :
                allApisCache;

            document.getElementById('apis-count').textContent = apis.length;

            if (apis.length === 0) {
                document.getElementById('apis-list').innerHTML =
                    '<div style="text-align:center;color:#64748b;padding:20px;">暂无API</div>';
                return;
            }

            document.getElementById('apis-list').innerHTML = apis.map(item => `
                <div class="tool-card" data-id="${item.id}">
                    <div class="tool-card-header">
                        <div>
                            <h4>${escapeHtml(item.title)}</h4>
                            ${item.category ? `<span style="display:inline-block;padding:2px 8px;background:#10b981;border-radius:4px;font-size:11px;margin-top:4px;margin-right:4px;">${escapeHtml(item.category)}</span>` : ''}
                            ${item.subcategory ? `<span style="display:inline-block;padding:2px 8px;background:#6366f1;border-radius:4px;font-size:11px;margin-top:4px;margin-right:4px;">${escapeHtml(item.subcategory)}</span>` : ''}
                            ${item.pricing ? `<span style="display:inline-block;padding:2px 8px;background:${item.pricing === 'free' ? '#22c55e' : item.pricing === 'freemium' ? '#f59e0b' : '#ef4444'};border-radius:4px;font-size:11px;margin-top:4px;margin-right:4px;">${item.pricing === 'free' ? '免费' : item.pricing === 'freemium' ? '免费增值' : '付费'}</span>` : ''}
                            ${(item.tags || []).length > 0 ? item.tags.map(t => `<span style="display:inline-block;padding:2px 6px;background:#334155;border-radius:4px;font-size:11px;margin-top:4px;margin-right:4px;">${escapeHtml(t)}</span>`).join('') : ''}
                        </div>
                        <div class="tool-card-actions">
                            <button class="btn btn-secondary btn-sm" onclick="editApi('${item.id}')">编辑</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteApi('${item.id}')">删除</button>
                        </div>
                    </div>
                    ${item.description ? `<p class="tool-card-desc">${escapeHtml(item.description)}</p>` : ''}
                    <a href="${escapeHtml(item.url)}" class="tool-card-link" target="_blank">${escapeHtml(item.url)}</a>
                </div>
            `).join('');
        }

        async function saveApi() {
            const editId = document.getElementById('edit-api-id').value;
            const title = document.getElementById('api-title').value.trim();
            const description = document.getElementById('api-desc').value.trim();
            const url = document.getElementById('api-url').value.trim();
            const category = document.getElementById('api-category').value;
            const subcategory = document.getElementById('api-subcategory').value.trim();
            const pricing = document.getElementById('api-pricing').value;
            const tagsInput = document.getElementById('api-tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            if (!title || !url) {
                showApisAlert('请填写标题和链接', 'error');
                return;
            }

            try {
                let res;
                if (editId) {
                    res = await fetch(`/api/admin/apis/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ title, description, url, category, subcategory, pricing, tags })
                    });
                } else {
                    res = await fetch('/api/admin/apis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ title, description, url, category, subcategory, pricing, tags })
                    });
                }

                if (res.ok) {
                    showApisAlert(editId ? '已更新' : '已添加', 'success');
                    cancelApiEdit();
                    loadApis();
                } else {
                    const data = await res.json();
                    showApisAlert(data.error || '保存失败', 'error');
                }
            } catch (e) {
                showApisAlert('网络错误', 'error');
            }
        }

        async function editApi(id) {
            const item = allApisCache.find(a => a.id === id);
            if (item) {
                document.getElementById('edit-api-id').value = item.id;
                document.getElementById('api-title').value = item.title || '';
                document.getElementById('api-desc').value = item.description || '';
                document.getElementById('api-url').value = item.url || '';
                document.getElementById('api-category').value = item.category || '';
                document.getElementById('api-subcategory').value = item.subcategory || '';
                document.getElementById('api-pricing').value = item.pricing || 'free';
                document.getElementById('api-tags').value = (item.tags || []).join(', ');
                document.getElementById('api-form-title').textContent = '编辑API';
                document.getElementById('cancel-api-edit-btn').style.display = 'inline-block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function cancelApiEdit() {
            document.getElementById('edit-api-id').value = '';
            document.getElementById('api-title').value = '';
            document.getElementById('api-desc').value = '';
            document.getElementById('api-url').value = '';
            document.getElementById('api-category').value = '';
            document.getElementById('api-subcategory').value = '';
            document.getElementById('api-pricing').value = 'free';
            document.getElementById('api-tags').value = '';
            document.getElementById('api-form-title').textContent = '添加新API';
            document.getElementById('cancel-api-edit-btn').style.display = 'none';
        }

        async function deleteApi(id) {
            if (!confirm('确定删除？')) return;

            try {
                const res = await fetch(`/api/admin/apis/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    showApisAlert('已删除', 'success');
                    loadApis();
                } else {
                    showApisAlert('删除失败', 'error');
                }
            } catch (e) {
                showApisAlert('网络错误', 'error');
            }
        }

        // ========== Trends Management ==========

        function showTrendsAlert(msg, type) {
            const alert = document.getElementById('trends-alert');
            alert.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => { alert.innerHTML = ''; }, 3000);
        }

        async function loadTrends() {
            try {
                const res = await fetch('/api/admin/trends', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    const trends = data.trends || [];

                    document.getElementById('trends-count').textContent = trends.length;

                    if (trends.length === 0) {
                        document.getElementById('trends-list').innerHTML =
                            '<div style="text-align:center;color:#64748b;padding:20px;">暂无热点</div>';
                        return;
                    }

                    document.getElementById('trends-list').innerHTML = trends.map(item => `
                        <div class="tool-card" data-id="${item.id}">
                            <div class="tool-card-header">
                                <div>
                                    <h4>${escapeHtml(item.title)}</h4>
                                    ${(item.tags || []).length > 0 ? `<div style="margin-top:4px;">${item.tags.map(t => `<span style="display:inline-block;padding:2px 6px;background:#334155;border-radius:4px;font-size:11px;margin-right:4px;">${escapeHtml(t)}</span>`).join('')}</div>` : ''}
                                </div>
                                <div class="tool-card-actions">
                                    <button class="btn btn-secondary btn-sm" onclick="editTrend('${item.id}')">编辑</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteTrend('${item.id}')">删除</button>
                                </div>
                            </div>
                            ${item.description ? `<p class="tool-card-desc">${escapeHtml(item.description)}</p>` : ''}
                            <a href="${escapeHtml(item.url)}" class="tool-card-link" target="_blank">${escapeHtml(item.url)}</a>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load trends:', e);
                document.getElementById('trends-list').innerHTML =
                    '<div style="text-align:center;color:#ef4444;padding:20px;">加载失败</div>';
            }
        }

        async function saveTrend() {
            const editId = document.getElementById('edit-trend-id').value;
            const title = document.getElementById('trend-title').value.trim();
            const description = document.getElementById('trend-desc').value.trim();
            const url = document.getElementById('trend-url').value.trim();
            const tagsInput = document.getElementById('trend-tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            if (!title || !url) {
                showTrendsAlert('请填写标题和链接', 'error');
                return;
            }

            try {
                let res;
                if (editId) {
                    res = await fetch(`/api/admin/trends/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ title, description, url, tags })
                    });
                } else {
                    res = await fetch('/api/admin/trends', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ title, description, url, tags })
                    });
                }

                if (res.ok) {
                    showTrendsAlert(editId ? '已更新' : '已添加', 'success');
                    cancelTrendEdit();
                    loadTrends();
                } else {
                    const data = await res.json();
                    showTrendsAlert(data.error || '保存失败', 'error');
                }
            } catch (e) {
                showTrendsAlert('网络错误', 'error');
            }
        }

        async function editTrend(id) {
            try {
                const res = await fetch('/api/admin/trends', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    const item = (data.trends || []).find(t => t.id === id);
                    if (item) {
                        document.getElementById('edit-trend-id').value = item.id;
                        document.getElementById('trend-title').value = item.title || '';
                        document.getElementById('trend-desc').value = item.description || '';
                        document.getElementById('trend-url').value = item.url || '';
                        document.getElementById('trend-tags').value = (item.tags || []).join(', ');
                        document.getElementById('trend-form-title').textContent = '编辑热点';
                        document.getElementById('cancel-trend-edit-btn').style.display = 'inline-block';
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }
            } catch (e) {
                showTrendsAlert('加载失败', 'error');
            }
        }

        function cancelTrendEdit() {
            document.getElementById('edit-trend-id').value = '';
            document.getElementById('trend-title').value = '';
            document.getElementById('trend-desc').value = '';
            document.getElementById('trend-url').value = '';
            document.getElementById('trend-tags').value = '';
            document.getElementById('trend-form-title').textContent = '添加新热点';
            document.getElementById('cancel-trend-edit-btn').style.display = 'none';
        }

        async function deleteTrend(id) {
            if (!confirm('确定删除？')) return;

            try {
                const res = await fetch(`/api/admin/trends/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    showTrendsAlert('已删除', 'success');
                    loadTrends();
                } else {
                    showTrendsAlert('删除失败', 'error');
                }
            } catch (e) {
                showTrendsAlert('网络错误', 'error');
            }
        }

        // === Workshop (AI 开发工坊) 管理函数 ===
        let workshopData = { items: [], categories: [] };

        async function loadWorkshopData() {
            try {
                const res = await fetch('/api/admin/workshop', { credentials: 'include' });
                if (res.ok) {
                    workshopData = await res.json();
                    renderWorkshopList();
                }
            } catch (e) {
                console.error('Failed to load workshop data:', e);
            }
        }

        function renderWorkshopList() {
            const container = document.getElementById('workshop-list');
            const filterCategory = document.getElementById('workshop-filter')?.value || '';

            let items = workshopData.items || [];
            if (filterCategory) {
                items = items.filter(i => i.category === filterCategory);
            }

            // 按分类和order排序
            items.sort((a, b) => {
                if (a.category !== b.category) return (a.category || '').localeCompare(b.category || '');
                return (a.order || 0) - (b.order || 0);
            });

            document.getElementById('workshop-count').textContent = items.length;

            if (items.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#64748b;padding:20px;">暂无数据</div>';
                return;
            }

            const getCategoryName = (catId) => {
                const cat = (workshopData.categories || []).find(c => c.id === catId);
                return cat ? cat.name : catId;
            };

            container.innerHTML = items.map(item => `
                <div class="tool-card">
                    <div class="tool-card-header">
                        <div>
                            <h4>${escapeHtml(item.title)}</h4>
                            <span class="tool-card-category">${escapeHtml(getCategoryName(item.category))}</span>
                        </div>
                        <div class="tool-card-actions">
                            <button class="btn btn-secondary btn-sm" onclick="editWorkshopItem('${item.id}')">编辑</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteWorkshopItem('${item.id}')">删除</button>
                        </div>
                    </div>
                    <p class="tool-card-desc">${escapeHtml(item.description || '')}</p>
                    ${item.fileName ? `<div style="font-size:12px;color:#64748b;margin-top:4px;">文件: ${escapeHtml(item.fileName)}</div>` : ''}
                    ${item.url ? `<a href="${escapeHtml(item.url)}" target="_blank" class="tool-card-link">${escapeHtml(item.url)}</a>` : ''}
                    ${item.tags && item.tags.length > 0 ? `<div style="margin-top:8px;">${item.tags.map(t => `<span style="display:inline-block;background:#334155;color:#e2e8f0;padding:2px 8px;border-radius:10px;font-size:11px;margin-right:4px;">${escapeHtml(t)}</span>`).join('')}</div>` : ''}
                </div>
            `).join('');
        }

        function filterWorkshopItems() {
            renderWorkshopList();
        }

        function showWorkshopAlert(message, type) {
            const container = document.getElementById('workshop-alert');
            container.innerHTML = `<div class="alert alert-${type}">${escapeHtml(message)}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 3000);
        }

        async function saveWorkshopItem() {
            const editId = document.getElementById('edit-workshop-id').value;
            const title = document.getElementById('workshop-title').value.trim();
            const description = document.getElementById('workshop-desc').value.trim();
            const category = document.getElementById('workshop-category').value;
            const fileName = document.getElementById('workshop-filename').value.trim();
            const url = document.getElementById('workshop-url').value.trim();
            const tagsStr = document.getElementById('workshop-tags').value.trim();
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(Boolean) : [];

            if (!title) {
                showWorkshopAlert('标题不能为空', 'error');
                return;
            }
            if (!category) {
                showWorkshopAlert('请选择分类', 'error');
                return;
            }

            try {
                let res;
                const body = { title, description, category, fileName, url, tags };

                if (editId) {
                    res = await fetch(`/api/admin/workshop/items/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(body)
                    });
                } else {
                    res = await fetch('/api/admin/workshop/items', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(body)
                    });
                }

                if (res.ok) {
                    showWorkshopAlert(editId ? '已更新' : '已添加', 'success');
                    cancelWorkshopEdit();
                    loadWorkshopData();
                } else {
                    const data = await res.json();
                    showWorkshopAlert(data.error || '保存失败', 'error');
                }
            } catch (e) {
                showWorkshopAlert('网络错误', 'error');
            }
        }

        async function editWorkshopItem(id) {
            const item = workshopData.items.find(i => i.id === id);
            if (!item) return;

            document.getElementById('edit-workshop-id').value = item.id;
            document.getElementById('workshop-title').value = item.title || '';
            document.getElementById('workshop-desc').value = item.description || '';
            document.getElementById('workshop-category').value = item.category || '';
            document.getElementById('workshop-filename').value = item.fileName || '';
            document.getElementById('workshop-url').value = item.url || '';
            document.getElementById('workshop-tags').value = (item.tags || []).join(', ');
            document.getElementById('workshop-form-title').textContent = '编辑工坊卡片';
            document.getElementById('cancel-workshop-edit-btn').style.display = 'inline-block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelWorkshopEdit() {
            document.getElementById('edit-workshop-id').value = '';
            document.getElementById('workshop-title').value = '';
            document.getElementById('workshop-desc').value = '';
            document.getElementById('workshop-category').value = '';
            document.getElementById('workshop-filename').value = '';
            document.getElementById('workshop-url').value = '';
            document.getElementById('workshop-tags').value = '';
            document.getElementById('workshop-form-title').textContent = '添加新工坊卡片';
            document.getElementById('cancel-workshop-edit-btn').style.display = 'none';
        }

        async function deleteWorkshopItem(id) {
            if (!confirm('确定删除此工坊卡片？')) return;

            try {
                const res = await fetch(`/api/admin/workshop/items/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    showWorkshopAlert('已删除', 'success');
                    loadWorkshopData();
                } else {
                    showWorkshopAlert('删除失败', 'error');
                }
            } catch (e) {
                showWorkshopAlert('网络错误', 'error');
            }
        }

        // ============ 黑名单管理功能 ============

        // 切换用户管理标签页
        function switchUsersTab(tabName) {
            // 更新标签按钮样式
            document.querySelectorAll('#section-users .tab-btn').forEach(btn => {
                btn.style.color = '#94a3b8';
                btn.style.borderBottom = '2px solid transparent';
            });
            const activeBtn = document.getElementById(`tab-${tabName}`);
            if (activeBtn) {
                activeBtn.style.color = '#fff';
                activeBtn.style.borderBottom = '2px solid #3b82f6';
            }

            // 切换内容区域显示
            document.getElementById('users-list-tab-content').style.display = tabName === 'users-list' ? 'block' : 'none';
            document.getElementById('blacklist-tab-content').style.display = tabName === 'blacklist' ? 'block' : 'none';

            // 如果切换到黑名单，加载数据
            if (tabName === 'blacklist') {
                loadBlacklist();
            }
        }

        // 加载注销用户列表（黑名单）
        async function loadBlacklist() {
            try {
                const res = await fetch('/api/admin/blocked-users', { credentials: 'include' });
                if (!res.ok) throw new Error('Failed to load blacklist');

                const data = await res.json();
                const blockedUsers = data.blockedUsers || [];

                document.getElementById('blacklist-count').textContent = blockedUsers.length;

                const tableBody = document.getElementById('blacklist-table');
                const emptyDiv = document.getElementById('blacklist-empty');

                if (blockedUsers.length === 0) {
                    tableBody.innerHTML = '';
                    emptyDiv.style.display = 'block';
                    return;
                }

                emptyDiv.style.display = 'none';
                tableBody.innerHTML = blockedUsers.map((item, index) => `
                    <tr>
                        <td style="font-family:monospace;font-size:13px;">
                            ${item.nickname ? escapeHtml(item.nickname) : '-'}
                        </td>
                        <td style="font-family:monospace;font-size:12px;color:#94a3b8;">
                            ${item.email ? escapeHtml(item.email) : '-'}
                        </td>
                        <td style="font-family:monospace;font-size:11px;color:#64748b;">
                            ${item.uid ? escapeHtml(item.uid.substring(0, 12) + '...') : '-'}
                        </td>
                        <td style="font-size:12px;color:#64748b;">
                            ${item.bannedAt ? new Date(item.bannedAt).toLocaleString('zh-CN') : '-'}
                        </td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="restoreBlockedUser(${index})">
                                恢复
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('加载黑名单失败:', e);
                showUsersAlert('加载黑名单失败', 'error');
            }
        }

        // 从黑名单恢复用户（按索引）
        async function restoreBlockedUser(index) {
            if (!confirm('确定要从黑名单中移除此用户？移除后该用户可以重新注册。')) return;

            try {
                const res = await fetch(`/api/admin/blocked-users/${index}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    showUsersAlert('用户已从黑名单移除', 'success');
                    loadBlacklist();
                } else {
                    const data = await res.json();
                    showUsersAlert(data.error || '操作失败', 'error');
                }
            } catch (e) {
                console.error('恢复用户失败:', e);
                showUsersAlert('网络错误', 'error');
            }
        }

        // 用户管理提示
        function showUsersAlert(message, type) {
            const container = document.getElementById('users-alert');
            container.innerHTML = `<div class="alert alert-${type}">${escapeHtml(message)}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 3000);
        }
    </script>

    <!-- WebSocket Client for realtime kickout -->
    <script src="/js/websocket-client.js"></script>
</body>

</html>